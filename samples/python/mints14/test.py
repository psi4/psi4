#! Check for correctness of ESP values. The ESP values are calculated using one or four threads
#! The one thread values are checked against the four thread values. The one thread values are 
#! also checked against the reference values (1 thread values computed, when generating this test).
#! Caution: The reference values are not obtained using an actual physical reference, but rather
#! generated by Psi4 at one point in time.

import psi4
import psi4.core as p4c
import numpy as np

psi4.set_output_file("output.dat", False)

#H2O with minimal basis
h2o = psi4.geometry("""
O
H 1 0.96
H 1 0.96 2 104.5
""")

psi4.set_options({"d_convergence": 1e-10})

ene, wfn = psi4.energy('scf/STO-3G', return_wfn = True)
myepc = p4c.ESPPropCalc(wfn)

# Number of points to evaluate the ESP on per dimension (reference values below were generated with 5)
numpoints_per_dim = 5
points = np.array([ [float(x),float(y),float(z) ] for x in range(0,numpoints_per_dim) for y in range(0,numpoints_per_dim) for z in range(0,numpoints_per_dim) ])
psi4_matrix = p4c.Matrix.from_array(points)

# We calculate the ESPs with 1 thread
psi4.set_num_threads(1, quiet = True)
esps_1threads = np.array(myepc.compute_esp_over_grid_in_memory(psi4_matrix))
# We calculate the ESPs with 4 threads
psi4.set_num_threads(4, quiet = True)
esps_4threads = np.array(myepc.compute_esp_over_grid_in_memory(psi4_matrix))

# Reference values (Generated with psi4 master on 22.05.20 at 23:30 GMT
reference_esps = [ 4.62483342e+01,  1.54804313e-01,  4.13685593e-02,  1.99074762e-02,
                   1.15152678e-02,  2.05265305e-01,  2.83124071e-01,  3.85914212e-02,
                   1.81738886e-02,  1.07752887e-02,  1.77818258e-02,  3.68574105e-02,
                   2.25974306e-02,  1.35771735e-02,  8.87906889e-03,  5.10066439e-03,
                   1.12829223e-02,  1.12265555e-02,  8.83213803e-03,  6.63860586e-03,
                   2.19102261e-03,  4.93006854e-03,  5.89615996e-03,  5.53808484e-03,
                   4.71886332e-03, -5.17239329e-02,  3.13726711e-02,  2.75355388e-02,
                   1.65919492e-02,  1.03990059e-02, -3.35874097e-03,  4.15222788e-02,
                   2.56191309e-02,  1.52660739e-02,  9.76796362e-03,  6.32834557e-03,
                   2.04241605e-02,  1.70973880e-02,  1.17455466e-02,  8.13966708e-03,
                   3.38098123e-03,  8.74425646e-03,  9.48996966e-03,  7.93026739e-03,
                   6.17969093e-03,  1.74806282e-03,  4.26579485e-03,  5.29784951e-03,
                   5.12333890e-03,  4.45846711e-03, -1.57567665e-02,  5.30695677e-03,
                   1.23293022e-02,  1.06586884e-02,  7.93900611e-03, -7.73802957e-03,
                   7.26178250e-03,  1.17147293e-02,  9.98332008e-03,  7.52680394e-03,
                  -4.70874042e-04,  7.07678716e-03,  9.28214077e-03,  8.16156593e-03,
                   6.44348860e-03,  1.00781695e-03,  4.75096863e-03,  6.24946368e-03,
                   5.97476305e-03,  5.07885832e-03,  9.07850148e-04,  2.91174728e-03,
                   3.98405846e-03,  4.14293807e-03,  3.80513995e-03, -5.01856357e-03,
                   1.66005706e-03,  5.58988126e-03,  6.25608633e-03,  5.51718510e-03,
                  -3.54538877e-03,  2.13874136e-03,  5.42317564e-03,  5.96499476e-03,
                   5.28687977e-03, -1.26041313e-03,  2.57086533e-03,  4.76216983e-03,
                   5.15904477e-03,  4.66727597e-03, -6.98718627e-05,  2.29543121e-03,
                   3.72078488e-03,  4.09219098e-03,  3.84409282e-03,  2.86099206e-04,
                   1.74337099e-03,  2.70404545e-03,  3.07010847e-03,  3.01768294e-03,
                  -2.17493011e-03,  7.08011269e-04,  2.82422496e-03,  3.69989978e-03,
                   3.71459579e-03, -1.77325890e-03,  8.55302891e-04,  2.77277336e-03,
                   3.57535348e-03,  3.59320794e-03, -9.75050076e-04,  1.08091443e-03,
                   2.57027134e-03,  3.22234880e-03,  3.25925100e-03, -3.45599629e-04,
                   1.12615341e-03,  2.20372521e-03,  2.71976417e-03,  2.79365593e-03,
                  -1.83114358e-05,  1.00066735e-03,  1.76948007e-03,  2.18338059e-03,
                   2.29358229e-03]

# Comparison
psi4.compare_arrays(esps_1threads, esps_4threads, 3, "Reference value for ESP calculation, 1 thread vs. 4 threads.")
psi4.compare_arrays(esps_1threads, reference_esps, 3, "Reference value for ESP calculation, 1 thread vs. reference calculation.")

# We calculate the EF with 1 thread
psi4.set_num_threads(1, quiet = True)
efs_1threads = np.array(myepc.compute_field_over_grid_in_memory(psi4_matrix))

# # We calculate the EF with 4 threads
psi4.set_num_threads(4, quiet = True)
efs_4threads = np.array(myepc.compute_field_over_grid_in_memory(psi4_matrix))

# Reference fields (Generated with psi4 master (#e52a595))
reference_efs =   [[  0.         ,  -0.         , 477.186105805],
                   [  0.         ,  -0.         ,   0.185623829],
                   [  0.         ,   0.         ,   0.01913464 ],
                   [  0.         ,   0.         ,   0.006555885],
                   [  0.         ,  -0.         ,   0.002943373],
                   [  0.         ,   0.29569118 ,  -0.453422218],
                   [  0.         ,   0.267947364,   0.528430347],
                   [  0.         ,   0.005888893,   0.020645111],
                   [  0.         ,   0.001834162,   0.005765656],
                   [  0.         ,   0.000754931,   0.002625301],
                   [  0.         ,   0.015799109,  -0.021101894],
                   [  0.         ,   0.02978911 ,   0.004782979],
                   [  0.         ,   0.008195446,   0.006593135],
                   [  0.         ,   0.002728316,   0.003337031],
                   [  0.         ,   0.001172485,   0.001826488],
                   [  0.         ,   0.002636205,  -0.004586596],
                   [  0.         ,   0.005689039,  -0.001465581],
                   [  0.         ,   0.004063563,   0.001031381],
                   [  0.         ,   0.002158519,   0.001299288],
                   [  0.         ,   0.001137227,   0.001003484],
                   [  0.         ,   0.000856111,  -0.001768263],
                   [  0.         ,   0.001892712,  -0.001005844],
                   [  0.         ,   0.00187518 ,  -0.000074872],
                   [  0.         ,   0.00135719 ,   0.000371324],
                   [  0.         ,   0.000880439,   0.000458309],
                   [  0.036284224,   0.         ,  -0.06943841 ],
                   [  0.036596412,   0.         ,  -0.011241149],
                   [  0.010344544,  -0.         ,   0.006869804],
                   [  0.003012001,   0.         ,   0.004398401],
                   [  0.001084878,  -0.         ,   0.002372865],
                   [  0.025319689,  -0.02050811 ,  -0.039719879],
                   [  0.047081392,   0.004878041,   0.004001452],
                   [  0.009503372,   0.00297309 ,   0.007443232],
                   [  0.002653435,   0.001392036,   0.003900256],
                   [  0.000981748,   0.000644544,   0.002126759],
                   [  0.006669407,   0.001491566,  -0.011412118],
                   [  0.010595219,   0.009681526,  -0.001515523],
                   [  0.00457291 ,   0.004920776,   0.00312249 ],
                   [  0.0017136  ,   0.002129374,   0.002369361],
                   [  0.000727224,   0.001014137,   0.00150402 ],
                   [  0.001439166,   0.00122485 ,  -0.003709521],
                   [  0.002207444,   0.00362949 ,  -0.001584108],
                   [  0.001600364,   0.003025435,   0.000495861],
                   [  0.00087205 ,   0.00179271 ,   0.000971173],
                   [  0.000457319,   0.001007276,   0.000844726],
                   [  0.00041251 ,   0.000575638,  -0.001586122],
                   [  0.000630984,   0.001477036,  -0.000970076],
                   [  0.000581033,   0.001559826,  -0.000160394],
                   [  0.000411593,   0.001187754,   0.000275723],
                   [  0.000262841,   0.000799547,   0.000391856],
                   [ -0.011430136,   0.         ,  -0.010769598],
                   [  0.003908293,  -0.         ,  -0.00815556 ],
                   [  0.005418009,  -0.         ,  -0.00035353 ],
                   [  0.002883703,   0.         ,   0.001471543],
                   [  0.00138388 ,  -0.         ,   0.001301694],
                   [ -0.003096975,  -0.005774558,  -0.008371274],
                   [  0.005485676,  -0.00104179 ,  -0.005509453],
                   [  0.004992106,   0.000785719,   0.000028455],
                   [  0.002599784,   0.00070412 ,   0.001337359],
                   [  0.001269776,   0.000422544,   0.001180382],
                   [  0.001282964,  -0.001855529,  -0.004635603],
                   [  0.004001447,   0.001032123,  -0.002689427],
                   [  0.003285257,   0.001633152,   0.000050866],
                   [  0.001856674,   0.0011453  ,   0.000889609],
                   [  0.000982566,   0.000686779,   0.000866246],
                   [  0.000914579,  -0.000132347,  -0.002305401],
                   [  0.001761328,   0.001189774,  -0.001447128],
                   [  0.001620209,   0.001449676,  -0.000209218],
                   [  0.001087849,   0.001101292,   0.000389079],
                   [  0.000658532,   0.000722796,   0.000510315],
                   [  0.000416687,   0.000138541,  -0.001198937],
                   [  0.000716763,   0.000755838,  -0.00084754 ],
                   [  0.000736263,   0.00095273 ,  -0.000294514],
                   [  0.000580055,   0.000825403,   0.000084929],
                   [  0.00040377 ,   0.000611059,   0.000242819],
                   [ -0.002549309,  -0.         ,  -0.003428401],
                   [  0.000859388,  -0.         ,  -0.00309723 ],
                   [  0.002188015,   0.         ,  -0.001064189],
                   [  0.00178321 ,  -0.         ,   0.000167941],
                   [  0.001132414,  -0.         ,   0.000516977],
                   [ -0.001406746,  -0.001288977,  -0.00300725 ],
                   [  0.001186022,  -0.000374224,  -0.002591967],
                   [  0.00207707 ,   0.000202318,  -0.000889588],
                   [  0.001650356,   0.000303699,   0.000160146],
                   [  0.001056313,   0.000237319,   0.000474155],
                   [ -0.000051356,  -0.000954554,  -0.002131248],
                   [  0.001283663,  -0.000024714,  -0.001705953],
                   [  0.001637968,   0.000485361,  -0.000616196],
                   [  0.001293679,   0.000525212,   0.000103863],
                   [  0.000859327,   0.000401032,   0.000359126],
                   [  0.000293945,  -0.000351935,  -0.001348707],
                   [  0.000890411,   0.000264035,  -0.001056526],
                   [  0.001046568,   0.000575305,  -0.000447404],
                   [  0.000870186,   0.000574702,   0.000010036],
                   [  0.000620294,   0.000451548,   0.000217295],
                   [  0.000237082,  -0.000072405,  -0.000831792],
                   [  0.0005034  ,   0.000291236,  -0.00066653 ],
                   [  0.000593333,   0.000483715,  -0.000342938],
                   [  0.000531105,   0.000493655,  -0.000062523],
                   [  0.000411842,   0.000412458,   0.000098513],
                   [ -0.00084282 ,   0.         ,  -0.001494604],
                   [  0.000279296,  -0.         ,  -0.001419424],
                   [  0.000938038,  -0.         ,  -0.000781227],
                   [  0.000992258,  -0.         ,  -0.000187318],
                   [  0.000781411,  -0.         ,   0.000127288],
                   [ -0.000597126,  -0.000379755,  -0.001379106],
                   [  0.000363061,  -0.000131022,  -0.001285213],
                   [  0.000908362,   0.000060742,  -0.000710818],
                   [  0.000937847,   0.000130355,  -0.000174719],
                   [  0.00073987 ,   0.00012575 ,   0.000116183],
                   [ -0.000182953,  -0.000409295,  -0.001105412],
                   [  0.000452362,  -0.000081871,  -0.000992316],
                   [  0.000789767,   0.00015547 ,  -0.000561408],
                   [  0.000787394,   0.000236095,  -0.000152734],
                   [  0.000629224,   0.000220223,   0.000084733],
                   [  0.000044481,  -0.000248425,  -0.000806801],
                   [  0.000407558,   0.000030604,  -0.000705945],
                   [  0.000594618,   0.000222565,  -0.000420269],
                   [  0.000589144,   0.000284872,  -0.000138705],
                   [  0.000485733,   0.00026356 ,   0.000042177],
                   [  0.000097943,  -0.000109066,  -0.000563407],
                   [  0.000294543,   0.000091356,  -0.000490654],
                   [  0.000399793,   0.000227764,  -0.000313891],
                   [  0.0004038  ,   0.000274855,  -0.000129723],
                   [  0.000348016,   0.00025914 ,   0.00000265 ]]

# Comparison
psi4.compare_arrays(efs_1threads, efs_4threads, 9, "Reference value for EF calculation, 1 thread vs. 4 threads.")
psi4.compare_arrays(efs_1threads, reference_efs, 9, "Reference value for EF calculation, 1 thread vs. reference calculation.")
