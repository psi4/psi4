#! Test INCFOCK with range-separated functionals (CAM-B3LYP, wB97X)
#! Regression test for wK accumulation bug fix
#! Uses screening=DENSITY, validates energy AND iteration count

print(' INCFOCK with range-separated functionals') #TEST

molecule water {
    O
    H 1 0.96
    H 1 0.96 2 104.5
}

# Reference values from incfock=false, screening=density runs
# Note: iteration count may vary by +-1 across compilers due to floating-point differences
Eref_camb3lyp = -76.391854905210
Iref_camb3lyp = 15
Eref_wb97x = -76.400407871369
Iref_wb97x = 17
Itol = 1  # allowed iteration tolerance

def compare_iterations(expected, computed, label):
    """Compare iteration counts with tolerance for compiler differences."""
    diff = abs(computed - expected)
    if diff > Itol:
        raise TestComparisonError(f"{label}: computed ({computed}) differs from expected ({expected}) by {diff} iterations (tolerance: {Itol})")
    compare_integers(1, 1, label)  # Record pass in test output

set {
    basis cc-pvdz
    scf_type direct
    screening density
    incfock true
    incfock_convergence 1e-10
    e_convergence 1e-10
    d_convergence 1e-8
}

# CAM-B3LYP with INCFOCK
E, wfn = energy('cam-b3lyp', return_wfn=True)
compare_values(Eref_camb3lyp, E, 8, 'CAM-B3LYP INCFOCK DENSITY: Energy') #TEST
compare_iterations(Iref_camb3lyp, wfn.iteration_, 'CAM-B3LYP INCFOCK DENSITY: Iterations') #TEST

clean()

# wB97X with INCFOCK
E, wfn = energy('wb97x', return_wfn=True)
compare_values(Eref_wb97x, E, 8, 'wB97X INCFOCK DENSITY: Energy') #TEST
compare_iterations(Iref_wb97x, wfn.iteration_, 'wB97X INCFOCK DENSITY: Iterations') #TEST
