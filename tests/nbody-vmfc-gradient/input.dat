#! Computation of VMFC-corrected water trimer gradient (geometry from J. Chem. Theory Comput. 11, 2126-2136 (2015))

import numpy as np

molecule water_trimer {
O      -2.76373224  -1.24377706  -0.15444566
H      -1.12357791  -2.06227970  -0.05243799
H      -3.80792362  -2.08705525   1.06090407
--
O       2.46924614  -1.75437739  -0.17092884
H       3.76368260  -2.21425403   1.00846104
H       2.30598330   0.07098445  -0.03942473
--
O       0.29127930   3.00875625   0.20308515
H      -1.21253048   1.95820900   0.10303324
H       0.10002049   4.24958115  -1.10222079
no_reorient
no_com
symmetry c1
units bohr
}

g, wfn = psi4.gradient('SCF/STO-3G', molecule=water_trimer, bsse_type='vmfc',
                                      return_total_data=True, return_wfn=True)
core.clean()

vmfc_scheme = {'((1, 2), (1, 2))': 1, '((1, 3), (1, 3))': 1, '((2, 3), (2, 3))': 1, #TEST
               '((1,), (1, 2))': -1, '((1,), (1, 3))': -1, '((2,), (1, 2))': -1, #TEST
               '((2,), (2, 3))': -1, '((3,), (1, 3))': -1, '((3,), (2, 3))': -1, #TEST
               '((1,), (1,))': 1, '((2,), (2,))': 1, '((3,), (3,))': 1} #TEST

vmfc_scheme_3b = {
     "((1,), (1, 2, 3))": 1,
     "((1, 2), (1, 2, 3))": -1,
     "((1, 2, 3), (1, 2, 3))": 1,
     "((1, 3), (1, 2, 3))": -1,
     "((2,), (1, 2, 3))": 1,
     "((2, 3), (1, 2, 3))": -1,
     "((3,), (1, 2, 3))": 1,
}

import qcmanybody as qcmb  #TEST
sz_dict = {1: 3, 2: 3, 3: 3}
sl_dict = {1: slice(0, 3), 2: slice(3, 6), 3: slice(6, 9)}

energy_dict, gradient_dict = {}, {} #TEST
for i in vmfc_scheme: #TEST
    mol = water_trimer.extract_subsets(eval(i)[0], list(set(eval(i)[1]) - set(eval(i)[0]))) #TEST
    gradient_dict[i], wfn_mol = gradient('SCF/STO-3G', molecule=mol, return_wfn=True) #TEST
    energy_dict[i] = core.variable('CURRENT ENERGY') #TEST
    core.clean() #TEST

    contracted_gradient = qcmb.resize_gradient(wfn.variable(f"GRADIENT 1_{i}").np, eval(i)[1], sz_dict, sl_dict, reverse=True)
    compare_values(energy_dict[i], wfn.variables()["1_"+i], 8, 'Energy of %s' %i) #TEST
    compare_arrays(gradient_dict[i], contracted_gradient, 8, 'Gradient of %s' %i) #TEST

energy_dict_3b, gradient_dict_3b = {}, {} #TEST
for i in vmfc_scheme_3b: #TEST
    mol = water_trimer.extract_subsets(eval(i)[0], list(set(eval(i)[1]) - set(eval(i)[0]))) #TEST
    gradient_dict_3b[i], wfn_mol = gradient('SCF/STO-3G', molecule=mol, return_wfn=True) #TEST
    energy_dict_3b[i] = core.variable('CURRENT ENERGY') #TEST
    core.clean() #TEST

    compare_values(energy_dict_3b[i], wfn.variables()["1_"+i], 8, 'Energy of %s' %i) #TEST
    compare_arrays(gradient_dict_3b[i], wfn.variables()['GRADIENT %s' % "1_"+i], 8, 'Gradient of %s' %i) #TEST

ene, grad1b, grad2b, grad3b = 0, np.zeros((9, 3)), np.zeros((9, 3)), np.zeros((9, 3))  #TEST

for i in vmfc_scheme: #TEST
    ene += vmfc_scheme[i] * energy_dict[i] #TEST

# renamed for v1.10
# * '2' -> 'VMFC-CORRECTED TOTAL ENERGY THROUGH 2-BODY'
# * 'GRADIENT 1' -> 'VMFC-CORRECTED TOTAL GRADIENT THROUGH 1-BODY'
# * 'GRADIENT 2' -> 'VMFC-CORRECTED TOTAL GRADIENT THROUGH 2-BODY'
# * 'GRADIENT 3' -> 'VMFC-CORRECTED TOTAL GRADIENT THROUGH 3-BODY'

compare_values(ene, wfn.variable('VMFC-CORRECTED TOTAL ENERGY THROUGH 2-BODY'), 8, 'VMFC-Corrected Energy') #TEST

for i in range(3): #TEST
    key = '((%i,), (%i,))' %(i + 1, i + 1) #TEST
    print(key, i, i*3, ":", i*3+3)
    grad1b[i*3: i*3 + 3, :] += vmfc_scheme.pop(key) * np.array(gradient_dict[key]) #TEST

for key in vmfc_scheme: #TEST
    i, j = eval(key)[1][0]-1, eval(key)[1][1]-1 #TEST
    index = [i*3, i*3 + 1, i*3 + 2, j*3, j*3 + 1, j*3 + 2] #TEST
    grad2b[index, :] += vmfc_scheme[key] * np.array(gradient_dict[key]) #TEST

compare_arrays(grad1b + grad2b, wfn.variable('VMFC-CORRECTED TOTAL GRADIENT THROUGH 2-BODY'), 8, 'VMFC-Corrected Gradient 2b') #TEST

for key in vmfc_scheme_3b:  #TEST
    i, j, k = eval(key)[1][0]-1, eval(key)[1][1]-1, eval(key)[1][2]-1  #TEST
    index = [i*3, i*3 + 1, i*3 + 2, j*3, j*3 + 1, j*3 + 2, k*3, k*3 + 1, k*3 + 2]  #TEST
    grad3b[index, :] += vmfc_scheme_3b[key] * np.array(gradient_dict_3b[key]) #TEST
 
compare_arrays(grad1b + grad2b + grad3b, wfn.variable('VMFC-CORRECTED TOTAL GRADIENT THROUGH 3-BODY'), 8, 'VMFC-Corrected Gradient 3b') #TEST

grad_maxnb2 = np.array(  # grad1b + grad2b
     [[ 0.002155804191, -0.029634185797,  0.032376607396],
      [-0.003170680084,  0.014254859601, -0.006078802815],
      [ 0.012483476168,  0.023203573171, -0.025365946635],
      [ 0.025226012667,  0.016325441914,  0.031594301626],
      [-0.027006236709, -0.001406222833, -0.024814674937],
      [-0.010724421068, -0.008596936788, -0.007375340751],
      [-0.024435013809,  0.009777336603, -0.035394108341],
      [ 0.012544129973, -0.004104715215,  0.008163796645],
      [ 0.012926928671, -0.019819150657,  0.026894167812]])
old_grad_maxnb3 = np.array(  # grad 2b + grad 3b
     [[ 0.002219694063,  0.009321053605, -0.006605392323],
      [ 0.004716622541, -0.000932172428,  0.004496896826],
      [ 0.001311905336, -0.002455421929,  0.003035312701],
      [-0.009018191555, -0.002317388378, -0.00680297185 ],
      [ 0.001420670764,  0.002045748088,  0.003021479389],
      [-0.001682106814,  0.004664038597,  0.003106497953],
      [ 0.006639093791, -0.006637441486,  0.005420065144],
      [-0.003115962895, -0.004227261417, -0.002455116289],
      [-0.002491725232,  0.000538845348, -0.003216771551]])
grad_maxnb3 = np.array(  # grad1b + grad2b + grad3b
     [[ 0.00209757, -0.03193087,  0.03215398],
      [-0.00614372,  0.01497593, -0.00602056],
      [ 0.01229437,  0.0228884 , -0.0252066 ],
      [ 0.02716011,  0.01757155,  0.03135191],
      [-0.0266962 , -0.00140618, -0.02472782],
      [-0.00974354, -0.01177298, -0.00729909],
      [-0.02658095,  0.0110038 , -0.03520583],
      [ 0.01481033, -0.00176671,  0.00820086],
      [ 0.01280202, -0.01956295,  0.02675315]])

compare_arrays(grad_maxnb3, g, 6, 'returned gradient')  #TEST
compare_arrays(grad_maxnb2, wfn.variable("VMFC-CORRECTED TOTAL GRADIENT THROUGH 2-BODY"), 6, '2-body gradient')  #TEST
compare_arrays(grad_maxnb3, wfn.variable("VMFC-CORRECTED TOTAL GRADIENT THROUGH 3-BODY"), 6, '3-body gradient')  #TEST
compare_arrays(old_grad_maxnb3, wfn.variable("VMFC-CORRECTED TOTAL GRADIENT THROUGH 3-BODY").np - wfn.variable("VMFC-CORRECTED TOTAL GRADIENT THROUGH 1-BODY").np, 6, 'previous wrong 3-body gradient understood')  #TEST
