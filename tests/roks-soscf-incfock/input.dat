#! ROKS + SOSCF + IncFock with range-separated functional (CAM-B3LYP)
#! Tests XC Hessian-vector products implementation in ROHF::Hx()

print(' ROKS SOSCF with IncFock and range-separated functional') #TEST

molecule li {
    0 2
    Li 0 0 0
    symmetry c1
}

# Reference from converged calculation
# Note: iteration count may vary by +-1 across compilers due to floating-point differences
Eref_camb3lyp = -7.469766603468
Iref_camb3lyp = 15
Itol = 1  # allowed iteration tolerance

def compare_iterations(expected, computed, label):
    """Compare iteration counts with tolerance for compiler differences."""
    diff = abs(computed - expected)
    if diff > Itol:
        raise TestComparisonError(f"{label}: computed ({computed}) differs from expected ({expected}) by {diff} iterations (tolerance: {Itol})")
    compare_integers(1, 1, label)  # Record pass in test output

set {
    basis cc-pVDZ
    reference roks
    scf_type direct
    incfock true
    e_convergence 1e-10
    d_convergence 1e-8
    soscf true
    soscf_start_convergence 1e-3
    maxiter 50
}

E, wfn = energy('cam-b3lyp', return_wfn=True)
compare_values(Eref_camb3lyp, E, 8, 'ROKS SOSCF CAM-B3LYP: Energy') #TEST
compare_iterations(Iref_camb3lyp, wfn.iteration_, 'ROKS SOSCF CAM-B3LYP: Iterations') #TEST
