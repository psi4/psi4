
.PHONY: tests quicktests cc_tests clean quicktestsclean longtests longtestsclean

# Tutorial test cases
tutorial_subdirs = tu1-h2o-energy tu2-ch2-energy tu3-h2o-opt tu4-h2o-freq tu5-sapt tu6-cp-ne2

# Tests that depend on madness:
#  This is probably not the final solution:
maddness_subdirs = dfmp2_1 dfmp2_2

cc_subdirs = cc1 cc2 cc3 cc4 cc4a cc5a cc6 cc8 cc8a cc8b cc8c cc9 cc9a cc10 cc11 \
cc12 cc13 cc13a cc14 cc15 cc16 cc17 cc18 cc19 cc22 cc23 cc24 cc25 cc26 cc27 cc28 \
cc29 cc30 cc31 cc32 cc33 cc34 cc35 cc36 cc37 cc38 cc39 cc40 cc41 cc42 \
cc43 cc44 cc45 cc49 cc50 cc51 cc52 # cc5 these should be restored when fixed

ci_subdirs = cisd-h2o+-0 cisd-h2o+-1 cisd-h2o+-2 cisd-h2o-clpse cisd-sp cisd-sp-2 fci-h2o fci-h2o-2 fci-h2o-fzcv fci-dipole fci-tdm fci-tdm-2 cisd-opt-fd rasci-c2-active rasci-h2o rasci-ne zaptn-nh2 mpn-bh

dcft_subdirs = dcft1 dcft2 dcft3 dcft4 #dcft5

mcscf_subdirs = mcscf1 mcscf2 mcscf3

df_subdirs = sapt1 sapt3 sapt5

psimrcc_subdirs = psimrcc-sp1 psimrcc_ccsd_t-1

mints_subdirs = mints1 mints2 mints3 mints4

matrix_subdirs = matrix1

opt_subdirs = opt1 opt1-fd opt2 opt2-fd opt3 opt4 opt5 fd-gradient fd-freq-energy fd-freq-gradient fd-freq-gradient-large

mp2_subdirs = mp2_1

scf_subdirs = scf1 scf2 scf3 scf4 scf5 sad1 castup1 mom props1 props2 dft1 dfscf-bz2 pubchem1

python_test_subdirs = pywrap_db1 pywrap_db2 pywrap_cbs1 pywrap_all pywrap_alias

plugin_subdirs = plugin_aointegrals plugin_sointegrals plugin_backtrans plugin_mp2 plugin_mointegrals plugin_testparse

longtest_subdirs = sapt2 sapt4

subdirs = \
$(tutorial_subdirs) \
$(mints_subdirs) \
$(matrix_subdirs) \
$(scf_subdirs) \
$(opt_subdirs) \
$(df_subdirs) \
$(mp2_subdirs) \
$(ci_subdirs) \
$(cc_subdirs) \
$(python_test_subdirs) \
${mcscf_subdirs} \
$(psimrcc_subdirs) \
$(dcft_subdirs)

HAVE_MADNESS=@HAVE_MPI@
ifeq ($(HAVE_MADNESS),1)
   subdirs += $(maddness_subdirs)
endif
 
# Compile the plugins, if we activated them
HAVE_PLUGINS=@HAVE_PLUGINS@
ifeq ($(HAVE_PLUGINS),yes)
   subdirs += $(plugin_subdirs)
endif

# the bare minimum
quicktestdirs = 

define runtests
    for dir in $1; \
	do \
        (\
        cd $${dir} &&\
        echo "Testing $${dir}..." | tee -a ../../test-case-results &&\
        $(MAKE) && cat $${dir}.test >> ../../test-case-results;\
        );\
        if [ $$? != 0 ]; then\
         echo "\tFAILED" | tee -a ../test-case-results; exit 1;\
        fi;\
	done
endef

tests:
	$(call runtests, $(subdirs))

opttests:
	$(call runtests, $(opt_subdirs))

quicktests:
	$(call runtests, $(quicktestdirs))

cc_tests:
	$(call runtests, $(cc_subdirs))

ci_tests:
	$(call runtests, $(ci_subdirs))

mints_tests:
	$(call runtests, $(mints_subdirs))

mp2_tests:
	$(call runtests, $(mp2_subdirs))

matrix_tests:
	$(call runtests, $(matrix_subdirs))

mcscf_tests:
	$(call runtests, $(mcscf_subdirs))

scf_tests:
	$(call runtests, $(scf_subdirs))

df_tests:
	$(call runtests, $(df_subdirs))

dcft_tests:
	$(call runtests, $(dcft_subdirs))

psimrcc_tests:
	$(call runtests, $(psimrcc_subdirs))

python_tests:
	$(call runtests, $(python_test_subdirs))

longtests:
	$(call runtests, $(longtest_subdirs))

plugins:
	for dir in $(plugin_subdirs); \
	do \
	 (cd $${dir} && echo ...Testing $${dir}... && $(MAKE)) || exit 1; \
	done

clean:
	for dir in $(subdirs); \
	do \
	 (cd $${dir} && echo ...Cleaning $${dir}... && $(MAKE) clean) || exit 1; \
	done
	rm -f ../test-case-results

quicktestsclean:
	for dir in $(quicktestdirs); \
	do \
	 (cd $${dir} && echo ...Cleaning $${dir}... && $(MAKE) clean) || exit 1; \
	done
	rm -f ../test-case-results

longtestsclean:
	for dir in $(longtest_subdirs); \
	do \
	 (cd $${dir} && echo ...Cleaning $${dir}... && $(MAKE) clean) || exit 1; \
	done

top_srcdir = @top_srcdir@
srcdir = @srcdir@
top_objdir = ..

$(top_srcdir)/configure: $(top_srcdir)/configure.ac $(top_srcdir)/aclocal.m4
	cd $(top_srcdir) && autoconf

$(top_objdir)/config.status: $(top_srcdir)/configure
	cd $(top_objdir) && ./config.status --recheck

Makefile: $(srcdir)/Makefile.in $(top_objdir)/config.status
	cd $(top_objdir) && CONFIG_FILES=tests/Makefile ./config.status

