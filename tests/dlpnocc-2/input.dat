#! comparison of DF-CCSD(T) and DLPNO-CCSD(T) without frozen core
#! Also a test of very_tight parameters
#! Methane geometry from HTBH.py in databases
#! The reference DF-CCSD(T) values are stored and not rerun
#! This also tests the low memory overlap/disk algorithms available

memory 4 GB

ref_scf                  =    -40.213627016015              #TEST

ref_dfccsd_corl          =     -0.240124468398              #TEST
ref_dfccsd_tot           =    -40.453751484412              #TEST
ref_dfccsd_t_corl        =     -0.246845986540              #TEST
ref_dfccsd_t_tot         =    -40.460473002555              #TEST

ref_dlpnoccsd_corl       =     -0.240119244817              #TEST
ref_dlpnoccsd_tot        =    -40.453746260834              #TEST
ref_dlpnoccsd_t_corl     =     -0.246838014696              #TEST
ref_dlpnoccsd_t_tot      =    -40.460465030713              #TEST

molecule ch4 {
0 1
C        0.00000000     0.00000000     0.00000000
H        0.00000000     1.08744517     0.00000000
H       -0.51262657    -0.36248173     0.88789526
H       -0.51262657    -0.36248173    -0.88789526
H        1.02525314    -0.36248173     0.00000000
units angstrom
}

set basis aug-cc-pvtz
set freeze_core False
set scf_type df
set mp2_type df
set cc_type df
set nat_orbs False
set pno_convergence very_tight
set e_convergence 1.0e-8
set r_convergence 1.0e-8
set dlpno_toggle_memory false

# Typical use case when memory is low for DLPNO-CCSD
set low_memory_overlap true
set write_qia_pno true
set write_qab_pno true

# Typical use case when memory is low for DLPNO-(T), 
# amplitudes written to disk as last resort
set write_triples_intermediates true
set write_triples_amplitudes false

print('   Testing DLPNO-CCSD(T) w/o frozen core...')
val = energy('dlpno-ccsd(t)')

# DLPNO-CCSD(T) matches DF-CCSD(T) if the thresholds are tightened enough
compare_values(ref_scf, variable('SCF TOTAL ENERGY'), 7, 'scf ref')                           #TEST
compare_values(ref_dfccsd_corl, variable('CCSD CORRELATION ENERGY'), 5, 'ccsd corl')          #TEST
compare_values(ref_dfccsd_tot, variable('CCSD TOTAL ENERGY'), 5, 'ccsd tot')                  #TEST
compare_values(ref_dfccsd_t_corl, variable('CCSD(T) CORRELATION ENERGY'), 5, 'ccsd(t) corl')  #TEST
compare_values(ref_dfccsd_t_tot, variable('CCSD(T) TOTAL ENERGY'), 5, 'ccsd(t) tot')          #TEST
compare_values(ref_scf, variable('CURRENT REFERENCE ENERGY'), 7, 'scf ref')                   #TEST
compare_values(ref_dfccsd_t_corl, variable('CURRENT CORRELATION ENERGY'), 5, 'ccsd(t) corl')  #TEST
compare_values(ref_dfccsd_t_tot, variable('CURRENT ENERGY'), 5, 'ccsd(t) tot')                #TEST
compare_values(ref_dfccsd_t_tot, val, 5, 'ccsd(t) return')                                    #TEST
clean()

# Compare with DLPNO-CCSD(T) values if anything changes in the code
compare_values(ref_scf, variable('SCF TOTAL ENERGY'), 7, 'scf ref')                              #TEST
compare_values(ref_dlpnoccsd_corl, variable('CCSD CORRELATION ENERGY'), 7, 'ccsd corl')          #TEST
compare_values(ref_dlpnoccsd_tot, variable('CCSD TOTAL ENERGY'), 7, 'ccsd tot')                  #TEST
compare_values(ref_dlpnoccsd_t_corl, variable('CCSD(T) CORRELATION ENERGY'), 7, 'ccsd(t) corl')  #TEST
compare_values(ref_dlpnoccsd_t_tot, variable('CCSD(T) TOTAL ENERGY'), 7, 'ccsd(t) tot')          #TEST
compare_values(ref_scf, variable('CURRENT REFERENCE ENERGY'), 7, 'scf ref')                      #TEST
compare_values(ref_dlpnoccsd_t_corl, variable('CURRENT CORRELATION ENERGY'), 7, 'ccsd(t) corl')  #TEST
compare_values(ref_dlpnoccsd_t_tot, variable('CURRENT ENERGY'), 7, 'ccsd(t) tot')                #TEST
compare_values(ref_dlpnoccsd_t_tot, val, 7, 'ccsd(t) return')                                    #TEST
clean()
