#! comparison of MP2-F12 with MPQC4
#! Note: MPQC4 does not use robust DF for DF-MP2-F12
#! MP2 convergence requires that e_conv and d_conv are 1e-10

ref_scf               =  -76.058488530572234       # TEST
ref_mp2_corl          =  -0.24116949213204231      # TEST
ref_f12_corl          =  -0.055329485400320434     # TEST
ref_singles_corl      =  -0.0032481493805634775    # TEST
ref_mp2f12_corl       =  -0.29974712691292626      # TEST
ref_mp2f12_total      =  -76.358235657485167       # TEST

molecule h2o {
O    0.000000000    0.000000000    0.221664874
H    0.000000000    1.430900622   -0.886659498
H    0.000000000   -1.430900622   -0.886659498

units bohr
symmetry c1
}

set {
  basis          cc-pvdz-f12
  freeze_core    True
  mp2_type       conv
  e_convergence  1e-10
  d_convergence  1e-10
}

if psi4.core.get_option("scf", "orbital_optimizer_package") != "INTERNAL":
    psi4.set_options({"e_convergence": 9, "d_convergence": 5e-9})

print('   Testing MP2-F12/3C(FIX) ...')
val, wfn = energy('mp2-f12', return_wfn=True)

compare_values(ref_scf, variable('SCF TOTAL ENERGY'), 9, 'mp2-f12 ref')                      #TEST
compare_values(ref_mp2_corl, variable('MP2 CORRELATION ENERGY'), 9, 'mp2 corl')              #TEST
compare_values(ref_mp2f12_corl, variable('MP2-F12 CORRELATION ENERGY') + variable("F12 CABS CORRECTION ENERGY"), 9, 'mp2-f12 corl')   #TEST
compare_values(ref_mp2f12_corl, wfn.variable('MP2-F12 CORRELATION ENERGY') + wfn.variable("F12 CABS CORRECTION ENERGY"), 9, 'mp2-f12 corl')   #TEST
compare_values(ref_mp2f12_total, wfn.variable('MP2-F12 TOTAL ENERGY'), 9, 'mp2-f12 tot')         #TEST
compare_values(ref_mp2f12_total, variable('MP2-F12 TOTAL ENERGY'), 9, 'mp2-f12 tot')         #TEST
compare_values(ref_singles_corl, variable('F12 CABS CORRECTION energy'), 9, 'f12 singles')           #TEST
compare_values(ref_f12_corl, variable('MP2-F12 DOUBLES ENERGY') - variable("MP2 DOUBLES ENERGY"), 9, 'f12 doubles')               #TEST
compare_values(ref_scf, variable('CURRENT REFERENCE ENERGY') - variable("F12 CABS CORRECTION ENERGY"), 9, 'mp2-f12 ref')              #TEST
compare_values(ref_mp2f12_corl, variable('CURRENT CORRELATION ENERGY') + variable("F12 CABS CORRECTION ENERGY"), 9, 'mp2-f12 corl')   #TEST
compare_values(ref_mp2f12_total, variable('CURRENT ENERGY'), 9, 'mp2-f12 tot')               #TEST
compare_values(ref_mp2f12_total, val, 9, 'mp2-f12 return')                                   #TEST
