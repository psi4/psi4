


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>wrappers &mdash; Psithon for PSI4 documentation</title>
    
    <link rel="stylesheet" href="../_static/psi4.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '4.01',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/toggle_sections.js"></script>
    <link rel="top" title="Psithon for PSI4 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
    <script type="text/javascript" src="../_static/copybutton.js"></script> 

  </head>
  <body>
    <div class="relbar-top">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
    <li><a href="../index.html">Psithon for PSI4 Documentation</a> &raquo; </li>

          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for wrappers</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;Module with functions that call the four main :py:mod:`driver`</span>
<span class="sd">functions: :py:mod:`driver.energy`, :py:mod:`driver.optimize`,</span>
<span class="sd">:py:mod:`driver.response`, and :py:mod:`driver.frequency`.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">PsiMod</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">input</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">physconst</span>
<span class="kn">from</span> <span class="nn">driver</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">molutil</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">text</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">procutil</span> <span class="kn">import</span> <span class="o">*</span>


<span class="c"># Function to make calls among wrappers(), energy(), optimize(), etc.</span>
<div class="viewcode-block" id="call_function_in_1st_argument"><a class="viewcode-back" href="../index.html#wrappers.call_function_in_1st_argument">[docs]</a><span class="k">def</span> <span class="nf">call_function_in_1st_argument</span><span class="p">(</span><span class="n">funcarg</span><span class="p">,</span> <span class="o">**</span><span class="n">largs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to make primary function call to energy(), opt(), etc.</span>
<span class="sd">    with options dictionary *largs*.</span>
<span class="sd">    Useful when *funcarg* to call is stored in variable.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">funcarg</span><span class="p">(</span><span class="o">**</span><span class="n">largs</span><span class="p">)</span>


<span class="c">#######################</span>
<span class="c">##  Start of n_body  ##</span>
<span class="c">#######################</span>
</div>
<div class="viewcode-block" id="n_body"><a class="viewcode-back" href="../index.html#wrappers.n_body">[docs]</a><span class="k">def</span> <span class="nf">n_body</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c"># Wrap any positional arguments into kwargs (for intercalls among wrappers)</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="s">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c"># Establish function to call</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="s">&#39;n_body_func&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;func&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;n_body_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;func&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;func&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;n_body_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;n_body_func&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">func</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Function </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> does not exist to be called by wrapper n_body.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="ow">is</span> <span class="n">db</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Wrapper n_body is unhappy to be calling function </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>

    <span class="c"># Make sure the molecule the user provided is the active one</span>
    <span class="k">if</span> <span class="s">&#39;molecule&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">activate</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;molecule&#39;</span><span class="p">])</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;molecule&#39;</span><span class="p">]</span>
    <span class="n">molecule</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&quot;BASIS&quot;</span><span class="p">,</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&quot;BASIS&quot;</span><span class="p">))</span>

    <span class="c"># N-body run configuration</span>
    <span class="n">bsse</span> <span class="o">=</span> <span class="s">&#39;on&#39;</span>
    <span class="k">if</span> <span class="s">&#39;bsse&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">bsse</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;bsse&#39;</span><span class="p">]</span>

    <span class="n">max_n_body</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">nfragments</span><span class="p">()</span>
    <span class="k">if</span> <span class="s">&#39;max_n_body&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">max_n_body</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;max_n_body&#39;</span><span class="p">]</span>

    <span class="n">do_total</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="s">&#39;do_total&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">do_total</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;do_total&#39;</span><span class="p">]</span>

    <span class="n">external</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">external_indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s">&#39;external&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">external</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;external&#39;</span><span class="p">]</span>
        <span class="n">external_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">molecule</span><span class="o">.</span><span class="n">nfragments</span><span class="p">()]</span>
        <span class="k">if</span> <span class="s">&#39;external_monomers&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">external_indices</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;external_monomers&#39;</span><span class="p">]</span>

    <span class="c"># Check input args</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;off&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;on&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;both&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;n_body: bsse argument is one of on, off, or both&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">max_n_body</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;n_body: max_n_body must be at least 1&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">max_n_body</span> <span class="o">&gt;</span> <span class="n">molecule</span><span class="o">.</span><span class="n">nfragments</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;n_body: max_n_body must be &lt;= to the number of fragments in the molecule&#39;</span><span class="p">)</span>

    <span class="c"># Set to save RI integrals for repeated full-basis computations</span>
    <span class="n">ri_ints_io</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">)</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">,</span> <span class="s">&#39;SAVE&#39;</span><span class="p">)</span>
    <span class="n">psioh</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">IOManager</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span>
    <span class="n">psioh</span><span class="o">.</span><span class="n">set_specific_retention</span><span class="p">(</span><span class="mi">97</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

    <span class="c"># Tell &#39;em what you&#39;re gonna tell &#39;em</span>
    <span class="n">has_external</span> <span class="o">=</span> <span class="s">&#39;No&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">external</span><span class="p">):</span>
        <span class="n">has_external</span> <span class="o">=</span> <span class="s">&#39;Yes&#39;</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;    ==&gt; N-Body Interaction Energy Analysis &lt;==</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;        BSSE Treatment:              </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bsse</span><span class="p">))</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;        Maximum N-Body Interactions: </span><span class="si">%d</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">max_n_body</span><span class="p">))</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;        Compute Total Energy:        </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">do_total</span><span class="p">))</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;        External Field:              </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">has_external</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">external</span><span class="p">):</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;        External Field Monomers:     &#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">external_indices</span><span class="p">:</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%-3d</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">))</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="c"># Run the total molecule, if required</span>
    <span class="n">energies_full</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">energies_mon</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">nfragments</span><span class="p">()</span>
    <span class="n">Etotal</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">do_total</span> <span class="ow">or</span> <span class="n">max_n_body</span> <span class="o">==</span> <span class="n">molecule</span><span class="o">.</span><span class="n">nfragments</span><span class="p">():</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;    =&gt; Total Cluster Energy &lt;=</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="c"># Full cluster always gets the external field</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">external</span><span class="p">):</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option_python</span><span class="p">(</span><span class="s">&quot;EXTERN&quot;</span><span class="p">,</span> <span class="n">external</span><span class="p">)</span>
        <span class="n">Etotal</span> <span class="o">=</span> <span class="n">call_function_in_1st_argument</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">external</span><span class="p">):</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option_python</span><span class="p">(</span><span class="s">&quot;EXTERN&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">energies_full</span><span class="p">[</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">energies_full</span><span class="p">[</span><span class="n">N</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Etotal</span><span class="p">)</span>
        <span class="n">energies_mon</span><span class="p">[</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">energies_mon</span><span class="p">[</span><span class="n">N</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Etotal</span><span class="p">)</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">,</span> <span class="s">&#39;LOAD&#39;</span><span class="p">)</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>

    <span class="n">max_effective</span> <span class="o">=</span> <span class="n">max_n_body</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">max_effective</span> <span class="o">==</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">max_effective</span> <span class="o">=</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c"># Build the combos for indexing purposes</span>
    <span class="n">Ns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">max_n_body</span> <span class="o">==</span> <span class="n">N</span> <span class="ow">or</span> <span class="n">do_total</span><span class="p">):</span>
        <span class="n">Ns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_effective</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">Ns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="n">combos</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">Ns</span><span class="p">:</span>

        <span class="n">combos</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Loop through combinations in lexical order #</span>

        <span class="c"># initialize the reals list</span>
        <span class="n">reals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c">#setup first combination [3,2,1] lexical ordering</span>
        <span class="c">#fragments indexing is 1&#39;s based, bloody hell</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">reals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="c">#start loop through lexical promotion</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>

            <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c"># Append the current combo</span>
            <span class="n">combos</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">reals</span><span class="p">))</span>

            <span class="c">#reset rank</span>
            <span class="n">rank</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c">#look for lexical promotion opportunity</span>
            <span class="c">#i.e.: [4 2 1] has a promotion opportunity at</span>
            <span class="c"># index 1 to produce [4 3 1]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">reals</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="n">reals</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">rank</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">break</span>

            <span class="c">#do the promotion</span>
            <span class="n">reals</span><span class="p">[</span><span class="n">rank</span><span class="p">]</span> <span class="o">=</span> <span class="n">reals</span><span class="p">[</span><span class="n">rank</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c">#demote the right portion of the register</span>
            <span class="n">val</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">reals</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c">#boundary condition is promotion into</span>
            <span class="c">#[nfrag+1 nfrag-1 ...]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">reals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">N</span><span class="p">):</span>
                <span class="k">break</span>

    <span class="c"># Hack for external</span>
    <span class="n">externNone</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">ExternalPotential</span><span class="p">()</span>

    <span class="c"># Run the clusters in the full basis</span>
    <span class="k">if</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;on&#39;</span> <span class="ow">or</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;both&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_effective</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">energies_full</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">clusters</span> <span class="o">=</span> <span class="n">extract_clusters</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">)):</span>
                <span class="n">activate</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="c"># Do the external field for this cluster or not?</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">external</span><span class="p">):</span>
                    <span class="n">do_extern</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">for</span> <span class="n">mon</span> <span class="ow">in</span> <span class="n">combos</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">mon</span> <span class="ow">in</span> <span class="n">external_indices</span><span class="p">):</span>
                            <span class="n">do_extern</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">do_extern</span><span class="p">:</span>
                        <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option_python</span><span class="p">(</span><span class="s">&quot;EXTERN&quot;</span><span class="p">,</span> <span class="n">external</span><span class="p">)</span>
                <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">    =&gt; Cluster (N-Body </span><span class="si">%4d</span><span class="s">, Combination </span><span class="si">%4d</span><span class="s">) Energy (Full Basis) &lt;=</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">energies_full</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">call_function_in_1st_argument</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
                <span class="c"># Turn the external field off</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">external</span><span class="p">):</span>
                    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option_python</span><span class="p">(</span><span class="s">&quot;EXTERN&quot;</span><span class="p">,</span> <span class="n">externNone</span><span class="p">)</span>
                <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">,</span> <span class="s">&#39;LOAD&#39;</span><span class="p">)</span>
                <span class="n">PsiMod</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>

    <span class="c"># Run the clusters in the minimal cluster bases</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">,</span> <span class="s">&#39;NONE&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;off&#39;</span> <span class="ow">or</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;both&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_effective</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">energies_mon</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">clusters</span> <span class="o">=</span> <span class="n">extract_clusters</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">)):</span>
                <span class="n">activate</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="c"># Do the external field for this cluster or not?</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">external</span><span class="p">):</span>
                    <span class="n">do_extern</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">for</span> <span class="n">mon</span> <span class="ow">in</span> <span class="n">combos</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">mon</span> <span class="ow">in</span> <span class="n">external_indices</span><span class="p">):</span>
                            <span class="n">do_extern</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">do_extern</span><span class="p">:</span>
                        <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option_python</span><span class="p">(</span><span class="s">&quot;EXTERN&quot;</span><span class="p">,</span> <span class="n">external</span><span class="p">)</span>
                <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">    =&gt; Cluster (N-Body </span><span class="si">%4d</span><span class="s">, Combination </span><span class="si">%4d</span><span class="s">) Energy (Cluster Basis) &lt;=</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">energies_mon</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">call_function_in_1st_argument</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
                <span class="c"># Turn the external field off</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">external</span><span class="p">):</span>
                    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option_python</span><span class="p">(</span><span class="s">&quot;EXTERN&quot;</span><span class="p">,</span> <span class="n">externNone</span><span class="p">)</span>
                <span class="n">PsiMod</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>

    <span class="c"># Report the energies</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">    ==&gt; N-Body Interaction Energy Analysis: Combination Definitions &lt;==</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     </span><span class="si">%6s</span><span class="s"> </span><span class="si">%6s</span><span class="s"> | </span><span class="si">%-24s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;N-Body&quot;</span><span class="p">,</span> <span class="s">&quot;Combo&quot;</span><span class="p">,</span> <span class="s">&quot;Monomers&quot;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">Ns</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">combos</span><span class="p">[</span><span class="n">n</span><span class="p">])):</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     </span><span class="si">%6d</span><span class="s"> </span><span class="si">%6d</span><span class="s"> | &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">combos</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">]:</span>
                <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%-3d</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">l</span><span class="p">))</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;    ==&gt; N-Body Interaction Energy Analysis: Total Energies &lt;==</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;on&#39;</span> <span class="ow">or</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;both&#39;</span><span class="p">:</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     =&gt; Full Basis Set Results &lt;=</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     </span><span class="si">%6s</span><span class="s"> </span><span class="si">%6s</span><span class="s"> </span><span class="si">%24s</span><span class="s"> </span><span class="si">%24s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;N-Body&quot;</span><span class="p">,</span> <span class="s">&quot;Combo&quot;</span><span class="p">,</span> <span class="s">&quot;E [H]&quot;</span><span class="p">,</span> <span class="s">&quot;E [kcal mol^-1]&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">Ns</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energies_full</span><span class="p">[</span><span class="n">n</span><span class="p">])):</span>
                <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     </span><span class="si">%6d</span><span class="s"> </span><span class="si">%6d</span><span class="s"> </span><span class="si">%24.16E</span><span class="s"> </span><span class="si">%24.16E</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">energies_full</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">],</span>
                   <span class="n">physconst</span><span class="o">.</span><span class="n">psi_hartree2kcalmol</span> <span class="o">*</span> <span class="n">energies_full</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">]))</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;off&#39;</span> <span class="ow">or</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;both&#39;</span><span class="p">:</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     =&gt; Cluster Basis Set Results &lt;=</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     </span><span class="si">%6s</span><span class="s"> </span><span class="si">%6s</span><span class="s"> </span><span class="si">%24s</span><span class="s"> </span><span class="si">%24s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;N-Body&quot;</span><span class="p">,</span> <span class="s">&quot;Combo&quot;</span><span class="p">,</span> <span class="s">&quot;E [H]&quot;</span><span class="p">,</span> <span class="s">&quot;E [kcal mol^-1]&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">Ns</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energies_mon</span><span class="p">[</span><span class="n">n</span><span class="p">])):</span>
                <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     </span><span class="si">%6d</span><span class="s"> </span><span class="si">%6d</span><span class="s"> </span><span class="si">%24.16E</span><span class="s"> </span><span class="si">%24.16E</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">energies_mon</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">],</span>
                   <span class="n">physconst</span><span class="o">.</span><span class="n">psi_hartree2kcalmol</span> <span class="o">*</span> <span class="n">energies_mon</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">]))</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;both&#39;</span><span class="p">:</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     =&gt; BSSE Results &lt;=</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     </span><span class="si">%6s</span><span class="s"> </span><span class="si">%6s</span><span class="s"> </span><span class="si">%24s</span><span class="s"> </span><span class="si">%24s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;N-Body&quot;</span><span class="p">,</span> <span class="s">&quot;Combo&quot;</span><span class="p">,</span> <span class="s">&quot;Delta E [H]&quot;</span><span class="p">,</span> <span class="s">&quot;Delta E [kcal mol^-1]&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">Ns</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energies_mon</span><span class="p">[</span><span class="n">n</span><span class="p">])):</span>
                <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     </span><span class="si">%6d</span><span class="s"> </span><span class="si">%6d</span><span class="s"> </span><span class="si">%24.16E</span><span class="s"> </span><span class="si">%24.16E</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">energies_full</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">energies_mon</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">],</span>
                   <span class="n">physconst</span><span class="o">.</span><span class="n">psi_hartree2kcalmol</span> <span class="o">*</span> <span class="p">(</span><span class="n">energies_full</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">energies_mon</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">])))</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;    ==&gt; N-Body Interaction Energy Analysis: N-Body Energies &lt;==</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;on&#39;</span> <span class="ow">or</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;both&#39;</span><span class="p">:</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     =&gt; Full Basis Set Results &lt;=</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     </span><span class="si">%6s</span><span class="s"> </span><span class="si">%6s</span><span class="s"> </span><span class="si">%24s</span><span class="s"> </span><span class="si">%24s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;N-Body&quot;</span><span class="p">,</span> <span class="s">&quot;Combo&quot;</span><span class="p">,</span> <span class="s">&quot;E [H]&quot;</span><span class="p">,</span> <span class="s">&quot;E [kcal mol^-1]&quot;</span><span class="p">))</span>
        <span class="n">energies_n_full</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">Ns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">En</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energies_full</span><span class="p">[</span><span class="n">n</span><span class="p">])):</span>
                <span class="n">E</span> <span class="o">=</span> <span class="n">energies_full</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">combos</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">])):</span>
                    <span class="n">E</span> <span class="o">-=</span> <span class="n">energies_full</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">combos</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     </span><span class="si">%6d</span><span class="s"> </span><span class="si">%6d</span><span class="s"> </span><span class="si">%24.16E</span><span class="s"> </span><span class="si">%24.16E</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">physconst</span><span class="o">.</span><span class="n">psi_hartree2kcalmol</span> <span class="o">*</span> <span class="n">E</span><span class="p">))</span>
                <span class="n">En</span> <span class="o">+=</span> <span class="n">E</span>
            <span class="n">energies_n_full</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">En</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">Ns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">nn</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">nfragments</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="n">kk</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="n">energies_n_full</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">/=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">nn</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">nn</span> <span class="o">-</span> <span class="n">kk</span><span class="p">)))</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     </span><span class="si">%6d</span><span class="s"> </span><span class="si">%6s</span><span class="s"> </span><span class="si">%24.16E</span><span class="s"> </span><span class="si">%24.16E</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s">&#39;Total&#39;</span><span class="p">,</span> <span class="n">energies_n_full</span><span class="p">[</span><span class="n">n</span><span class="p">],</span>
               <span class="n">physconst</span><span class="o">.</span><span class="n">psi_hartree2kcalmol</span> <span class="o">*</span> <span class="n">energies_n_full</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;off&#39;</span> <span class="ow">or</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;both&#39;</span><span class="p">:</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     =&gt; Cluster Basis Set Results &lt;=</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     </span><span class="si">%6s</span><span class="s"> </span><span class="si">%6s</span><span class="s"> </span><span class="si">%24s</span><span class="s"> </span><span class="si">%24s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;N-Body&quot;</span><span class="p">,</span> <span class="s">&quot;Combo&quot;</span><span class="p">,</span> <span class="s">&quot;E [H]&quot;</span><span class="p">,</span> <span class="s">&quot;E [kcal mol^-1]&quot;</span><span class="p">))</span>
        <span class="n">energies_n_mon</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">Ns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">En</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energies_mon</span><span class="p">[</span><span class="n">n</span><span class="p">])):</span>
                <span class="n">E</span> <span class="o">=</span> <span class="n">energies_mon</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">combos</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">])):</span>
                    <span class="n">E</span> <span class="o">-=</span> <span class="n">energies_mon</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">combos</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     </span><span class="si">%6d</span><span class="s"> </span><span class="si">%6d</span><span class="s"> </span><span class="si">%24.16E</span><span class="s"> </span><span class="si">%24.16E</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">physconst</span><span class="o">.</span><span class="n">psi_hartree2kcalmol</span> <span class="o">*</span> <span class="n">E</span><span class="p">))</span>
                <span class="n">En</span> <span class="o">+=</span> <span class="n">E</span>
            <span class="n">energies_n_mon</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">En</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">Ns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">nn</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">nfragments</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="n">kk</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="n">energies_n_mon</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">/=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">nn</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">nn</span> <span class="o">-</span> <span class="n">kk</span><span class="p">)))</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     </span><span class="si">%6d</span><span class="s"> </span><span class="si">%6s</span><span class="s"> </span><span class="si">%24.16E</span><span class="s"> </span><span class="si">%24.16E</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s">&#39;Total&#39;</span><span class="p">,</span> <span class="n">energies_n_mon</span><span class="p">[</span><span class="n">n</span><span class="p">],</span>
               <span class="n">physconst</span><span class="o">.</span><span class="n">psi_hartree2kcalmol</span> <span class="o">*</span> <span class="n">energies_n_mon</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;both&#39;</span><span class="p">:</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     =&gt; BSSE Results &lt;=</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     </span><span class="si">%6s</span><span class="s"> </span><span class="si">%6s</span><span class="s"> </span><span class="si">%24s</span><span class="s"> </span><span class="si">%24s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;N-Body&quot;</span><span class="p">,</span> <span class="s">&quot;Combo&quot;</span><span class="p">,</span> <span class="s">&quot;Delta E [H]&quot;</span><span class="p">,</span> <span class="s">&quot;Delta E [kcal mol^-1]&quot;</span><span class="p">))</span>
        <span class="n">energies_n_bsse</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">Ns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">En</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energies_mon</span><span class="p">[</span><span class="n">n</span><span class="p">])):</span>
                <span class="n">E</span> <span class="o">=</span> <span class="n">energies_full</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">energies_mon</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">combos</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">])):</span>
                    <span class="n">E</span> <span class="o">-=</span> <span class="n">energies_full</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">combos</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">E</span> <span class="o">+=</span> <span class="n">energies_mon</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">combos</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     </span><span class="si">%6d</span><span class="s"> </span><span class="si">%6d</span><span class="s"> </span><span class="si">%24.16E</span><span class="s"> </span><span class="si">%24.16E</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">physconst</span><span class="o">.</span><span class="n">psi_hartree2kcalmol</span> <span class="o">*</span> <span class="n">E</span><span class="p">))</span>
                <span class="n">En</span> <span class="o">+=</span> <span class="n">E</span>
            <span class="n">energies_n_bsse</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">En</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">Ns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">nn</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">nfragments</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="n">kk</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="n">energies_n_bsse</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">/=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">nn</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">nn</span> <span class="o">-</span> <span class="n">kk</span><span class="p">)))</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     </span><span class="si">%6d</span><span class="s"> </span><span class="si">%6s</span><span class="s"> </span><span class="si">%24.16E</span><span class="s"> </span><span class="si">%24.16E</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s">&#39;Total&#39;</span><span class="p">,</span> <span class="n">energies_n_bsse</span><span class="p">[</span><span class="n">n</span><span class="p">],</span>
               <span class="n">physconst</span><span class="o">.</span><span class="n">psi_hartree2kcalmol</span> <span class="o">*</span> <span class="n">energies_n_bsse</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;    ==&gt; N-Body Interaction Energy Analysis: Non-Additivities &lt;==</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;on&#39;</span> <span class="ow">or</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;both&#39;</span><span class="p">:</span>
        <span class="n">energies_n_full</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     =&gt; Full Basis Set Results &lt;=</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     </span><span class="si">%6s</span><span class="s"> </span><span class="si">%24s</span><span class="s"> </span><span class="si">%24s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;N-Body&quot;</span><span class="p">,</span> <span class="s">&quot;E [H]&quot;</span><span class="p">,</span> <span class="s">&quot;E [kcal mol^-1]&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Ns</span><span class="p">)):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">Ns</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">energies_n_full</span><span class="p">[</span><span class="n">Ns</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">-</span> <span class="n">energies_n_full</span><span class="p">[</span><span class="n">Ns</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     </span><span class="si">%6s</span><span class="s"> </span><span class="si">%24.16E</span><span class="s"> </span><span class="si">%24.16E</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">physconst</span><span class="o">.</span><span class="n">psi_hartree2kcalmol</span> <span class="o">*</span> <span class="n">E</span><span class="p">))</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;off&#39;</span> <span class="ow">or</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;both&#39;</span><span class="p">:</span>
        <span class="n">energies_n_mon</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     =&gt; Cluster Basis Set Results &lt;=</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     </span><span class="si">%6s</span><span class="s"> </span><span class="si">%24s</span><span class="s"> </span><span class="si">%24s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;N-Body&quot;</span><span class="p">,</span> <span class="s">&quot;E [H]&quot;</span><span class="p">,</span> <span class="s">&quot;E [kcal mol^-1]&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Ns</span><span class="p">)):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">Ns</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">energies_n_mon</span><span class="p">[</span><span class="n">Ns</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">-</span> <span class="n">energies_n_mon</span><span class="p">[</span><span class="n">Ns</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     </span><span class="si">%6s</span><span class="s"> </span><span class="si">%24.16E</span><span class="s"> </span><span class="si">%24.16E</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">physconst</span><span class="o">.</span><span class="n">psi_hartree2kcalmol</span> <span class="o">*</span> <span class="n">E</span><span class="p">))</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;both&#39;</span><span class="p">:</span>
        <span class="n">energies_n_bsse</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     =&gt; BSSE Results &lt;=</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     </span><span class="si">%6s</span><span class="s"> </span><span class="si">%24s</span><span class="s"> </span><span class="si">%24s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;N-Body&quot;</span><span class="p">,</span> <span class="s">&quot;Delta E [H]&quot;</span><span class="p">,</span> <span class="s">&quot;Delta E [kcal mol^-1]&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Ns</span><span class="p">)):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">Ns</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">energies_n_bsse</span><span class="p">[</span><span class="n">Ns</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">-</span> <span class="n">energies_n_bsse</span><span class="p">[</span><span class="n">Ns</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;     </span><span class="si">%6s</span><span class="s"> </span><span class="si">%24.16E</span><span class="s"> </span><span class="si">%24.16E</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">physconst</span><span class="o">.</span><span class="n">psi_hartree2kcalmol</span> <span class="o">*</span> <span class="n">E</span><span class="p">))</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="c"># Put everything back the way it was</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">,</span> <span class="n">ri_ints_io</span><span class="p">)</span>
    <span class="n">psioh</span><span class="o">.</span><span class="n">set_specific_retention</span><span class="p">(</span><span class="mi">97</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
    <span class="n">activate</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;on&#39;</span> <span class="ow">or</span> <span class="n">bsse</span> <span class="o">==</span> <span class="s">&#39;both&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">energies_n_full</span><span class="p">[</span><span class="n">Ns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">energies_n_mon</span><span class="p">[</span><span class="n">Ns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

<span class="c">##  Aliases  ##</span></div>
<span class="n">nbody</span> <span class="o">=</span> <span class="n">n_body</span>

<span class="c">#####################</span>
<span class="c">##  End of n_body  ##</span>
<span class="c">#####################</span>


<span class="c">###################</span>
<span class="c">##  Start of cp  ##</span>
<span class="c">###################</span>

<div class="viewcode-block" id="cp"><a class="viewcode-back" href="../index.html#wrappers.cp">[docs]</a><span class="k">def</span> <span class="nf">cp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The cp function computes counterpoise-corrected two-body interaction energies</span>
<span class="sd">    for complexes composed of arbitrary numbers of monomers.</span>

<span class="sd">    :aliases: counterpoise_correct(), counterpoise_correction()</span>

<span class="sd">    :returns: (*float*) Counterpoise-corrected interaction energy in kcal/mol</span>

<span class="sd">    :PSI variables:</span>

<span class="sd">    .. envvar:: CP-CORRECTED 2-BODY INTERACTION ENERGY</span>
<span class="sd">        UNCP-CORRECTED 2-BODY INTERACTION ENERGY</span>

<span class="sd">    .. caution:: Some features are not yet implemented. Buy a developer a coffee.</span>

<span class="sd">       - No values of func besides energy have been tested.</span>

<span class="sd">       - Table print-out needs improving. Add some PSI variables.</span>

<span class="sd">    :type name: string</span>
<span class="sd">    :param name: ``&#39;scf&#39;`` || ``&#39;ccsd(t)&#39;`` || etc.</span>

<span class="sd">        First argument, usually unlabeled. Indicates the computational method</span>
<span class="sd">        to be applied to the molecule. May be any valid argument to</span>
<span class="sd">        :py:func:`driver.energy`; however, SAPT is not appropriate.</span>

<span class="sd">    :type func: function</span>
<span class="sd">    :param func: |dl| ``energy`` |dr| || ``optimize`` || ``cbs``</span>

<span class="sd">        Indicates the type of calculation to be performed on the molecule</span>
<span class="sd">        and each of its monomers. The default performs a single-point</span>
<span class="sd">        ``energy(&#39;name&#39;)``, while ``optimize`` perfoms a geometry optimization</span>
<span class="sd">        on each system, and ``cbs`` performs a compound single-point energy.</span>
<span class="sd">        If a nested series of python functions is intended</span>
<span class="sd">        (see `Function Intercalls`_), use keyword ``cp_func`` instead of ``func``.</span>

<span class="sd">    :type check_bsse: bool</span>
<span class="sd">    :param check_bsse: ``&#39;on&#39;`` || |dl| ``&#39;off&#39;`` |dr|</span>

<span class="sd">        Indicates whether to additionally compute un-counterpoise corrected</span>
<span class="sd">        monomers and thus obtain an estimate for the basis set superposition error.</span>

<span class="sd">    :examples:</span>

<span class="sd">    &gt;&gt;&gt; # [1] counterpoise-corrected mp2 interaction energy</span>
<span class="sd">    &gt;&gt;&gt; cp(&#39;dfmp2&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c"># Wrap any positional arguments into kwargs (for intercalls among wrappers)</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="s">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c"># Establish function to call</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="s">&#39;cp_func&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;func&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;cp_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;func&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;func&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;cp_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;cp_func&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">func</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Function </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> does not exist to be called by wrapper counterpoise_correct.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="ow">is</span> <span class="n">db</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Wrapper counterpoise_correct is unhappy to be calling function </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>

    <span class="k">if</span> <span class="s">&#39;check_bsse&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="nb">input</span><span class="o">.</span><span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;check_bsse&#39;</span><span class="p">])):</span>
        <span class="n">check_bsse</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">check_bsse</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c"># Make sure the molecule the user provided is the active one</span>
    <span class="k">if</span> <span class="s">&#39;molecule&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">activate</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;molecule&#39;</span><span class="p">])</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;molecule&#39;</span><span class="p">]</span>
    <span class="n">molecule</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&quot;BASIS&quot;</span><span class="p">,</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&quot;BASIS&quot;</span><span class="p">))</span>

    <span class="n">df_ints_io</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">)</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">,</span> <span class="s">&#39;SAVE&#39;</span><span class="p">)</span>
    <span class="n">psioh</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">IOManager</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span>
    <span class="n">psioh</span><span class="o">.</span><span class="n">set_specific_retention</span><span class="p">(</span><span class="mi">97</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

    <span class="n">activate</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">banner</span><span class="p">(</span><span class="s">&quot;CP Computation: Complex.</span><span class="se">\n</span><span class="s">Full Basis Set.&quot;</span><span class="p">)</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">e_dimer</span> <span class="o">=</span> <span class="n">call_function_in_1st_argument</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c">#e_dimer = energy(name, **kwargs)</span>

    <span class="n">PsiMod</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">,</span> <span class="s">&#39;LOAD&#39;</span><span class="p">)</span>

    <span class="c"># All monomers with ghosts</span>
    <span class="n">monomers</span> <span class="o">=</span> <span class="n">extract_clusters</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">e_monomer_full</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">cluster_n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">monomers</span><span class="p">:</span>
        <span class="n">activate</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">banner</span><span class="p">((</span><span class="s">&quot;CP Computation: Monomer </span><span class="si">%d</span><span class="s">.</span><span class="se">\n</span><span class="s"> Full Basis Set.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cluster_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">e_monomer_full</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">call_function_in_1st_argument</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="c">#e_monomer_full.append(energy(name,**kwargs))</span>
        <span class="n">cluster_n</span> <span class="o">=</span> <span class="n">cluster_n</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>

    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">,</span> <span class="s">&#39;NONE&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">check_bsse</span><span class="p">):</span>
        <span class="c"># All monomers without ghosts</span>
        <span class="n">monomers</span> <span class="o">=</span> <span class="n">extract_clusters</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">e_monomer_bsse</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">cluster_n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">monomers</span><span class="p">:</span>
            <span class="n">activate</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="c">#cluster.print_to_output()</span>
            <span class="n">banner</span><span class="p">((</span><span class="s">&quot;CP Computation: Monomer </span><span class="si">%d</span><span class="s">.</span><span class="se">\n</span><span class="s"> Monomer Set.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cluster_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">e_monomer_bsse</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">call_function_in_1st_argument</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
            <span class="c">#e_monomer_bsse.append(energy(name,**kwargs))</span>
            <span class="n">cluster_n</span> <span class="o">=</span> <span class="n">cluster_n</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;DF_INTS_IO&#39;</span><span class="p">,</span> <span class="n">df_ints_io</span><span class="p">)</span>
    <span class="n">psioh</span><span class="o">.</span><span class="n">set_specific_retention</span><span class="p">(</span><span class="mi">97</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

    <span class="n">activate</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">check_bsse</span> <span class="o">==</span> <span class="bp">False</span><span class="p">):</span>
        <span class="n">cp_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;System:&quot;</span><span class="p">],</span> <span class="n">cols</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;Energy (full):&quot;</span><span class="p">])</span>
        <span class="n">cp_table</span><span class="p">[</span><span class="s">&quot;Complex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">e_dimer</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">cluster_n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">monomers</span><span class="p">)):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s">&quot;Monomer </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cluster_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">cp_table</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">e_monomer_full</span><span class="p">[</span><span class="n">cluster_n</span><span class="p">]]</span>

        <span class="n">e_full</span> <span class="o">=</span> <span class="n">e_dimer</span>
        <span class="k">for</span> <span class="n">cluster_n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">monomers</span><span class="p">)):</span>
            <span class="n">e_full</span> <span class="o">=</span> <span class="n">e_full</span> <span class="o">-</span> <span class="n">e_monomer_full</span><span class="p">[</span><span class="n">cluster_n</span><span class="p">]</span>
        <span class="n">cp_table</span><span class="p">[</span><span class="s">&quot;Interaction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">e_full</span><span class="p">]</span>

        <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&#39;CP-CORRECTED 2-BODY INTERACTION ENERGY&#39;</span><span class="p">,</span> <span class="n">e_full</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">cp_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;System:&quot;</span><span class="p">],</span> <span class="n">cols</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;Energy (full):&quot;</span><span class="p">,</span> <span class="s">&quot;Energy (monomer):&quot;</span><span class="p">,</span> <span class="s">&quot;BSSE:&quot;</span><span class="p">])</span>
        <span class="n">cp_table</span><span class="p">[</span><span class="s">&quot;Complex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">e_dimer</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">cluster_n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">monomers</span><span class="p">)):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s">&quot;Monomer </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cluster_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">cp_table</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">e_monomer_full</span><span class="p">[</span><span class="n">cluster_n</span><span class="p">],</span> <span class="n">e_monomer_bsse</span><span class="p">[</span><span class="n">cluster_n</span><span class="p">],</span> \
                <span class="n">e_monomer_full</span><span class="p">[</span><span class="n">cluster_n</span><span class="p">]</span> <span class="o">-</span> <span class="n">e_monomer_bsse</span><span class="p">[</span><span class="n">cluster_n</span><span class="p">]]</span>

        <span class="n">e_full</span> <span class="o">=</span> <span class="n">e_dimer</span>
        <span class="n">e_bsse</span> <span class="o">=</span> <span class="n">e_dimer</span>
        <span class="k">for</span> <span class="n">cluster_n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">monomers</span><span class="p">)):</span>
            <span class="n">e_full</span> <span class="o">=</span> <span class="n">e_full</span> <span class="o">-</span> <span class="n">e_monomer_full</span><span class="p">[</span><span class="n">cluster_n</span><span class="p">]</span>
            <span class="n">e_bsse</span> <span class="o">=</span> <span class="n">e_bsse</span> <span class="o">-</span> <span class="n">e_monomer_bsse</span><span class="p">[</span><span class="n">cluster_n</span><span class="p">]</span>
        <span class="n">cp_table</span><span class="p">[</span><span class="s">&quot;Totals:&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">e_full</span><span class="p">,</span> <span class="n">e_bsse</span><span class="p">,</span> <span class="n">e_full</span> <span class="o">-</span> <span class="n">e_bsse</span><span class="p">]</span>

        <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&#39;UNCP-CORRECTED 2-BODY INTERACTION ENERGY&#39;</span><span class="p">,</span> <span class="n">e_full</span><span class="p">)</span>

    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">banner</span><span class="p">(</span><span class="s">&quot;CP Computation: Results.&quot;</span><span class="p">)</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

    <span class="n">banner</span><span class="p">(</span><span class="s">&quot;Hartree&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cp_table</span><span class="p">))</span>

    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">banner</span><span class="p">(</span><span class="s">&quot;kcal*mol^-1&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

    <span class="n">cp_table</span><span class="o">.</span><span class="n">scale</span><span class="p">()</span>

    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cp_table</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">e_full</span>

<span class="c">##  Aliases  ##</span></div>
<span class="n">counterpoise_correct</span> <span class="o">=</span> <span class="n">cp</span>
<span class="n">counterpoise_correction</span> <span class="o">=</span> <span class="n">cp</span>

<span class="c">#################</span>
<span class="c">##  End of cp  ##</span>
<span class="c">#################</span>


<span class="c">#########################</span>
<span class="c">##  Start of Database  ##</span>
<span class="c">#########################</span>

<div class="viewcode-block" id="database"><a class="viewcode-back" href="../index.html#wrappers.database">[docs]</a><span class="k">def</span> <span class="nf">database</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">db_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to access the molecule objects and reference energies of</span>
<span class="sd">    popular chemical databases.</span>

<span class="sd">    :aliases: db()</span>

<span class="sd">    :returns: (*float*) Mean absolute deviation of the database in kcal/mol</span>

<span class="sd">    :PSI variables:</span>

<span class="sd">    .. envvar:: db_name DATABASE MEAN SIGNED DEVIATION</span>
<span class="sd">        db_name DATABASE MEAN ABSOLUTE DEVIATION</span>
<span class="sd">        db_name DATABASE ROOT-MEAN-SQUARE DEVIATION</span>

<span class="sd">    .. note:: It is very easy to make a database from a collection of xyz files</span>
<span class="sd">        using the script ``$PSIDATADIR/databases/ixyz2database.pl``.</span>
<span class="sd">        See `Creating a New Database`_ for details.</span>

<span class="sd">    .. caution:: Some features are not yet implemented. Buy a developer some coffee.</span>

<span class="sd">       - In sow/reap mode, use only global options (e.g., the local option set by ``set scf scf_type df`` will not be respected).</span>

<span class="sd">    :type name: string</span>
<span class="sd">    :param name: ``&#39;scf&#39;`` || ``&#39;sapt0&#39;`` || ``&#39;ccsd(t)&#39;`` || etc.</span>

<span class="sd">        First argument, usually unlabeled. Indicates the computational method</span>
<span class="sd">        to be applied to the database. May be any valid argument to</span>
<span class="sd">        :py:func:`driver.energy`.</span>

<span class="sd">    :type db_name: string</span>
<span class="sd">    :param db_name: ``&#39;BASIC&#39;`` || ``&#39;S22&#39;`` || ``&#39;HTBH&#39;`` || etc.</span>

<span class="sd">        Second argument, usually unlabeled. Indicates the requested database</span>
<span class="sd">        name, matching the name of a python file in ``psi4/lib/databases``.</span>
<span class="sd">        Consult that directory for available databases and literature citations.</span>

<span class="sd">    :type func: function</span>
<span class="sd">    :param func: |dl| ``energy`` |dr| || ``optimize`` || ``cbs``</span>

<span class="sd">        Indicates the type of calculation to be performed on each database</span>
<span class="sd">        member. The default performs a single-point ``energy(&#39;name&#39;)``, while</span>
<span class="sd">        ``optimize`` perfoms a geometry optimization on each reagent, and</span>
<span class="sd">        ``cbs`` performs a compound single-point energy. If a nested series</span>
<span class="sd">        of python functions is intended (see `Function Intercalls`_), use</span>
<span class="sd">        keyword ``db_func`` instead of ``func``.</span>

<span class="sd">    :type mode: string</span>
<span class="sd">    :param mode: |dl| ``&#39;continuous&#39;`` |dr| || ``&#39;sow&#39;`` || ``&#39;reap&#39;``</span>

<span class="sd">        Indicates whether the calculations required to complete the</span>
<span class="sd">        database are to be run in one file (``&#39;continuous&#39;``) or are to be</span>
<span class="sd">        farmed out in an embarrassingly parallel fashion</span>
<span class="sd">        (``&#39;sow&#39;``/``&#39;reap&#39;``).  For the latter, run an initial job with</span>
<span class="sd">        ``&#39;sow&#39;`` and follow instructions in its output file.</span>

<span class="sd">    :type cp: bool</span>
<span class="sd">    :param cp: ``&#39;on&#39;`` || |dl| ``&#39;off&#39;`` |dr|</span>

<span class="sd">        Indicates whether counterpoise correction is employed in computing</span>
<span class="sd">        interaction energies. Use this option and NOT the :py:func:`wrappers.cp`</span>
<span class="sd">        function for BSSE correction in database().  Option available</span>
<span class="sd">        (See `Available Databases`_) only for databases of bimolecular complexes.</span>

<span class="sd">    :type rlxd: bool</span>
<span class="sd">    :param rlxd: ``&#39;on&#39;`` || |dl| ``&#39;off&#39;`` |dr|</span>

<span class="sd">        Indicates whether correction for deformation energy is</span>
<span class="sd">        employed in computing interaction energies.  Option available</span>
<span class="sd">        (See `Available Databases`_) only for databases of bimolecular complexes </span>
<span class="sd">        with non-frozen monomers, e.g., HBC6.</span>

<span class="sd">    :type symm: bool</span>
<span class="sd">    :param symm: |dl| ``&#39;on&#39;`` |dr| || ``&#39;off&#39;``</span>

<span class="sd">        Indicates whether the native symmetry of the database reagents is</span>
<span class="sd">        employed (``&#39;on&#39;``) or whether it is forced to :math:`C_1` symmetry</span>
<span class="sd">        (``&#39;off&#39;``). Some computational methods (e.g., SAPT) require no</span>
<span class="sd">        symmetry, and this will be set by database().</span>

<span class="sd">    :type zpe: bool</span>
<span class="sd">    :param zpe: ``&#39;on&#39;`` || |dl| ``&#39;off&#39;`` |dr|</span>

<span class="sd">        Indicates whether zero-point-energy corrections are appended to</span>
<span class="sd">        single-point energy values. Option valid only for certain</span>
<span class="sd">        thermochemical databases. Disabled until Hessians ready.</span>

<span class="sd">    :type benchmark: string</span>
<span class="sd">    :param benchmark: |dl| ``&#39;default&#39;`` |dr| || ``&#39;S22A&#39;`` || etc.</span>

<span class="sd">        Indicates whether a non-default set of reference energies, if</span>
<span class="sd">        available (See `Available Databases`_), are employed for the</span>
<span class="sd">        calculation of error statistics.</span>

<span class="sd">    :type tabulate: array of strings</span>
<span class="sd">    :param tabulate: |dl| ``[]`` |dr| || ``[&#39;scf total energy&#39;, &#39;natom&#39;]`` || etc.</span>

<span class="sd">        Indicates whether to form tables of variables other than the</span>
<span class="sd">        primary requested energy.  Available for any PSI variable.</span>

<span class="sd">    :type subset: string or array of strings</span>
<span class="sd">    :param subset:</span>

<span class="sd">        Indicates a subset of the full database to run. This is a very</span>
<span class="sd">        flexible option and can be used in three distinct ways, outlined</span>
<span class="sd">        below. Note that two take a string and the last takes an array.</span>
<span class="sd">        See `Available Databases`_ for available values.</span>

<span class="sd">        * ``&#39;small&#39;`` || ``&#39;large&#39;`` || ``&#39;equilibrium&#39;``</span>
<span class="sd">            Calls predefined subsets of the requested database, either</span>
<span class="sd">            ``&#39;small&#39;``, a few of the smallest database members,</span>
<span class="sd">            ``&#39;large&#39;``, the largest of the database members, or</span>
<span class="sd">            ``&#39;equilibrium&#39;``, the equilibrium geometries for a database</span>
<span class="sd">            composed of dissociation curves.</span>
<span class="sd">        * ``&#39;BzBz_S&#39;`` || ``&#39;FaOOFaON&#39;`` || ``&#39;ArNe&#39;`` || etc.</span>
<span class="sd">            For databases composed of dissociation curves, individual</span>
<span class="sd">            curves can be called by name. Consult the database python</span>
<span class="sd">            files for available molecular systems.  The choices for this</span>
<span class="sd">            keyword are case sensitive and must match the database python file</span>
<span class="sd">        * ``[1,2,5]`` || ``[&#39;1&#39;,&#39;2&#39;,&#39;5&#39;]`` || ``[&#39;BzMe-3.5&#39;, &#39;MeMe-5.0&#39;]`` || etc.</span>
<span class="sd">            Specify a list of database members to run. Consult the</span>
<span class="sd">            database python files for available molecular systems.  The</span>
<span class="sd">            choices for this keyword are case sensitive and must match the</span>
<span class="sd">            database python file</span>

<span class="sd">    :examples:</span>

<span class="sd">    &gt;&gt;&gt; # [1] Two-stage SCF calculation on short, equilibrium, and long helium dimer</span>
<span class="sd">    &gt;&gt;&gt; db(&#39;scf&#39;,&#39;RGC10&#39;,cast_up=&#39;sto-3g&#39;,subset=[&#39;HeHe-0.85&#39;,&#39;HeHe-1.0&#39;,&#39;HeHe-1.5&#39;], tabulate=[&#39;scf total energy&#39;,&#39;natom&#39;])</span>

<span class="sd">    &gt;&gt;&gt; # [2] Counterpoise-corrected interaction energies for three complexes in S22</span>
<span class="sd">    &gt;&gt;&gt; #     Error statistics computed wrt an old benchmark, S22A</span>
<span class="sd">    &gt;&gt;&gt; database(&#39;dfmp2&#39;,&#39;S22&#39;,cp=1,subset=[16,17,8],benchmark=&#39;S22A&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [3] SAPT0 on the neon dimer dissociation curve</span>
<span class="sd">    &gt;&gt;&gt; db(&#39;sapt0&#39;,subset=&#39;NeNe&#39;,cp=0,symm=0,db_name=&#39;RGC10&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [4] Optimize system 1 in database S22, producing tables of scf and mp2 energy</span>
<span class="sd">    &gt;&gt;&gt; db(&#39;mp2&#39;,&#39;S22&#39;,db_func=optimize,subset=[1], tabulate=[&#39;mp2 total energy&#39;,&#39;current energy&#39;])</span>

<span class="sd">    &gt;&gt;&gt; # [5] CCSD on the smallest systems of HTBH, a hydrogen-transfer database</span>
<span class="sd">    &gt;&gt;&gt; database(&#39;ccsd&#39;,&#39;HTBH&#39;,subset=&#39;small&#39;, tabulate=[&#39;ccsd total energy&#39;, &#39;mp2 total energy&#39;])</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c">#hartree2kcalmol = 627.509469  # consistent with perl SETS scripts</span>

    <span class="c"># Wrap any positional arguments into kwargs (for intercalls among wrappers)</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="s">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="s">&#39;db_name&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">db_name</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;db_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db_name</span>

    <span class="c"># Establish function to call</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="s">&#39;db_func&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;func&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;db_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;func&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;func&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;db_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;db_func&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">func</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Function </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> does not exist to be called by wrapper database.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="ow">is</span> <span class="n">cp</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Wrapper database is unhappy to be calling function </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">. Use the cp keyword within database instead.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>

    <span class="c"># Define path and load module for requested database</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">databases&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">PsiMod</span><span class="o">.</span><span class="n">Process</span><span class="o">.</span><span class="n">environment</span><span class="p">[</span><span class="s">&quot;PSIDATADIR&quot;</span><span class="p">]))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">/lib/databases&#39;</span> <span class="o">%</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">psi_top_srcdir</span><span class="p">())</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Python module for database </span><span class="si">%s</span><span class="s"> failed to load</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_name</span><span class="p">))</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Search path that was tried:</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">)))</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&quot;Python module loading problem for database &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">db_name</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dbse</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">dbse</span>
        <span class="n">HRXN</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">HRXN</span>
        <span class="n">ACTV</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">ACTV</span>
        <span class="n">RXNM</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">RXNM</span>
        <span class="n">BIND</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">BIND</span>
        <span class="n">TAGL</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">TAGL</span>
        <span class="n">GEOS</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">GEOS</span>

    <span class="c"># Must collect (here) and set (below) basis sets after every new molecule activation</span>
    <span class="n">user_basis</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;BASIS&#39;</span><span class="p">)</span>
    <span class="n">user_df_basis_scf</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_SCF&#39;</span><span class="p">)</span>
    <span class="n">user_df_basis_mp2</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_MP2&#39;</span><span class="p">)</span>
    <span class="n">user_df_basis_cc</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_CC&#39;</span><span class="p">)</span>
    <span class="n">user_df_basis_sapt</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_SAPT&#39;</span><span class="p">)</span>
    <span class="n">user_df_basis_elst</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;DF_BASIS_ELST&#39;</span><span class="p">)</span>

    <span class="n">b_user_reference</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">has_global_option_changed</span><span class="p">(</span><span class="s">&#39;REFERENCE&#39;</span><span class="p">)</span>
    <span class="n">user_reference</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;REFERENCE&#39;</span><span class="p">)</span>
    <span class="n">user_memory</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_memory</span><span class="p">()</span>

    <span class="n">user_molecule</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span>

    <span class="c"># Configuration based upon e_name &amp; db_name options</span>
    <span class="c">#   Force non-supramolecular if needed</span>
    <span class="n">symmetry_override</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&#39;^sapt&#39;</span><span class="p">,</span> <span class="n">lowername</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">database</span><span class="o">.</span><span class="n">ACTV_SA</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Database </span><span class="si">%s</span><span class="s"> not suitable for non-supramolecular calculation.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">symmetry_override</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">ACTV</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">ACTV_SA</span>
    <span class="c">#   Force open-shell if needed</span>
    <span class="n">openshell_override</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">user_reference</span> <span class="o">==</span> <span class="s">&#39;RHF&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">user_reference</span> <span class="o">==</span> <span class="s">&#39;RKS&#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">database</span><span class="o">.</span><span class="n">isOS</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">database</span><span class="o">.</span><span class="n">isOS</span><span class="p">)):</span>
                <span class="n">openshell_override</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Some reagents in database </span><span class="si">%s</span><span class="s"> require an open-shell reference; will be reset to UHF/UKS as needed.</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_name</span><span class="p">))</span>

    <span class="c"># Configuration based upon database keyword options</span>
    <span class="c">#   Option symmetry- whether symmetry treated normally or turned off (currently req&#39;d for dfmp2 &amp; dft)</span>
    <span class="n">db_symm</span> <span class="o">=</span> <span class="s">&#39;yes&#39;</span>
    <span class="k">if</span> <span class="s">&#39;symm&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">db_symm</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;symm&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">no</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">db_symm</span><span class="p">)):</span>
        <span class="n">symmetry_override</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="nb">input</span><span class="o">.</span><span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">db_symm</span><span class="p">)):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Symmetry mode </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> not valid.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_symm</span><span class="p">))</span>

    <span class="c">#   Option mode of operation- whether db run in one job or files farmed out</span>
    <span class="c">#db_mode = &#39;continuous&#39;</span>
    <span class="c">#if(kwargs.has_key(&#39;mode&#39;)):</span>
    <span class="c">#    db_mode = kwargs[&#39;mode&#39;]</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="s">&#39;db_mode&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;mode&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;db_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;db_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;continuous&#39;</span>
    <span class="n">db_mode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;db_mode&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">db_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;continuous&#39;</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">db_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sow&#39;</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">db_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;reap&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;linkage&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">db_linkage</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;linkage&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Database execution mode </span><span class="se">\&#39;</span><span class="s">reap</span><span class="se">\&#39;</span><span class="s"> requires a linkage option.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Database execution mode </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> not valid.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_mode</span><span class="p">))</span>

    <span class="c">#   Option counterpoise- whether for interaction energy databases run in bsse-corrected or not</span>
    <span class="n">db_cp</span> <span class="o">=</span> <span class="s">&#39;no&#39;</span>
    <span class="k">if</span> <span class="s">&#39;cp&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">db_cp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;cp&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">db_cp</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">database</span><span class="o">.</span><span class="n">ACTV_CP</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Counterpoise correction mode </span><span class="se">\&#39;</span><span class="s">yes</span><span class="se">\&#39;</span><span class="s"> invalid for database </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ACTV</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">ACTV_CP</span>
    <span class="k">elif</span> <span class="nb">input</span><span class="o">.</span><span class="n">no</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">db_cp</span><span class="p">)):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Counterpoise correction mode </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> not valid.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_cp</span><span class="p">))</span>

    <span class="c">#   Option relaxed- whether for non-frozen-monomer interaction energy databases include deformation correction or not?</span>
    <span class="n">db_rlxd</span> <span class="o">=</span> <span class="s">&#39;no&#39;</span>
    <span class="k">if</span> <span class="s">&#39;rlxd&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">db_rlxd</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;rlxd&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">db_rlxd</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">db_cp</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">database</span><span class="o">.</span><span class="n">ACTV_CPRLX</span>
                <span class="n">database</span><span class="o">.</span><span class="n">RXNM_CPRLX</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Deformation and counterpoise correction mode </span><span class="se">\&#39;</span><span class="s">yes</span><span class="se">\&#39;</span><span class="s"> invalid for database </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ACTV</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">ACTV_CPRLX</span>
                <span class="n">RXNM</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">RXNM_CPRLX</span>
        <span class="k">elif</span> <span class="nb">input</span><span class="o">.</span><span class="n">no</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">db_cp</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">database</span><span class="o">.</span><span class="n">ACTV_RLX</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Deformation correction mode </span><span class="se">\&#39;</span><span class="s">yes</span><span class="se">\&#39;</span><span class="s"> invalid for database </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ACTV</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">ACTV_RLX</span>
    <span class="k">elif</span> <span class="nb">input</span><span class="o">.</span><span class="n">no</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">db_rlxd</span><span class="p">)):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Deformation correction mode </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> not valid.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_rlxd</span><span class="p">))</span>

    <span class="c">#   Option zero-point-correction- whether for thermochem databases jobs are corrected by zpe</span>
    <span class="n">db_zpe</span> <span class="o">=</span> <span class="s">&#39;no&#39;</span>
    <span class="k">if</span> <span class="s">&#39;zpe&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">db_zpe</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;zpe&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">yes</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">db_zpe</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Zero-point-correction mode </span><span class="se">\&#39;</span><span class="s">yes</span><span class="se">\&#39;</span><span class="s"> not yet implemented.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">input</span><span class="o">.</span><span class="n">no</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">db_zpe</span><span class="p">)):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Zero-point-correction </span><span class="se">\&#39;</span><span class="s">mode</span><span class="se">\&#39;</span><span class="s"> </span><span class="si">%s</span><span class="s"> not valid.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_zpe</span><span class="p">))</span>

    <span class="c">#   Option benchmark- whether error statistics computed wrt alternate reference energies</span>
    <span class="n">db_benchmark</span> <span class="o">=</span> <span class="s">&#39;default&#39;</span>
    <span class="k">if</span> <span class="s">&#39;benchmark&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">db_benchmark</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;benchmark&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">db_benchmark</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;default&#39;</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="s">&#39;BIND_&#39;</span> <span class="o">+</span> <span class="n">db_benchmark</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Special benchmark </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> not available for database </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_benchmark</span><span class="p">,</span> <span class="n">db_name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">BIND</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="s">&#39;BIND_&#39;</span> <span class="o">+</span> <span class="n">db_benchmark</span><span class="p">)</span>

    <span class="c">#   Option tabulate- whether tables of variables other than primary energy method are formed</span>
    <span class="n">db_tabulate</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s">&#39;tabulate&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">db_tabulate</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;tabulate&#39;</span><span class="p">]</span>

    <span class="c">#   Option subset- whether all of the database or just a portion is run</span>
    <span class="n">db_subset</span> <span class="o">=</span> <span class="n">HRXN</span>
    <span class="k">if</span> <span class="s">&#39;subset&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">db_subset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;subset&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">db_subset</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">db_subset</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;small&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">database</span><span class="o">.</span><span class="n">HRXN_SM</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Special subset </span><span class="se">\&#39;</span><span class="s">small</span><span class="se">\&#39;</span><span class="s"> not available for database </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">HRXN</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">HRXN_SM</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">db_subset</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;large&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">database</span><span class="o">.</span><span class="n">HRXN_LG</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Special subset </span><span class="se">\&#39;</span><span class="s">large</span><span class="se">\&#39;</span><span class="s"> not available for database </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">HRXN</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">HRXN_LG</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">db_subset</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;equilibrium&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">database</span><span class="o">.</span><span class="n">HRXN_EQ</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Special subset </span><span class="se">\&#39;</span><span class="s">equilibrium</span><span class="se">\&#39;</span><span class="s"> not available for database </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">HRXN</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">HRXN_EQ</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">db_subset</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Special subset </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> not available for database </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_subset</span><span class="p">,</span> <span class="n">db_name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">HRXN</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">db_subset</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">db_subset</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">HRXN</span><span class="p">:</span>
                <span class="n">temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rxn</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Subset element </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> not a member of database </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rxn</span><span class="p">),</span> <span class="n">db_name</span><span class="p">))</span>
        <span class="n">HRXN</span> <span class="o">=</span> <span class="n">temp</span>

    <span class="n">temp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">HRXN</span><span class="p">:</span>
        <span class="n">temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ACTV</span><span class="p">[</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dbse</span><span class="p">,</span> <span class="n">rxn</span><span class="p">)])</span>
    <span class="n">HSYS</span> <span class="o">=</span> <span class="n">drop_duplicates</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="p">[]))</span>

    <span class="c"># Sow all the necessary reagent computations</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">banner</span><span class="p">((</span><span class="s">&quot;Database </span><span class="si">%s</span><span class="s"> Computation&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_name</span><span class="p">)))</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

    <span class="c">#   write index of calcs to output file</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">db_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;continuous&#39;</span><span class="p">):</span>
        <span class="n">instructions</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">    The database single-job procedure has been selected through mode=&#39;continuous&#39;.</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
        <span class="n">instructions</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;    Calculations for the reagents will proceed in the order below and will be followed</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
        <span class="n">instructions</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;    by summary results for the database.</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">rgt</span> <span class="ow">in</span> <span class="n">HSYS</span><span class="p">:</span>
            <span class="n">instructions</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;                    </span><span class="si">%-s</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rgt</span><span class="p">)</span>
        <span class="n">instructions</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">    Alternatively, a farming-out of the database calculations may be accessed through</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
        <span class="n">instructions</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;    the database wrapper option mode=&#39;sow&#39;/&#39;reap&#39;.</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>

    <span class="c">#   write sow/reap instructions and index of calcs to output file and reap input file</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">db_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sow&#39;</span><span class="p">):</span>
        <span class="n">instructions</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">    The database sow/reap procedure has been selected through mode=&#39;sow&#39;. In addition</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
        <span class="n">instructions</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;    to this output file (which contains no quantum chemical calculations), this job</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
        <span class="n">instructions</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;    has produced a number of input files (</span><span class="si">%s</span><span class="s">-*.in) for individual database members</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dbse</span><span class="p">)</span>
        <span class="n">instructions</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;    and a single input file (</span><span class="si">%s</span><span class="s">-master.in) with a database(mode=&#39;reap&#39;) command.</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dbse</span><span class="p">)</span>
        <span class="n">instructions</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;    The former may look very peculiar since processed and pickled python rather than</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
        <span class="n">instructions</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;    raw input is written. Follow the instructions below to continue.</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span>
        <span class="n">instructions</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;    (1)  Run all of the </span><span class="si">%s</span><span class="s">-*.in input files on any variety of computer architecture.</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dbse</span><span class="p">)</span>
        <span class="n">instructions</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;       The output file names must be as given below.</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">rgt</span> <span class="ow">in</span> <span class="n">HSYS</span><span class="p">:</span>
            <span class="n">instructions</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;             psi4 -i </span><span class="si">%-27s</span><span class="s"> -o </span><span class="si">%-27s</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rgt</span> <span class="o">+</span> <span class="s">&#39;.in&#39;</span><span class="p">,</span> <span class="n">rgt</span> <span class="o">+</span> <span class="s">&#39;.out&#39;</span><span class="p">)</span>
        <span class="n">instructions</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">    (2)  Gather all the resulting output files in a directory. Place input file</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
        <span class="n">instructions</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;         </span><span class="si">%s</span><span class="s">-master.in into that directory and run it. The job will be trivial in</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dbse</span><span class="p">)</span>
        <span class="n">instructions</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;         length and give summary results for the database in its output file.</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span>
        <span class="n">instructions</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;             psi4 -i </span><span class="si">%-27s</span><span class="s"> -o </span><span class="si">%-27s</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dbse</span> <span class="o">+</span> <span class="s">&#39;-master.in&#39;</span><span class="p">,</span> <span class="n">dbse</span> <span class="o">+</span> <span class="s">&#39;-master.out&#39;</span><span class="p">)</span>
        <span class="n">instructions</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;    Alternatively, a single-job execution of the database may be accessed through</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
        <span class="n">instructions</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;    the database wrapper option mode=&#39;continuous&#39;.</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>

        <span class="n">fmaster</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">-master.in&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dbse</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;# This is a psi4 input file auto-generated from the database() wrapper.</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">fmaster</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;database(&#39;</span><span class="si">%s</span><span class="s">&#39;, &#39;</span><span class="si">%s</span><span class="s">&#39;, mode=&#39;reap&#39;, cp=&#39;</span><span class="si">%s</span><span class="s">&#39;, rlxd=&#39;</span><span class="si">%s</span><span class="s">&#39;, zpe=&#39;</span><span class="si">%s</span><span class="s">&#39;, benchmark=&#39;</span><span class="si">%s</span><span class="s">&#39;, linkage=</span><span class="si">%d</span><span class="s">, subset=</span><span class="si">%s</span><span class="s">, tabulate=</span><span class="si">%s</span><span class="s">)</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">db_name</span><span class="p">,</span> <span class="n">db_cp</span><span class="p">,</span> <span class="n">db_rlxd</span><span class="p">,</span> <span class="n">db_zpe</span><span class="p">,</span> <span class="n">db_benchmark</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">HRXN</span><span class="p">,</span> <span class="n">db_tabulate</span><span class="p">))</span>
        <span class="n">fmaster</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c">#   Loop through chemical systems</span>
    <span class="n">ERGT</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ERXN</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">VRGT</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">VRXN</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">rgt</span> <span class="ow">in</span> <span class="n">HSYS</span><span class="p">:</span>
        <span class="n">VRGT</span><span class="p">[</span><span class="n">rgt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># extra definition of molecule so that logic in building commands string has something to act on</span>
        <span class="k">exec</span> <span class="n">GEOS</span><span class="p">[</span><span class="n">rgt</span><span class="p">]</span>
        <span class="n">molecule</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span>

        <span class="c"># build string of title banner</span>
        <span class="n">banners</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">banners</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;PsiMod.print_out(&#39;</span><span class="se">\\</span><span class="s">n&#39;)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
        <span class="n">banners</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;banner(&#39; Database </span><span class="si">%s</span><span class="s"> Computation: Reagent </span><span class="si">%s</span><span class="s"> </span><span class="se">\\</span><span class="s">n   </span><span class="si">%s</span><span class="s">&#39;)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">rgt</span><span class="p">,</span> <span class="n">TAGL</span><span class="p">[</span><span class="n">rgt</span><span class="p">])</span>
        <span class="n">banners</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;PsiMod.print_out(&#39;</span><span class="se">\\</span><span class="s">n&#39;)</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span>

        <span class="c"># build string of lines that defines contribution of rgt to each rxn</span>
        <span class="n">actives</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">actives</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;PsiMod.print_out(&#39;   Database Contributions Map:</span><span class="se">\\</span><span class="s">n   </span><span class="si">%s</span><span class="se">\\</span><span class="s">n&#39;)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">75</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">HRXN</span><span class="p">:</span>
            <span class="n">db_rxn</span> <span class="o">=</span> <span class="n">dbse</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rxn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rgt</span> <span class="ow">in</span> <span class="n">ACTV</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">]:</span>
                <span class="n">actives</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;PsiMod.print_out(&#39;   reagent </span><span class="si">%s</span><span class="s"> contributes by </span><span class="si">%.4f</span><span class="s"> to reaction </span><span class="si">%s</span><span class="se">\\</span><span class="s">n&#39;)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> \
                   <span class="o">%</span> <span class="p">(</span><span class="n">rgt</span><span class="p">,</span> <span class="n">RXNM</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">][</span><span class="n">rgt</span><span class="p">],</span> <span class="n">db_rxn</span><span class="p">)</span>
        <span class="n">actives</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;PsiMod.print_out(&#39;</span><span class="se">\\</span><span class="s">n&#39;)</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span>

        <span class="c"># build string of commands for options from the input file  TODO: handle local options too</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">commands</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">PsiMod.set_memory(</span><span class="si">%s</span><span class="s">)</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user_memory</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">chgdopt</span> <span class="ow">in</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_global_option_list</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">has_option_changed</span><span class="p">(</span><span class="n">chgdopt</span><span class="p">):</span>
                <span class="n">chgdoptval</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="n">chgdopt</span><span class="p">)</span>
                <span class="c">#chgdoptval = PsiMod.get_option(chgdopt)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chgdoptval</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                    <span class="n">commands</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;PsiMod.set_global_option(&#39;</span><span class="si">%s</span><span class="s">&#39;, &#39;</span><span class="si">%s</span><span class="s">&#39;)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">chgdopt</span><span class="p">,</span> <span class="n">chgdoptval</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chgdoptval</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chgdoptval</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                    <span class="n">commands</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;PsiMod.set_global_option(&#39;</span><span class="si">%s</span><span class="s">&#39;, </span><span class="si">%s</span><span class="s">)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">chgdopt</span><span class="p">,</span> <span class="n">chgdoptval</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Option </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> is not of a type (string, int, float, bool) that can be processed by database wrapper.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">chgdopt</span><span class="p">))</span>

        <span class="c"># build string of molecule and commands that are dependent on the database</span>
        <span class="n">commands</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">commands</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;PsiMod.set_global_option(&#39;BASIS&#39;, &#39;</span><span class="si">%s</span><span class="s">&#39;)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user_basis</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">((</span><span class="n">user_df_basis_scf</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">user_df_basis_scf</span> <span class="o">==</span> <span class="s">&#39;NONE&#39;</span><span class="p">)):</span>
            <span class="n">commands</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;PsiMod.set_global_option(&#39;DF_BASIS_SCF&#39;, &#39;</span><span class="si">%s</span><span class="s">&#39;)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user_df_basis_scf</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">((</span><span class="n">user_df_basis_mp2</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">user_df_basis_mp2</span> <span class="o">==</span> <span class="s">&#39;NONE&#39;</span><span class="p">)):</span>
            <span class="n">commands</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;PsiMod.set_global_option(&#39;DF_BASIS_MP2&#39;, &#39;</span><span class="si">%s</span><span class="s">&#39;)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user_df_basis_mp2</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">((</span><span class="n">user_df_basis_cc</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">user_df_basis_cc</span> <span class="o">==</span> <span class="s">&#39;NONE&#39;</span><span class="p">)):</span>
            <span class="n">commands</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;PsiMod.set_global_option(&#39;DF_BASIS_CC&#39;, &#39;</span><span class="si">%s</span><span class="s">&#39;)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user_df_basis_cc</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">((</span><span class="n">user_df_basis_sapt</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">user_df_basis_sapt</span> <span class="o">==</span> <span class="s">&#39;NONE&#39;</span><span class="p">)):</span>
            <span class="n">commands</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;PsiMod.set_global_option(&#39;DF_BASIS_SAPT&#39;, &#39;</span><span class="si">%s</span><span class="s">&#39;)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user_df_basis_sapt</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">((</span><span class="n">user_df_basis_elst</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">user_df_basis_elst</span> <span class="o">==</span> <span class="s">&#39;NONE&#39;</span><span class="p">)):</span>
            <span class="n">commands</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;PsiMod.set_global_option(&#39;DF_BASIS_ELST&#39;, &#39;</span><span class="si">%s</span><span class="s">&#39;)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user_df_basis_elst</span><span class="p">)</span>
        <span class="n">commands</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;molecule = PsiMod.get_active_molecule()</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
        <span class="n">commands</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;molecule.update_geometry()</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">symmetry_override</span><span class="p">:</span>
            <span class="n">commands</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;molecule.reset_point_group(&#39;c1&#39;)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
            <span class="n">commands</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;molecule.fix_orientation(1)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
            <span class="n">commands</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;molecule.update_geometry()</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">openshell_override</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">user_reference</span> <span class="o">==</span> <span class="s">&#39;RHF&#39;</span><span class="p">:</span>
                <span class="n">commands</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;PsiMod.set_global_option(&#39;REFERENCE&#39;, &#39;UHF&#39;)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
            <span class="k">elif</span> <span class="n">user_reference</span> <span class="o">==</span> <span class="s">&#39;RKS&#39;</span><span class="p">:</span>
                <span class="n">commands</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;PsiMod.set_global_option(&#39;REFERENCE&#39;, &#39;UKS&#39;)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>

        <span class="c"># all modes need to step through the reagents but all for different purposes</span>
        <span class="c"># continuous: defines necessary commands, executes energy(method) call, and collects results into dictionary</span>
        <span class="c"># sow: opens individual reagent input file, writes the necessary commands, and writes energy(method) call</span>
        <span class="c"># reap: opens individual reagent output file, collects results into a dictionary</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">db_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;continuous&#39;</span><span class="p">):</span>
            <span class="k">exec</span> <span class="n">banners</span>
            <span class="k">exec</span> <span class="n">GEOS</span><span class="p">[</span><span class="n">rgt</span><span class="p">]</span>
            <span class="k">exec</span> <span class="n">commands</span>
            <span class="c">#print &#39;MOLECULE LIVES %23s %8s %4d %4d %4s&#39; % (rgt, PsiMod.get_option(&#39;REFERENCE&#39;),</span>
            <span class="c">#    molecule.molecular_charge(), molecule.multiplicity(), molecule.schoenflies_symbol())</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&#39;NATOM&#39;</span><span class="p">,</span> <span class="n">molecule</span><span class="o">.</span><span class="n">natom</span><span class="p">())</span>
            <span class="n">ERGT</span><span class="p">[</span><span class="n">rgt</span><span class="p">]</span> <span class="o">=</span> <span class="n">call_function_in_1st_argument</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c">#print ERGT[rgt]</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_variables</span><span class="p">()</span>
            <span class="k">exec</span> <span class="n">actives</span>
            <span class="k">for</span> <span class="n">envv</span> <span class="ow">in</span> <span class="n">db_tabulate</span><span class="p">:</span>
                <span class="n">VRGT</span><span class="p">[</span><span class="n">rgt</span><span class="p">][</span><span class="n">envv</span><span class="p">]</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">envv</span><span class="p">)</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&quot;REFERENCE&quot;</span><span class="p">,</span> <span class="n">user_reference</span><span class="p">)</span>
            <span class="n">PsiMod</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">db_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sow&#39;</span><span class="p">):</span>
            <span class="n">freagent</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.in&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rgt</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;# This is a psi4 input file auto-generated from the database() wrapper.</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">banners</span><span class="p">)</span>
            <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">GEOS</span><span class="p">[</span><span class="n">rgt</span><span class="p">])</span>
            <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
            <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\n</span><span class="s">pickle_kw = (&quot;&quot;&quot;&#39;&#39;&#39;</span><span class="p">)</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">freagent</span><span class="p">)</span>
            <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&quot;&quot;&quot;)</span><span class="se">\n</span><span class="s">&#39;&#39;&#39;</span><span class="p">)</span>
            <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">kwargs = pickle.loads(pickle_kw)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;electronic_energy = </span><span class="si">%s</span><span class="s">(**kwargs)</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
            <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;PsiMod.print_variables()</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;PsiMod.print_out(&#39;</span><span class="se">\\</span><span class="s">nDATABASE RESULT: computation </span><span class="si">%d</span><span class="s"> for reagent </span><span class="si">%s</span><span class="s"> &quot;&quot;&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">rgt</span><span class="p">))</span>
            <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;yields electronic energy </span><span class="si">%20.12f</span><span class="se">\\</span><span class="s">n&#39; % (electronic_energy))</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;PsiMod.set_variable(&#39;NATOM&#39;, molecule.natom())</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">envv</span> <span class="ow">in</span> <span class="n">db_tabulate</span><span class="p">:</span>
                <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;PsiMod.print_out(&#39;DATABASE RESULT: computation </span><span class="si">%d</span><span class="s"> for reagent </span><span class="si">%s</span><span class="s"> &quot;&quot;&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">rgt</span><span class="p">))</span>
                <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;yields variable value    </span><span class="si">%20.12f</span><span class="s"> for variable </span><span class="si">%s</span><span class="se">\\</span><span class="s">n&#39; % (PsiMod.get_variable(&quot;&quot;&quot;</span><span class="p">)</span>
                <span class="n">freagent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;&#39;</span><span class="si">%s</span><span class="s">&#39;), &#39;</span><span class="si">%s</span><span class="s">&#39;))</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">envv</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">envv</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
            <span class="n">freagent</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">db_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;reap&#39;</span><span class="p">):</span>
            <span class="n">ERGT</span><span class="p">[</span><span class="n">rgt</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">envv</span> <span class="ow">in</span> <span class="n">db_tabulate</span><span class="p">:</span>
                <span class="n">VRGT</span><span class="p">[</span><span class="n">rgt</span><span class="p">][</span><span class="n">envv</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">exec</span> <span class="n">banners</span>
            <span class="k">exec</span> <span class="n">actives</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">freagent</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.out&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rgt</span><span class="p">),</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;Warning: Output file </span><span class="se">\&#39;</span><span class="si">%s</span><span class="s">.out</span><span class="se">\&#39;</span><span class="s"> not found.</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rgt</span><span class="p">))</span>
                <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;         Database summary will have 0.0 and **** in its place.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">freagent</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ERGT</span><span class="p">[</span><span class="n">rgt</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                            <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;Warning: Output file </span><span class="se">\&#39;</span><span class="si">%s</span><span class="s">.out</span><span class="se">\&#39;</span><span class="s"> has no DATABASE RESULT line.</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rgt</span><span class="p">))</span>
                            <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;         Database summary will have 0.0 and **** in its place.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s">&#39;DATABASE&#39;</span><span class="p">,</span> <span class="s">&#39;RESULT:&#39;</span><span class="p">,</span> <span class="s">&#39;computation&#39;</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">!=</span> <span class="n">db_linkage</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Output file </span><span class="se">\&#39;</span><span class="si">%s</span><span class="s">.out</span><span class="se">\&#39;</span><span class="s"> has linkage </span><span class="si">%s</span><span class="s"> incompatible with master.in linkage </span><span class="si">%s</span><span class="s">.&#39;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="n">rgt</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">db_linkage</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">!=</span> <span class="n">rgt</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Output file </span><span class="se">\&#39;</span><span class="si">%s</span><span class="s">.out</span><span class="se">\&#39;</span><span class="s"> has nominal affiliation </span><span class="si">%s</span><span class="s"> incompatible with reagent </span><span class="si">%s</span><span class="s">.&#39;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="n">rgt</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">rgt</span><span class="p">))</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s">&#39;electronic&#39;</span><span class="p">,</span> <span class="s">&#39;energy&#39;</span><span class="p">]):</span>
                            <span class="n">ERGT</span><span class="p">[</span><span class="n">rgt</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
                            <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;DATABASE RESULT: electronic energy = </span><span class="si">%20.12f</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ERGT</span><span class="p">[</span><span class="n">rgt</span><span class="p">]))</span>
                        <span class="k">elif</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s">&#39;variable&#39;</span><span class="p">,</span> <span class="s">&#39;value&#39;</span><span class="p">]):</span>
                            <span class="k">for</span> <span class="n">envv</span> <span class="ow">in</span> <span class="n">db_tabulate</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">13</span><span class="p">:]</span> <span class="o">==</span> <span class="n">envv</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()):</span>
                                    <span class="n">VRGT</span><span class="p">[</span><span class="n">rgt</span><span class="p">][</span><span class="n">envv</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
                                    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&#39;DATABASE RESULT: variable </span><span class="si">%s</span><span class="s"> value    = </span><span class="si">%20.12f</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">envv</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">VRGT</span><span class="p">[</span><span class="n">rgt</span><span class="p">][</span><span class="n">envv</span><span class="p">]))</span>
                <span class="n">freagent</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c">#   end sow after writing files</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">db_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;sow&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="c"># Reap all the necessary reaction computations</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">banner</span><span class="p">((</span><span class="s">&quot;Database </span><span class="si">%s</span><span class="s"> Results&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_name</span><span class="p">)))</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

    <span class="n">maxactv</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">HRXN</span><span class="p">:</span>
        <span class="n">maxactv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ACTV</span><span class="p">[</span><span class="n">dbse</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rxn</span><span class="p">)]))</span>
    <span class="n">maxrgt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxactv</span><span class="p">)</span>
    <span class="n">table_delimit</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">54</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">maxrgt</span><span class="p">)</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="c">#   find any reactions that are incomplete</span>
    <span class="n">FAIL</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">HRXN</span><span class="p">:</span>
        <span class="n">db_rxn</span> <span class="o">=</span> <span class="n">dbse</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rxn</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ACTV</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">])):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ERGT</span><span class="p">[</span><span class="n">ACTV</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">][</span><span class="n">i</span><span class="p">]])</span> <span class="o">&lt;</span> <span class="mf">1.0e-12</span><span class="p">:</span>
                <span class="n">FAIL</span><span class="p">[</span><span class="n">rxn</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c">#   tabulate requested process::environment variables</span>
    <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   For each VARIABLE requested by tabulate, a &#39;Reaction Value&#39; will be formed from</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
    <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   &#39;Reagent&#39; values according to weightings &#39;Wt&#39;, as for the REQUESTED ENERGY below.</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
    <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   Depending on the nature of the variable, this may or may not make any physical sense.</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">envv</span> <span class="ow">in</span> <span class="n">db_tabulate</span><span class="p">:</span>
        <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">   ==&gt; </span><span class="si">%s</span><span class="s"> &lt;==</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">envv</span><span class="o">.</span><span class="n">title</span><span class="p">())</span>
        <span class="n">tables</span> <span class="o">+=</span> <span class="n">tblhead</span><span class="p">(</span><span class="n">maxrgt</span><span class="p">,</span> <span class="n">table_delimit</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">HRXN</span><span class="p">:</span>
            <span class="n">db_rxn</span> <span class="o">=</span> <span class="n">dbse</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rxn</span><span class="p">)</span>
            <span class="n">VRXN</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="n">FAIL</span><span class="p">[</span><span class="n">rxn</span><span class="p">]:</span>
                <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="si">%23s</span><span class="s">   </span><span class="si">%8s</span><span class="s"> </span><span class="si">%8s</span><span class="s">   </span><span class="si">%8s</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_rxn</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;****&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ACTV</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">])):</span>
                    <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot; </span><span class="si">%16.8f</span><span class="s"> </span><span class="si">%2.0f</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">VRGT</span><span class="p">[</span><span class="n">ACTV</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">][</span><span class="n">i</span><span class="p">]][</span><span class="n">envv</span><span class="p">],</span> <span class="n">RXNM</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">][</span><span class="n">ACTV</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">][</span><span class="n">i</span><span class="p">]])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">VRXN</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">][</span><span class="n">envv</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ACTV</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">])):</span>
                    <span class="n">VRXN</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">][</span><span class="n">envv</span><span class="p">]</span> <span class="o">+=</span> <span class="n">VRGT</span><span class="p">[</span><span class="n">ACTV</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">][</span><span class="n">i</span><span class="p">]][</span><span class="n">envv</span><span class="p">]</span> <span class="o">*</span> <span class="n">RXNM</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">][</span><span class="n">ACTV</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>

                <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="si">%23s</span><span class="s">        </span><span class="si">%16.8f</span><span class="s">       &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_rxn</span><span class="p">,</span> <span class="n">VRXN</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">][</span><span class="n">envv</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ACTV</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">])):</span>
                    <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot; </span><span class="si">%16.8f</span><span class="s"> </span><span class="si">%2.0f</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">VRGT</span><span class="p">[</span><span class="n">ACTV</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">][</span><span class="n">i</span><span class="p">]][</span><span class="n">envv</span><span class="p">],</span> <span class="n">RXNM</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">][</span><span class="n">ACTV</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">][</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">   </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table_delimit</span><span class="p">)</span>

    <span class="c">#   tabulate primary requested energy variable with statistics</span>
    <span class="n">count_rxn</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">minDerror</span> <span class="o">=</span> <span class="mf">100000.0</span>
    <span class="n">maxDerror</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">MSDerror</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">MADerror</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">RMSDerror</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">   ==&gt; </span><span class="si">%s</span><span class="s"> &lt;==</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Requested Energy&#39;</span><span class="p">)</span>
    <span class="n">tables</span> <span class="o">+=</span> <span class="n">tblhead</span><span class="p">(</span><span class="n">maxrgt</span><span class="p">,</span> <span class="n">table_delimit</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">HRXN</span><span class="p">:</span>
        <span class="n">db_rxn</span> <span class="o">=</span> <span class="n">dbse</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rxn</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">FAIL</span><span class="p">[</span><span class="n">rxn</span><span class="p">]:</span>
            <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="si">%23s</span><span class="s">   </span><span class="si">%8.4f</span><span class="s"> </span><span class="si">%8s</span><span class="s">   </span><span class="si">%8s</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_rxn</span><span class="p">,</span> <span class="n">BIND</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">],</span> <span class="s">&#39;****&#39;</span><span class="p">,</span> <span class="s">&#39;****&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ACTV</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">])):</span>
                <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot; </span><span class="si">%16.8f</span><span class="s"> </span><span class="si">%2.0f</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ERGT</span><span class="p">[</span><span class="n">ACTV</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">][</span><span class="n">i</span><span class="p">]],</span> <span class="n">RXNM</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">][</span><span class="n">ACTV</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">][</span><span class="n">i</span><span class="p">]])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ERXN</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ACTV</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">])):</span>
                <span class="n">ERXN</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ERGT</span><span class="p">[</span><span class="n">ACTV</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="o">*</span> <span class="n">RXNM</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">][</span><span class="n">ACTV</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">physconst</span><span class="o">.</span><span class="n">psi_hartree2kcalmol</span> <span class="o">*</span> <span class="n">ERXN</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">]</span> <span class="o">-</span> <span class="n">BIND</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">]</span>

            <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="si">%23s</span><span class="s">   </span><span class="si">%8.4f</span><span class="s"> </span><span class="si">%8.4f</span><span class="s">   </span><span class="si">%8.4f</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_rxn</span><span class="p">,</span> <span class="n">BIND</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">],</span> <span class="n">physconst</span><span class="o">.</span><span class="n">psi_hartree2kcalmol</span> <span class="o">*</span> <span class="n">ERXN</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">],</span> <span class="n">error</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ACTV</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">])):</span>
                <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot; </span><span class="si">%16.8f</span><span class="s"> </span><span class="si">%2.0f</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ERGT</span><span class="p">[</span><span class="n">ACTV</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">][</span><span class="n">i</span><span class="p">]],</span> <span class="n">RXNM</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">][</span><span class="n">ACTV</span><span class="p">[</span><span class="n">db_rxn</span><span class="p">][</span><span class="n">i</span><span class="p">]])</span>

            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">minDerror</span><span class="p">):</span>
                <span class="n">minDerror</span> <span class="o">=</span> <span class="n">error</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">maxDerror</span><span class="p">):</span>
                <span class="n">maxDerror</span> <span class="o">=</span> <span class="n">error</span>
            <span class="n">MSDerror</span> <span class="o">+=</span> <span class="n">error</span>
            <span class="n">MADerror</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="n">RMSDerror</span> <span class="o">+=</span> <span class="n">error</span> <span class="o">*</span> <span class="n">error</span>
            <span class="n">count_rxn</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">   </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table_delimit</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">count_rxn</span><span class="p">:</span>

        <span class="n">MSDerror</span> <span class="o">/=</span> <span class="nb">float</span><span class="p">(</span><span class="n">count_rxn</span><span class="p">)</span>
        <span class="n">MADerror</span> <span class="o">/=</span> <span class="nb">float</span><span class="p">(</span><span class="n">count_rxn</span><span class="p">)</span>
        <span class="n">RMSDerror</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">RMSDerror</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">count_rxn</span><span class="p">))</span>

        <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="si">%23s</span><span class="s">   </span><span class="si">%19s</span><span class="s"> </span><span class="si">%8.4f</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Minimal Dev&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">minDerror</span><span class="p">)</span>
        <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="si">%23s</span><span class="s">   </span><span class="si">%19s</span><span class="s"> </span><span class="si">%8.4f</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Maximal Dev&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">maxDerror</span><span class="p">)</span>
        <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="si">%23s</span><span class="s">   </span><span class="si">%19s</span><span class="s"> </span><span class="si">%8.4f</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Mean Signed Dev&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">MSDerror</span><span class="p">)</span>
        <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="si">%23s</span><span class="s">   </span><span class="si">%19s</span><span class="s"> </span><span class="si">%8.4f</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Mean Absolute Dev&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">MADerror</span><span class="p">)</span>
        <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="si">%23s</span><span class="s">   </span><span class="si">%19s</span><span class="s"> </span><span class="si">%8.4f</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;RMS Dev&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">RMSDerror</span><span class="p">)</span>
        <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table_delimit</span><span class="p">)</span>

        <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> DATABASE MEAN SIGNED DEVIATION&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_name</span><span class="p">),</span> <span class="n">MSDerror</span><span class="p">)</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> DATABASE MEAN ABSOLUTE DEVIATION&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_name</span><span class="p">),</span> <span class="n">MADerror</span><span class="p">)</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> DATABASE ROOT-MEAN-SQUARE DEVIATION&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">db_name</span><span class="p">),</span> <span class="n">RMSDerror</span><span class="p">)</span>

        <span class="c">#print tables</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span>
        <span class="n">finalenergy</span> <span class="o">=</span> <span class="n">MADerror</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">finalenergy</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c"># restore molecule and options</span>
    <span class="n">activate</span><span class="p">(</span><span class="n">user_molecule</span><span class="p">)</span>
    <span class="n">user_molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&quot;BASIS&quot;</span><span class="p">,</span> <span class="n">user_basis</span><span class="p">)</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&quot;REFERENCE&quot;</span><span class="p">,</span> <span class="n">user_reference</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">b_user_reference</span><span class="p">:</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">revoke_global_option_changed</span><span class="p">(</span><span class="s">&#39;REFERENCE&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">finalenergy</span>

</div>
<div class="viewcode-block" id="drop_duplicates"><a class="viewcode-back" href="../index.html#wrappers.drop_duplicates">[docs]</a><span class="k">def</span> <span class="nf">drop_duplicates</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function that given an array *seq*, returns an array without any duplicate</span>
<span class="sd">    entries. There is no guarantee of which duplicate entry is dropped.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">noDupes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="p">[</span><span class="n">noDupes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">seq</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">noDupes</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">noDupes</span>

</div>
<div class="viewcode-block" id="tblhead"><a class="viewcode-back" href="../index.html#wrappers.tblhead">[docs]</a><span class="k">def</span> <span class="nf">tblhead</span><span class="p">(</span><span class="n">tbl_maxrgt</span><span class="p">,</span> <span class="n">tbl_delimit</span><span class="p">,</span> <span class="n">ttype</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function that prints the header for the changable-width results tables in db().</span>
<span class="sd">    *tbl_maxrgt* is the number of reagent columns the table must plan for. *tbl_delimit*</span>
<span class="sd">    is a string of dashes of the correct length to set off the table. *ttype* is 1 for</span>
<span class="sd">    tables comparing the computed values to the reference or 2 for simple tabulation</span>
<span class="sd">    and sum of the computed values.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tbl_str</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">tbl_str</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   </span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tbl_delimit</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ttype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">tbl_str</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="si">%23s</span><span class="s"> </span><span class="si">%19s</span><span class="s">   </span><span class="si">%8s</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Reaction&#39;</span><span class="p">,</span> <span class="s">&#39;Reaction Energy&#39;</span><span class="p">,</span> <span class="s">&#39;Error&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ttype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">tbl_str</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="si">%23s</span><span class="s">     </span><span class="si">%19s</span><span class="s"> </span><span class="si">%6s</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Reaction&#39;</span><span class="p">,</span> <span class="s">&#39;Reaction Value&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tbl_maxrgt</span><span class="p">):</span>
        <span class="n">tbl_str</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="si">%20s</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Reagent &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ttype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">tbl_str</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="si">%23s</span><span class="s">   </span><span class="si">%8s</span><span class="s"> </span><span class="si">%8s</span><span class="s"> </span><span class="si">%8s</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;Ref&#39;</span><span class="p">,</span> <span class="s">&#39;Calc&#39;</span><span class="p">,</span> <span class="s">&#39;[kcal/mol]&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ttype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">tbl_str</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="si">%54s</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tbl_maxrgt</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ttype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tbl_str</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="si">%20s</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;[H] Wt&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ttype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">tbl_str</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="si">%20s</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Value Wt&#39;</span><span class="p">)</span>
    <span class="n">tbl_str</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">   </span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tbl_delimit</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tbl_str</span>

<span class="c">##  Aliases  ##</span></div>
<span class="n">db</span> <span class="o">=</span> <span class="n">database</span>

<span class="c">#######################</span>
<span class="c">##  End of Database  ##</span>
<span class="c">#######################</span>


<span class="c">###################################</span>
<span class="c">##  Start of Complete Basis Set  ##</span>
<span class="c">###################################</span>

<div class="viewcode-block" id="complete_basis_set"><a class="viewcode-back" href="../index.html#wrappers.complete_basis_set">[docs]</a><span class="k">def</span> <span class="nf">complete_basis_set</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to define a multistage energy method from combinations of</span>
<span class="sd">    basis set extrapolations and delta corrections and condense the</span>
<span class="sd">    components into a minimum number of calculations.</span>

<span class="sd">    :aliases: cbs()</span>

<span class="sd">    :returns: (*float*) -- Total electronic energy in Hartrees</span>

<span class="sd">    :PSI variables:</span>

<span class="sd">    .. envvar:: CBS TOTAL ENERGY</span>
<span class="sd">        CBS REFERENCE ENERGY</span>
<span class="sd">        CBS CORRELATION ENERGY</span>
<span class="sd">        CURRENT ENERGY</span>
<span class="sd">        CURRENT REFERENCE ENERGY</span>
<span class="sd">        CURRENT CORRELATION ENERGY</span>

<span class="sd">    .. caution:: Some features are not yet implemented. Buy a developer a coffee.</span>

<span class="sd">       - Methods beyond basic scf, mp2, ccsd, ccsd(t) not yet hooked in through PSI variables, df-mp2 in particular.</span>

<span class="sd">       - No scheme defaults for given basis zeta number, so scheme must be specified explicitly.</span>

<span class="sd">       - No way to tell function to boost fitting basis size for all calculations.</span>

<span class="sd">       - No way to extrapolate def2 family basis sets</span>

<span class="sd">       - Need to add more extrapolation schemes</span>

<span class="sd">    As represented in the equation below, a CBS energy method is defined in four</span>
<span class="sd">    sequential stages (scf, corl, delta, delta2) covering treatment of the</span>
<span class="sd">    reference total energy, the correlation energy, a delta correction to the</span>
<span class="sd">    correlation energy, and a second delta correction. Each is activated by its</span>
<span class="sd">    stage_wfn keyword and is only allowed if all preceding stages are active.</span>

<span class="sd">    .. include:: cbs_eqn.rst</span>

<span class="sd">    * Energy Methods</span>
<span class="sd">        The presence of a stage_wfn keyword is the indicator to incorporate</span>
<span class="sd">        (and check for stage_basis and stage_scheme keywords) and compute</span>
<span class="sd">        that stage in defining the CBS energy.</span>

<span class="sd">    The cbs() function requires, at a minimum, ``name=&#39;scf&#39;`` and ``scf_basis``</span>
<span class="sd">        keywords to be specified for reference-step only jobs and ``name`` and</span>
<span class="sd">        ``corl_basis`` keywords for correlated jobs.</span>

<span class="sd">    :type name: string</span>
<span class="sd">    :param name: ``&#39;scf&#39;`` || ``&#39;ccsd&#39;`` || etc.</span>

<span class="sd">        First argument, usually unlabeled. Indicates the computational method</span>
<span class="sd">        for the correlation energy, unless only reference step to be performed,</span>
<span class="sd">        in which case should be ``&#39;scf&#39;``. Overruled if stage_wfn keywords supplied.</span>

<span class="sd">    :type corl_wfn: string</span>
<span class="sd">    :param corl_wfn: ``&#39;mp2&#39;`` || ``&#39;ccsd(t)&#39;`` || etc.</span>

<span class="sd">        Indicates the energy method for which the correlation energy is to be</span>
<span class="sd">        obtained. Can also be specified with ``name`` or as the unlabeled</span>
<span class="sd">        first argument to the function.</span>

<span class="sd">    :type delta_wfn: string</span>
<span class="sd">    :param delta_wfn: ``&#39;ccsd&#39;`` || ``&#39;ccsd(t)&#39;`` || etc.</span>

<span class="sd">        Indicates the (superior) energy method for which a delta correction</span>
<span class="sd">        to the correlation energy is to be obtained.</span>

<span class="sd">    :type delta_wfn_lesser: string</span>
<span class="sd">    :param delta_wfn_lesser: |dl| ``&#39;mp2&#39;`` |dr| || ``&#39;ccsd&#39;`` || etc.</span>

<span class="sd">        Indicates the inferior energy method for which a delta correction</span>
<span class="sd">        to the correlation energy is to be obtained.</span>

<span class="sd">    :type delta2_wfn: string</span>
<span class="sd">    :param delta2_wfn: ``&#39;ccsd&#39;`` || ``&#39;ccsd(t)&#39;`` || etc.</span>

<span class="sd">        Indicates the (superior) energy method for which a second delta correction</span>
<span class="sd">        to the correlation energy is to be obtained.</span>

<span class="sd">    :type delta2_wfn_lesser: string</span>
<span class="sd">    :param delta2_wfn_lesser: |dl| ``&#39;mp2&#39;`` |dr| || ``&#39;ccsd(t)&#39;`` || etc.</span>

<span class="sd">        Indicates the inferior energy method for which a second delta correction</span>
<span class="sd">        to the correlation energy is to be obtained.</span>

<span class="sd">    * Basis Sets</span>
<span class="sd">        Currently, the basis set set through ``set`` commands have no influence</span>
<span class="sd">        on a cbs calculation.</span>

<span class="sd">    :type scf_basis: string</span>
<span class="sd">    :param scf_basis: |dl| ``corl_basis`` |dr| || ``&#39;cc-pV[TQ]Z&#39;`` || ``&#39;jun-cc-pv[tq5]z&#39;`` || ``&#39;6-31G*&#39;`` || etc.</span>

<span class="sd">        Indicates the sequence of basis sets employed for the reference energy.</span>
<span class="sd">        If any correlation method is specified, ``scf_basis`` can default</span>
<span class="sd">        to ``corl_basis``.</span>

<span class="sd">    :type corl_basis: string</span>
<span class="sd">    :param corl_basis: ``&#39;cc-pV[TQ]Z&#39;`` || ``&#39;jun-cc-pv[tq5]z&#39;`` || ``&#39;6-31G*&#39;`` || etc.</span>

<span class="sd">        Indicates the sequence of basis sets employed for the correlation energy.</span>

<span class="sd">    :type delta_basis: string</span>
<span class="sd">    :param delta_basis: ``&#39;cc-pV[TQ]Z&#39;`` || ``&#39;jun-cc-pv[tq5]z&#39;`` || ``&#39;6-31G*&#39;`` || etc.</span>

<span class="sd">        Indicates the sequence of basis sets employed for the delta correction</span>
<span class="sd">        to the correlation energy.</span>

<span class="sd">    :type delta2_basis: string</span>
<span class="sd">    :param delta2_basis: ``&#39;cc-pV[TQ]Z&#39;`` || ``&#39;jun-cc-pv[tq5]z&#39;`` || ``&#39;6-31G*&#39;`` || etc.</span>

<span class="sd">        Indicates the sequence of basis sets employed for the second delta correction</span>
<span class="sd">        to the correlation energy.</span>

<span class="sd">    * Schemes</span>
<span class="sd">        Transformations of the energy through basis set extrapolation for each</span>
<span class="sd">        stage of the CBS definition. A complaint is generated if number of basis</span>
<span class="sd">        sets in stage_basis does not exactly satisfy requirements of stage_scheme.</span>
<span class="sd">        An exception is the default, ``&#39;highest_1&#39;``, which uses the best basis</span>
<span class="sd">        set available. See `Extrapolation Schemes`_ for all available schemes.</span>

<span class="sd">    :type scf_scheme: function</span>
<span class="sd">    :param scf_scheme: |dl| ``highest_1`` |dr| || ``scf_xtpl_helgaker_3`` || etc.</span>

<span class="sd">        Indicates the basis set extrapolation scheme to be applied to the reference energy.</span>

<span class="sd">    :type corl_scheme: function</span>
<span class="sd">    :param corl_scheme: |dl| ``highest_1`` |dr| || ``corl_xtpl_helgaker_2`` || etc.</span>

<span class="sd">        Indicates the basis set extrapolation scheme to be applied to the correlation energy.</span>

<span class="sd">    :type delta_scheme: function</span>
<span class="sd">    :param delta_scheme: |dl| ``highest_1`` |dr| || ``corl_xtpl_helgaker_2`` || etc.</span>

<span class="sd">        Indicates the basis set extrapolation scheme to be applied to the delta correction</span>
<span class="sd">        to the correlation energy.</span>

<span class="sd">    :type delta2_scheme: function</span>
<span class="sd">    :param delta2_scheme: |dl| ``highest_1`` |dr| || ``corl_xtpl_helgaker_2`` || etc.</span>

<span class="sd">        Indicates the basis set extrapolation scheme to be applied to the second delta correction</span>
<span class="sd">        to the correlation energy.</span>

<span class="sd">    :examples:</span>

<span class="sd">    &gt;&gt;&gt; # [1] replicates with cbs() the simple model chemistry scf/cc-pVDZ: set basis cc-pVDZ energy(&#39;scf&#39;)</span>
<span class="sd">    &gt;&gt;&gt; cbs(&#39;scf&#39;, scf_basis=&#39;cc-pVDZ&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [2] replicates with cbs() the simple model chemistry mp2/jun-cc-pVDZ: set basis jun-cc-pVDZ energy(&#39;mp2&#39;)</span>
<span class="sd">    &gt;&gt;&gt; cbs(&#39;mp2&#39;, corl_basis=&#39;jun-cc-pVDZ&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [3] DTQ-zeta extrapolated scf reference energy</span>
<span class="sd">    &gt;&gt;&gt; cbs(&#39;scf&#39;, scf_basis=&#39;cc-pV[DTQ]Z&#39;, scf_scheme=scf_xtpl_helgaker_3)</span>

<span class="sd">    &gt;&gt;&gt; # [4] DT-zeta extrapolated mp2 correlation energy atop a T-zeta reference</span>
<span class="sd">    &gt;&gt;&gt; cbs(&#39;mp2&#39;, corl_basis=&#39;cc-pv[dt]z&#39;, corl_scheme=corl_xtpl_helgaker_2)</span>

<span class="sd">    &gt;&gt;&gt; # [5] a DT-zeta extrapolated coupled-cluster correction atop a TQ-zeta extrapolated mp2 correlation energy atop a Q-zeta reference</span>
<span class="sd">    &gt;&gt;&gt; cbs(&#39;mp2&#39;, corl_basis=&#39;aug-cc-pv[tq]z&#39;, corl_scheme=corl_xtpl_helgaker_2, delta_wfn=&#39;ccsd(t)&#39;, delta_basis=&#39;aug-cc-pv[dt]z&#39;, delta_scheme=corl_xtpl_helgaker_2)</span>

<span class="sd">    &gt;&gt;&gt; # [6] a D-zeta ccsd(t) correction atop a DT-zeta extrapolated ccsd cluster correction atop a TQ-zeta extrapolated mp2 correlation energy atop a Q-zeta reference</span>
<span class="sd">    &gt;&gt;&gt; cbs(&#39;mp2&#39;, corl_basis=&#39;aug-cc-pv[tq]z&#39;, corl_scheme=corl_xtpl_helgaker_2, delta_wfn=&#39;ccsd&#39;, delta_basis=&#39;aug-cc-pv[dt]z&#39;, delta_scheme=corl_xtpl_helgaker_2, delta2_wfn=&#39;ccsd(t)&#39;, delta2_wfn_lesser=&#39;ccsd&#39;, delta2_basis=&#39;aug-cc-pvdz&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [7] cbs() coupled with database()</span>
<span class="sd">    &gt;&gt;&gt; database(&#39;mp2&#39;, &#39;BASIC&#39;, subset=[&#39;h2o&#39;,&#39;nh3&#39;], symm=&#39;on&#39;, func=cbs, corl_basis=&#39;cc-pV[tq]z&#39;, corl_scheme=corl_xtpl_helgaker_2, delta_wfn=&#39;ccsd(t)&#39;, delta_basis=&#39;sto-3g&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c"># Wrap any positional arguments into kwargs (for intercalls among wrappers)</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="s">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c"># Establish function to call (only energy makes sense for cbs)</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="s">&#39;cbs_func&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;func&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;cbs_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;func&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;func&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;cbs_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">energy</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;cbs_func&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">func</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Function </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> does not exist to be called by wrapper complete_basis_set.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">func</span> <span class="ow">is</span> <span class="n">energy</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Wrapper complete_basis_set is unhappy to be calling function </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> instead of </span><span class="se">\&#39;</span><span class="s">energy</span><span class="se">\&#39;</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>

    <span class="c"># Define some quantum chemical knowledge, namely what methods are subsumed in others</span>
    <span class="n">VARH</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">VARH</span><span class="p">[</span><span class="s">&#39;scf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>         <span class="s">&#39;scftot&#39;</span><span class="p">:</span> <span class="s">&#39;SCF TOTAL ENERGY&#39;</span><span class="p">}</span>
    <span class="n">VARH</span><span class="p">[</span><span class="s">&#39;mp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>         <span class="s">&#39;scftot&#39;</span><span class="p">:</span> <span class="s">&#39;SCF TOTAL ENERGY&#39;</span><span class="p">,</span>
                           <span class="s">&#39;mp2corl&#39;</span><span class="p">:</span> <span class="s">&#39;MP2 CORRELATION ENERGY&#39;</span><span class="p">}</span>
    <span class="n">VARH</span><span class="p">[</span><span class="s">&#39;ccsd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>        <span class="s">&#39;scftot&#39;</span><span class="p">:</span> <span class="s">&#39;SCF TOTAL ENERGY&#39;</span><span class="p">,</span>
                           <span class="s">&#39;mp2corl&#39;</span><span class="p">:</span> <span class="s">&#39;MP2 CORRELATION ENERGY&#39;</span><span class="p">,</span>
                          <span class="s">&#39;ccsdcorl&#39;</span><span class="p">:</span> <span class="s">&#39;CCSD CORRELATION ENERGY&#39;</span><span class="p">}</span>
    <span class="n">VARH</span><span class="p">[</span><span class="s">&#39;ccsd(t)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>     <span class="s">&#39;scftot&#39;</span><span class="p">:</span> <span class="s">&#39;SCF TOTAL ENERGY&#39;</span><span class="p">,</span>
                           <span class="s">&#39;mp2corl&#39;</span><span class="p">:</span> <span class="s">&#39;MP2 CORRELATION ENERGY&#39;</span><span class="p">,</span>
                          <span class="s">&#39;ccsdcorl&#39;</span><span class="p">:</span> <span class="s">&#39;CCSD CORRELATION ENERGY&#39;</span><span class="p">,</span>
                       <span class="s">&#39;ccsd(t)corl&#39;</span><span class="p">:</span> <span class="s">&#39;CCSD(T) CORRELATION ENERGY&#39;</span><span class="p">}</span>

    <span class="n">finalenergy</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">do_scf</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">do_corl</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">do_delta</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">do_delta2</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c"># Must collect (here) and set (below) basis sets after every new molecule activation</span>
    <span class="n">b_user_basis</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">has_global_option_changed</span><span class="p">(</span><span class="s">&#39;BASIS&#39;</span><span class="p">)</span>
    <span class="n">user_basis</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;BASIS&#39;</span><span class="p">)</span>
    <span class="c">#user_df_basis_scf = PsiMod.get_option(&#39;DF_BASIS_SCF&#39;)</span>
    <span class="c">#user_df_basis_mp2 = PsiMod.get_option(&#39;DF_BASIS_MP2&#39;)</span>
    <span class="c">#user_df_basis_cc = PsiMod.get_option(&#39;DF_BASIS_CC&#39;)</span>
    <span class="c">#user_df_basis_sapt = PsiMod.get_option(&#39;DF_BASIS_SAPT&#39;)</span>
    <span class="c">#user_df_basis_elst = PsiMod.get_option(&#39;DF_BASIS_ELST&#39;)</span>
    <span class="n">b_user_wfn</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">has_global_option_changed</span><span class="p">(</span><span class="s">&#39;WFN&#39;</span><span class="p">)</span>
    <span class="n">user_wfn</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;WFN&#39;</span><span class="p">)</span>

    <span class="c"># Make sure the molecule the user provided is the active one</span>
    <span class="k">if</span> <span class="s">&#39;molecule&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">activate</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;molecule&#39;</span><span class="p">])</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;molecule&#39;</span><span class="p">]</span>
    <span class="n">molecule</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&quot;BASIS&quot;</span><span class="p">,</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s">&quot;BASIS&quot;</span><span class="p">))</span>

    <span class="c"># Establish method for correlation energy</span>
    <span class="k">if</span> <span class="s">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lowername</span> <span class="o">==</span> <span class="s">&#39;scf&#39;</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">do_corl</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">cbs_corl_wfn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="s">&#39;corl_wfn&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">do_corl</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">cbs_corl_wfn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;corl_wfn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">do_corl</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">cbs_corl_wfn</span> <span class="ow">in</span> <span class="n">VARH</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Requested CORL method </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> is not recognized. Add it to VARH in wrapper.py to proceed.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cbs_corl_wfn</span><span class="p">))</span>

    <span class="c"># Establish method for delta correction energy</span>
    <span class="k">if</span> <span class="s">&#39;delta_wfn&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">do_delta</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">cbs_delta_wfn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;delta_wfn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">cbs_delta_wfn</span> <span class="ow">in</span> <span class="n">VARH</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Requested DELTA method </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> is not recognized. Add it to VARH in wrapper.py to proceed.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cbs_delta_wfn</span><span class="p">))</span>

        <span class="k">if</span> <span class="s">&#39;delta_wfn_lesser&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">cbs_delta_wfn_lesser</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;delta_wfn_lesser&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cbs_delta_wfn_lesser</span> <span class="o">=</span> <span class="s">&#39;mp2&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">cbs_delta_wfn_lesser</span> <span class="ow">in</span> <span class="n">VARH</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Requested DELTA method lesser </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> is not recognized. Add it to VARH in wrapper.py to proceed.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cbs_delta_wfn_lesser</span><span class="p">))</span>

    <span class="c"># Establish method for second delta correction energy</span>
    <span class="k">if</span> <span class="s">&#39;delta2_wfn&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">do_delta2</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">cbs_delta2_wfn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;delta2_wfn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">cbs_delta2_wfn</span> <span class="ow">in</span> <span class="n">VARH</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Requested DELTA2 method </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> is not recognized. Add it to VARH in wrapper.py to proceed.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cbs_delta2_wfn</span><span class="p">))</span>

        <span class="k">if</span> <span class="s">&#39;delta2_wfn_lesser&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">cbs_delta2_wfn_lesser</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;delta2_wfn_lesser&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cbs_delta2_wfn_lesser</span> <span class="o">=</span> <span class="s">&#39;mp2&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">cbs_delta2_wfn_lesser</span> <span class="ow">in</span> <span class="n">VARH</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Requested DELTA2 method lesser </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> is not recognized. Add it to VARH in wrapper.py to proceed.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cbs_delta2_wfn_lesser</span><span class="p">))</span>

    <span class="c"># Check that user isn&#39;t skipping steps in scf + corl + delta + delta2 sequence</span>
    <span class="k">if</span> <span class="n">do_scf</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">do_corl</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">do_delta</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">do_delta2</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">do_scf</span> <span class="ow">and</span> <span class="n">do_corl</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">do_delta</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">do_delta2</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">do_scf</span> <span class="ow">and</span> <span class="n">do_corl</span> <span class="ow">and</span> <span class="n">do_delta</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">do_delta2</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">do_scf</span> <span class="ow">and</span> <span class="n">do_corl</span> <span class="ow">and</span> <span class="n">do_delta</span> <span class="ow">and</span> <span class="n">do_delta2</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Requested scf (</span><span class="si">%s</span><span class="s">) + corl (</span><span class="si">%s</span><span class="s">) + delta (</span><span class="si">%s</span><span class="s">) + delta2 (</span><span class="si">%s</span><span class="s">) not valid. These steps are cummulative.&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">do_scf</span><span class="p">,</span> <span class="n">do_corl</span><span class="p">,</span> <span class="n">do_delta</span><span class="p">,</span> <span class="n">do_delta2</span><span class="p">))</span>

    <span class="c"># Establish list of valid basis sets for correlation energy</span>
    <span class="k">if</span> <span class="n">do_corl</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;corl_basis&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">BSTC</span><span class="p">,</span> <span class="n">ZETC</span> <span class="o">=</span> <span class="n">validate_bracketed_basis</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;corl_basis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;CORL basis sets through keyword </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> are required.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;corl_basis&#39;</span><span class="p">))</span>

    <span class="c"># Establish list of valid basis sets for scf energy</span>
    <span class="k">if</span> <span class="s">&#39;scf_basis&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">BSTR</span><span class="p">,</span> <span class="n">ZETR</span> <span class="o">=</span> <span class="n">validate_bracketed_basis</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;scf_basis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">do_corl</span><span class="p">:</span>
            <span class="n">BSTR</span> <span class="o">=</span> <span class="n">BSTC</span><span class="p">[:]</span>
            <span class="n">ZETR</span> <span class="o">=</span> <span class="n">ZETC</span><span class="p">[:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;SCF basis sets through keyword </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> are required. Or perhaps you forgot the </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;scf_basis&#39;</span><span class="p">,</span> <span class="s">&#39;corl_wfn&#39;</span><span class="p">))</span>

    <span class="c"># Establish list of valid basis sets for delta correction energy</span>
    <span class="k">if</span> <span class="n">do_delta</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;delta_basis&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">BSTD</span><span class="p">,</span> <span class="n">ZETD</span> <span class="o">=</span> <span class="n">validate_bracketed_basis</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;delta_basis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;DELTA basis sets through keyword </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> are required.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;delta_basis&#39;</span><span class="p">))</span>

    <span class="c"># Establish list of valid basis sets for second delta correction energy</span>
    <span class="k">if</span> <span class="n">do_delta2</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;delta2_basis&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">BSTD2</span><span class="p">,</span> <span class="n">ZETD2</span> <span class="o">=</span> <span class="n">validate_bracketed_basis</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;delta2_basis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;DELTA2 basis sets through keyword </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> are required.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;delta2_basis&#39;</span><span class="p">))</span>

    <span class="c"># Establish treatment for scf energy (validity check useless since python will catch it long before here)</span>
    <span class="n">cbs_scf_scheme</span> <span class="o">=</span> <span class="n">highest_1</span>
    <span class="k">if</span> <span class="s">&#39;scf_scheme&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">cbs_scf_scheme</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;scf_scheme&#39;</span><span class="p">]</span>

    <span class="c"># Establish treatment for correlation energy</span>
    <span class="n">cbs_corl_scheme</span> <span class="o">=</span> <span class="n">highest_1</span>
    <span class="k">if</span> <span class="s">&#39;corl_scheme&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">cbs_corl_scheme</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;corl_scheme&#39;</span><span class="p">]</span>

    <span class="c"># Establish treatment for delta correction energy</span>
    <span class="n">cbs_delta_scheme</span> <span class="o">=</span> <span class="n">highest_1</span>
    <span class="k">if</span> <span class="s">&#39;delta_scheme&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">cbs_delta_scheme</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;delta_scheme&#39;</span><span class="p">]</span>

    <span class="c"># Establish treatment for delta2 correction energy</span>
    <span class="n">cbs_delta2_scheme</span> <span class="o">=</span> <span class="n">highest_1</span>
    <span class="k">if</span> <span class="s">&#39;delta2_scheme&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">cbs_delta2_scheme</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;delta2_scheme&#39;</span><span class="p">]</span>

    <span class="c"># Build string of title banner</span>
    <span class="n">cbsbanners</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">cbsbanners</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;PsiMod.print_out(&#39;</span><span class="se">\\</span><span class="s">n&#39;)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
    <span class="n">cbsbanners</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;banner(&#39; CBS Setup &#39;)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
    <span class="n">cbsbanners</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;PsiMod.print_out(&#39;</span><span class="se">\\</span><span class="s">n&#39;)</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span>
    <span class="k">exec</span> <span class="n">cbsbanners</span>

    <span class="c"># Call schemes for each portion of total energy to &#39;place orders&#39; for calculations needed</span>
    <span class="n">d_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;d_stage&#39;</span><span class="p">,</span> <span class="s">&#39;d_scheme&#39;</span><span class="p">,</span> <span class="s">&#39;d_basis&#39;</span><span class="p">,</span> <span class="s">&#39;d_wfn&#39;</span><span class="p">,</span> <span class="s">&#39;d_need&#39;</span><span class="p">,</span> <span class="s">&#39;d_coef&#39;</span><span class="p">,</span> <span class="s">&#39;d_energy&#39;</span><span class="p">]</span>
    <span class="n">f_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">,</span> <span class="s">&#39;f_portion&#39;</span><span class="p">,</span> <span class="s">&#39;f_basis&#39;</span><span class="p">,</span> <span class="s">&#39;f_zeta&#39;</span><span class="p">,</span> <span class="s">&#39;f_energy&#39;</span><span class="p">]</span>
    <span class="n">GRAND_NEED</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">MODELCHEM</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bstring</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">do_scf</span><span class="p">:</span>
        <span class="n">NEED</span> <span class="o">=</span> <span class="n">call_function_in_1st_argument</span><span class="p">(</span><span class="n">cbs_scf_scheme</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s">&#39;requisition&#39;</span><span class="p">,</span> <span class="n">basisname</span><span class="o">=</span><span class="n">BSTR</span><span class="p">,</span> <span class="n">basiszeta</span><span class="o">=</span><span class="n">ZETR</span><span class="p">,</span> <span class="n">wfnname</span><span class="o">=</span><span class="s">&#39;scf&#39;</span><span class="p">)</span>
        <span class="n">GRAND_NEED</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">d_fields</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;scf&#39;</span><span class="p">,</span> <span class="n">cbs_scf_scheme</span><span class="p">,</span> <span class="n">reconstitute_bracketed_basis</span><span class="p">(</span><span class="n">NEED</span><span class="p">),</span> <span class="s">&#39;scf&#39;</span><span class="p">,</span> <span class="n">NEED</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])))</span>

    <span class="k">if</span> <span class="n">do_corl</span><span class="p">:</span>
        <span class="n">NEED</span> <span class="o">=</span> <span class="n">call_function_in_1st_argument</span><span class="p">(</span><span class="n">cbs_corl_scheme</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s">&#39;requisition&#39;</span><span class="p">,</span> <span class="n">basisname</span><span class="o">=</span><span class="n">BSTC</span><span class="p">,</span> <span class="n">basiszeta</span><span class="o">=</span><span class="n">ZETC</span><span class="p">,</span> <span class="n">wfnname</span><span class="o">=</span><span class="n">cbs_corl_wfn</span><span class="p">)</span>
        <span class="n">GRAND_NEED</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">d_fields</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;corl&#39;</span><span class="p">,</span> <span class="n">cbs_corl_scheme</span><span class="p">,</span> <span class="n">reconstitute_bracketed_basis</span><span class="p">(</span><span class="n">NEED</span><span class="p">),</span> <span class="n">cbs_corl_wfn</span><span class="p">,</span> <span class="n">NEED</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])))</span>

    <span class="k">if</span> <span class="n">do_delta</span><span class="p">:</span>
        <span class="n">NEED</span> <span class="o">=</span> <span class="n">call_function_in_1st_argument</span><span class="p">(</span><span class="n">cbs_delta_scheme</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s">&#39;requisition&#39;</span><span class="p">,</span> <span class="n">basisname</span><span class="o">=</span><span class="n">BSTD</span><span class="p">,</span> <span class="n">basiszeta</span><span class="o">=</span><span class="n">ZETD</span><span class="p">,</span> <span class="n">wfnname</span><span class="o">=</span><span class="n">cbs_delta_wfn</span><span class="p">)</span>
        <span class="n">GRAND_NEED</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">d_fields</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;delta&#39;</span><span class="p">,</span> <span class="n">cbs_delta_scheme</span><span class="p">,</span> <span class="n">reconstitute_bracketed_basis</span><span class="p">(</span><span class="n">NEED</span><span class="p">),</span> <span class="n">cbs_delta_wfn</span><span class="p">,</span> <span class="n">NEED</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])))</span>

        <span class="n">NEED</span> <span class="o">=</span> <span class="n">call_function_in_1st_argument</span><span class="p">(</span><span class="n">cbs_delta_scheme</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s">&#39;requisition&#39;</span><span class="p">,</span> <span class="n">basisname</span><span class="o">=</span><span class="n">BSTD</span><span class="p">,</span> <span class="n">basiszeta</span><span class="o">=</span><span class="n">ZETD</span><span class="p">,</span> <span class="n">wfnname</span><span class="o">=</span><span class="n">cbs_delta_wfn_lesser</span><span class="p">)</span>
        <span class="n">GRAND_NEED</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">d_fields</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;delta&#39;</span><span class="p">,</span> <span class="n">cbs_delta_scheme</span><span class="p">,</span> <span class="n">reconstitute_bracketed_basis</span><span class="p">(</span><span class="n">NEED</span><span class="p">),</span> <span class="n">cbs_delta_wfn_lesser</span><span class="p">,</span> <span class="n">NEED</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])))</span>

    <span class="k">if</span> <span class="n">do_delta2</span><span class="p">:</span>
        <span class="n">NEED</span> <span class="o">=</span> <span class="n">call_function_in_1st_argument</span><span class="p">(</span><span class="n">cbs_delta2_scheme</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s">&#39;requisition&#39;</span><span class="p">,</span> <span class="n">basisname</span><span class="o">=</span><span class="n">BSTD2</span><span class="p">,</span> <span class="n">basiszeta</span><span class="o">=</span><span class="n">ZETD2</span><span class="p">,</span> <span class="n">wfnname</span><span class="o">=</span><span class="n">cbs_delta2_wfn</span><span class="p">)</span>
        <span class="n">GRAND_NEED</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">d_fields</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;delta2&#39;</span><span class="p">,</span> <span class="n">cbs_delta2_scheme</span><span class="p">,</span> <span class="n">reconstitute_bracketed_basis</span><span class="p">(</span><span class="n">NEED</span><span class="p">),</span> <span class="n">cbs_delta2_wfn</span><span class="p">,</span> <span class="n">NEED</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])))</span>

        <span class="n">NEED</span> <span class="o">=</span> <span class="n">call_function_in_1st_argument</span><span class="p">(</span><span class="n">cbs_delta2_scheme</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s">&#39;requisition&#39;</span><span class="p">,</span> <span class="n">basisname</span><span class="o">=</span><span class="n">BSTD2</span><span class="p">,</span> <span class="n">basiszeta</span><span class="o">=</span><span class="n">ZETD2</span><span class="p">,</span> <span class="n">wfnname</span><span class="o">=</span><span class="n">cbs_delta2_wfn_lesser</span><span class="p">)</span>
        <span class="n">GRAND_NEED</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">d_fields</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;delta2&#39;</span><span class="p">,</span> <span class="n">cbs_delta2_scheme</span><span class="p">,</span> <span class="n">reconstitute_bracketed_basis</span><span class="p">(</span><span class="n">NEED</span><span class="p">),</span> <span class="n">cbs_delta2_wfn_lesser</span><span class="p">,</span> <span class="n">NEED</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])))</span>

    <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">GRAND_NEED</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">lvl</span> <span class="ow">in</span> <span class="n">stage</span><span class="p">[</span><span class="s">&#39;d_need&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">MODELCHEM</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lvl</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c"># Apply chemical reasoning to choose the minimum computations to run</span>
    <span class="n">JOBS</span> <span class="o">=</span> <span class="n">MODELCHEM</span><span class="p">[:]</span>

    <span class="n">instructions</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">instructions</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;    Naive listing of computations required.</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">mc</span> <span class="ow">in</span> <span class="n">JOBS</span><span class="p">:</span>
        <span class="n">instructions</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   </span><span class="si">%12s</span><span class="s"> / </span><span class="si">%-24s</span><span class="s"> for  </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">],</span> <span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_basis&#39;</span><span class="p">],</span> <span class="n">VARH</span><span class="p">[</span><span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">]][</span><span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_portion&#39;</span><span class="p">]])</span>

    <span class="c">#     Remove duplicate modelchem portion listings</span>
    <span class="k">for</span> <span class="n">indx_mc</span><span class="p">,</span> <span class="n">mc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">MODELCHEM</span><span class="p">):</span>
        <span class="n">dups</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">indx_job</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">JOBS</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s">&#39;f_basis&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_basis&#39;</span><span class="p">]):</span>
                <span class="n">dups</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dups</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">del</span> <span class="n">JOBS</span><span class="p">[</span><span class="n">indx_job</span><span class="p">]</span>

    <span class="c">#     Remove chemically subsumed modelchem portion listings</span>
    <span class="k">for</span> <span class="n">indx_mc</span><span class="p">,</span> <span class="n">mc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">MODELCHEM</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">menial</span> <span class="ow">in</span> <span class="n">VARH</span><span class="p">[</span><span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">]]:</span>
            <span class="k">for</span> <span class="n">indx_job</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">JOBS</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">menial</span> <span class="o">==</span> <span class="n">job</span><span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">job</span><span class="p">[</span><span class="s">&#39;f_portion&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_basis&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">job</span><span class="p">[</span><span class="s">&#39;f_basis&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">job</span><span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">]):</span>
                    <span class="k">del</span> <span class="n">JOBS</span><span class="p">[</span><span class="n">indx_job</span><span class="p">]</span>

    <span class="n">instructions</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">    Enlightened listing of computations required.</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">mc</span> <span class="ow">in</span> <span class="n">JOBS</span><span class="p">:</span>
        <span class="n">instructions</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   </span><span class="si">%12s</span><span class="s"> / </span><span class="si">%-24s</span><span class="s"> for  </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">],</span> <span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_basis&#39;</span><span class="p">],</span> <span class="n">VARH</span><span class="p">[</span><span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">]][</span><span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_portion&#39;</span><span class="p">]])</span>

    <span class="c">#     Expand listings to all that will be obtained</span>
    <span class="n">JOBS_EXT</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">indx_job</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">JOBS</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">menial</span> <span class="ow">in</span> <span class="n">VARH</span><span class="p">[</span><span class="n">job</span><span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">]]:</span>
            <span class="n">temp_wfn</span><span class="p">,</span> <span class="n">temp_portion</span> <span class="o">=</span> <span class="n">split_menial</span><span class="p">(</span><span class="n">menial</span><span class="p">)</span>
            <span class="n">JOBS_EXT</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">f_fields</span><span class="p">,</span> <span class="p">[</span><span class="n">temp_wfn</span><span class="p">,</span> <span class="n">temp_portion</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s">&#39;f_basis&#39;</span><span class="p">],</span> <span class="n">job</span><span class="p">[</span><span class="s">&#39;f_zeta&#39;</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">])))</span>

    <span class="c">#instructions += &quot;&quot;&quot;\n    Full listing of computations to be obtained (required and bonus).\n&quot;&quot;&quot;</span>
    <span class="c">#for mc in JOBS_EXT:</span>
    <span class="c">#    instructions += &quot;&quot;&quot;   %12s / %-24s for  %s\n&quot;&quot;&quot; % (mc[&#39;f_wfn&#39;], mc[&#39;f_basis&#39;], VARH[mc[&#39;f_wfn&#39;]][mc[&#39;f_wfn&#39;]+mc[&#39;f_portion&#39;]])</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span>

    <span class="c"># Run necessary computations</span>
    <span class="k">for</span> <span class="n">mc</span> <span class="ow">in</span> <span class="n">JOBS</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">]</span>

        <span class="c"># Build string of title banner</span>
        <span class="n">cbsbanners</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">cbsbanners</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;PsiMod.print_out(&#39;</span><span class="se">\\</span><span class="s">n&#39;)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
        <span class="n">cbsbanners</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;banner(&#39; CBS Computation: </span><span class="si">%s</span><span class="s"> / </span><span class="si">%s</span><span class="s"> &#39;)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_basis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="n">cbsbanners</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;PsiMod.print_out(&#39;</span><span class="se">\\</span><span class="s">n&#39;)</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span>
        <span class="k">exec</span> <span class="n">cbsbanners</span>

        <span class="c"># Build string of molecule and commands that are dependent on the database</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">commands</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">PsiMod.set_global_option(&#39;BASIS&#39;, &#39;</span><span class="si">%s</span><span class="s">&#39;)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_basis&#39;</span><span class="p">])</span>
        <span class="k">exec</span> <span class="n">commands</span>

        <span class="c"># Make energy() call</span>
        <span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">call_function_in_1st_argument</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c"># Fill in energies for subsumed methods</span>
        <span class="k">for</span> <span class="n">menial</span> <span class="ow">in</span> <span class="n">VARH</span><span class="p">[</span><span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">]]:</span>
            <span class="n">temp_wfn</span><span class="p">,</span> <span class="n">temp_portion</span> <span class="o">=</span> <span class="n">split_menial</span><span class="p">(</span><span class="n">menial</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">JOBS_EXT</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">temp_wfn</span> <span class="o">==</span> <span class="n">job</span><span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">temp_portion</span> <span class="o">==</span> <span class="n">job</span><span class="p">[</span><span class="s">&#39;f_portion&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_basis&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">job</span><span class="p">[</span><span class="s">&#39;f_basis&#39;</span><span class="p">]):</span>
                    <span class="n">job</span><span class="p">[</span><span class="s">&#39;f_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PsiMod</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">VARH</span><span class="p">[</span><span class="n">temp_wfn</span><span class="p">][</span><span class="n">menial</span><span class="p">])</span>

        <span class="n">PsiMod</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>

    <span class="c"># Build string of title banner</span>
    <span class="n">cbsbanners</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">cbsbanners</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;PsiMod.print_out(&#39;</span><span class="se">\\</span><span class="s">n&#39;)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
    <span class="n">cbsbanners</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;banner(&#39; CBS Results &#39;)</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span>
    <span class="n">cbsbanners</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;PsiMod.print_out(&#39;</span><span class="se">\\</span><span class="s">n&#39;)</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span>
    <span class="k">exec</span> <span class="n">cbsbanners</span>

    <span class="c"># Insert obtained energies into the array that stores the cbs stages</span>
    <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">GRAND_NEED</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">lvl</span> <span class="ow">in</span> <span class="n">stage</span><span class="p">[</span><span class="s">&#39;d_need&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">MODELCHEM</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lvl</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">JOBS_EXT</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">lvl</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;f_wfn&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">job</span><span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">lvl</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;f_portion&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">job</span><span class="p">[</span><span class="s">&#39;f_portion&#39;</span><span class="p">])</span> <span class="ow">and</span>
                   <span class="p">(</span><span class="n">lvl</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;f_basis&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">job</span><span class="p">[</span><span class="s">&#39;f_basis&#39;</span><span class="p">])):</span>
                    <span class="n">lvl</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;f_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s">&#39;f_energy&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">GRAND_NEED</span><span class="p">:</span>
        <span class="n">stage</span><span class="p">[</span><span class="s">&#39;d_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">call_function_in_1st_argument</span><span class="p">(</span><span class="n">stage</span><span class="p">[</span><span class="s">&#39;d_scheme&#39;</span><span class="p">],</span> <span class="n">needname</span><span class="o">=</span><span class="n">stage</span><span class="p">[</span><span class="s">&#39;d_need&#39;</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;evaluate&#39;</span><span class="p">)</span>
        <span class="n">finalenergy</span> <span class="o">+=</span> <span class="n">stage</span><span class="p">[</span><span class="s">&#39;d_energy&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">stage</span><span class="p">[</span><span class="s">&#39;d_coef&#39;</span><span class="p">]</span>

    <span class="c"># Build string of results table</span>
    <span class="n">table_delimit</span> <span class="o">=</span> <span class="s">&#39;  &#39;</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">105</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">   ==&gt; </span><span class="si">%s</span><span class="s"> &lt;==</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Components&#39;</span><span class="p">)</span>
    <span class="n">tables</span> <span class="o">+=</span> <span class="n">table_delimit</span>
    <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;     </span><span class="si">%6s</span><span class="s"> </span><span class="si">%20s</span><span class="s"> </span><span class="si">%1s</span><span class="s"> </span><span class="si">%-26s</span><span class="s"> </span><span class="si">%3s</span><span class="s"> </span><span class="si">%16s</span><span class="s">   </span><span class="si">%-s</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;Method&#39;</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="s">&#39;Basis&#39;</span><span class="p">,</span> <span class="s">&#39;Rqd&#39;</span><span class="p">,</span> <span class="s">&#39;Energy [H]&#39;</span><span class="p">,</span> <span class="s">&#39;Variable&#39;</span><span class="p">)</span>
    <span class="n">tables</span> <span class="o">+=</span> <span class="n">table_delimit</span>
    <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">JOBS_EXT</span><span class="p">:</span>
        <span class="n">star</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">mc</span> <span class="ow">in</span> <span class="n">MODELCHEM</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s">&#39;f_basis&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mc</span><span class="p">[</span><span class="s">&#39;f_basis&#39;</span><span class="p">]):</span>
                <span class="n">star</span> <span class="o">=</span> <span class="s">&#39;*&#39;</span>
        <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;     </span><span class="si">%6s</span><span class="s"> </span><span class="si">%20s</span><span class="s"> </span><span class="si">%1s</span><span class="s"> </span><span class="si">%-27s</span><span class="s"> </span><span class="si">%2s</span><span class="s"> </span><span class="si">%16.8f</span><span class="s">   </span><span class="si">%-s</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">],</span>
                  <span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s">&#39;f_basis&#39;</span><span class="p">],</span> <span class="n">star</span><span class="p">,</span> <span class="n">job</span><span class="p">[</span><span class="s">&#39;f_energy&#39;</span><span class="p">],</span> <span class="n">VARH</span><span class="p">[</span><span class="n">job</span><span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">]][</span><span class="n">job</span><span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">job</span><span class="p">[</span><span class="s">&#39;f_portion&#39;</span><span class="p">]])</span>
    <span class="n">tables</span> <span class="o">+=</span> <span class="n">table_delimit</span>

    <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">   ==&gt; </span><span class="si">%s</span><span class="s"> &lt;==</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Stages&#39;</span><span class="p">)</span>
    <span class="n">tables</span> <span class="o">+=</span> <span class="n">table_delimit</span>
    <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;     </span><span class="si">%6s</span><span class="s"> </span><span class="si">%20s</span><span class="s"> </span><span class="si">%1s</span><span class="s"> </span><span class="si">%-27s</span><span class="s"> </span><span class="si">%2s</span><span class="s"> </span><span class="si">%16s</span><span class="s">   </span><span class="si">%-s</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Stage&#39;</span><span class="p">,</span> <span class="s">&#39;Method&#39;</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="s">&#39;Basis&#39;</span><span class="p">,</span> <span class="s">&#39;Wt&#39;</span><span class="p">,</span> <span class="s">&#39;Energy [H]&#39;</span><span class="p">,</span> <span class="s">&#39;Scheme&#39;</span><span class="p">)</span>
    <span class="n">tables</span> <span class="o">+=</span> <span class="n">table_delimit</span>
    <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">GRAND_NEED</span><span class="p">:</span>
        <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;     </span><span class="si">%6s</span><span class="s"> </span><span class="si">%20s</span><span class="s"> </span><span class="si">%1s</span><span class="s"> </span><span class="si">%-27s</span><span class="s"> </span><span class="si">%2d</span><span class="s"> </span><span class="si">%16.8f</span><span class="s">   </span><span class="si">%-s</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stage</span><span class="p">[</span><span class="s">&#39;d_stage&#39;</span><span class="p">],</span> <span class="n">stage</span><span class="p">[</span><span class="s">&#39;d_wfn&#39;</span><span class="p">],</span>
                  <span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">stage</span><span class="p">[</span><span class="s">&#39;d_basis&#39;</span><span class="p">],</span> <span class="n">stage</span><span class="p">[</span><span class="s">&#39;d_coef&#39;</span><span class="p">],</span> <span class="n">stage</span><span class="p">[</span><span class="s">&#39;d_energy&#39;</span><span class="p">],</span> <span class="n">stage</span><span class="p">[</span><span class="s">&#39;d_scheme&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
    <span class="n">tables</span> <span class="o">+=</span> <span class="n">table_delimit</span>

    <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">   ==&gt; </span><span class="si">%s</span><span class="s"> &lt;==</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;CBS&#39;</span><span class="p">)</span>
    <span class="n">tables</span> <span class="o">+=</span> <span class="n">table_delimit</span>
    <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;     </span><span class="si">%6s</span><span class="s"> </span><span class="si">%20s</span><span class="s"> </span><span class="si">%1s</span><span class="s"> </span><span class="si">%-27s</span><span class="s"> </span><span class="si">%2s</span><span class="s"> </span><span class="si">%16s</span><span class="s">   </span><span class="si">%-s</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Stage&#39;</span><span class="p">,</span> <span class="s">&#39;Method&#39;</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="s">&#39;Basis&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;Energy [H]&#39;</span><span class="p">,</span> <span class="s">&#39;Scheme&#39;</span><span class="p">)</span>
    <span class="n">tables</span> <span class="o">+=</span> <span class="n">table_delimit</span>
    <span class="k">if</span> <span class="n">do_scf</span><span class="p">:</span>
        <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;     </span><span class="si">%6s</span><span class="s"> </span><span class="si">%20s</span><span class="s"> </span><span class="si">%1s</span><span class="s"> </span><span class="si">%-27s</span><span class="s"> </span><span class="si">%2s</span><span class="s"> </span><span class="si">%16.8f</span><span class="s">   </span><span class="si">%-s</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;d_stage&#39;</span><span class="p">],</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;d_wfn&#39;</span><span class="p">],</span>
                  <span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;d_basis&#39;</span><span class="p">],</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;d_energy&#39;</span><span class="p">],</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;d_scheme&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">do_corl</span><span class="p">:</span>
        <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;     </span><span class="si">%6s</span><span class="s"> </span><span class="si">%20s</span><span class="s"> </span><span class="si">%1s</span><span class="s"> </span><span class="si">%-27s</span><span class="s"> </span><span class="si">%2s</span><span class="s"> </span><span class="si">%16.8f</span><span class="s">   </span><span class="si">%-s</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;d_stage&#39;</span><span class="p">],</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;d_wfn&#39;</span><span class="p">],</span>
                  <span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;d_basis&#39;</span><span class="p">],</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;d_energy&#39;</span><span class="p">],</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;d_scheme&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">do_delta</span><span class="p">:</span>
        <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;     </span><span class="si">%6s</span><span class="s"> </span><span class="si">%20s</span><span class="s"> </span><span class="si">%1s</span><span class="s"> </span><span class="si">%-27s</span><span class="s"> </span><span class="si">%2s</span><span class="s"> </span><span class="si">%16.8f</span><span class="s">   </span><span class="si">%-s</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s">&#39;d_stage&#39;</span><span class="p">],</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s">&#39;d_wfn&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; - &#39;</span> <span class="o">+</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="s">&#39;d_wfn&#39;</span><span class="p">],</span>
                  <span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s">&#39;d_basis&#39;</span><span class="p">],</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s">&#39;d_energy&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="s">&#39;d_energy&#39;</span><span class="p">],</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s">&#39;d_scheme&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">do_delta2</span><span class="p">:</span>
        <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;     </span><span class="si">%6s</span><span class="s"> </span><span class="si">%20s</span><span class="s"> </span><span class="si">%1s</span><span class="s"> </span><span class="si">%-27s</span><span class="s"> </span><span class="si">%2s</span><span class="s"> </span><span class="si">%16.8f</span><span class="s">   </span><span class="si">%-s</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="s">&#39;d_stage&#39;</span><span class="p">],</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="s">&#39;d_wfn&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; - &#39;</span> <span class="o">+</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="s">&#39;d_wfn&#39;</span><span class="p">],</span>
                  <span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="s">&#39;d_basis&#39;</span><span class="p">],</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="s">&#39;d_energy&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="s">&#39;d_energy&#39;</span><span class="p">],</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="s">&#39;d_scheme&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
    <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;     </span><span class="si">%6s</span><span class="s"> </span><span class="si">%20s</span><span class="s"> </span><span class="si">%1s</span><span class="s"> </span><span class="si">%-27s</span><span class="s"> </span><span class="si">%2s</span><span class="s"> </span><span class="si">%16.8f</span><span class="s">   </span><span class="si">%-s</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;total&#39;</span><span class="p">,</span> <span class="s">&#39;CBS&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">finalenergy</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="n">tables</span> <span class="o">+=</span> <span class="n">table_delimit</span>

    <span class="c">#print tables</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span>

    <span class="c"># Restore molecule and options</span>
    <span class="c">#PsiMod.set_local_option(&#39;SCF&#39;, &quot;WFN&quot;, user_wfn)    # TODO refuses to set global option WFN - rejects SCF as option</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;BASIS&#39;</span><span class="p">,</span> <span class="n">user_basis</span><span class="p">)</span>

    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s">&#39;WFN&#39;</span><span class="p">,</span> <span class="n">user_wfn</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">b_user_wfn</span><span class="p">:</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">revoke_global_option_changed</span><span class="p">(</span><span class="s">&#39;WFN&#39;</span><span class="p">)</span>

    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&#39;CBS REFERENCE ENERGY&#39;</span><span class="p">,</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;d_energy&#39;</span><span class="p">])</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&#39;CBS CORRELATION ENERGY&#39;</span><span class="p">,</span> <span class="n">finalenergy</span> <span class="o">-</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;d_energy&#39;</span><span class="p">])</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&#39;CBS TOTAL ENERGY&#39;</span><span class="p">,</span> <span class="n">finalenergy</span><span class="p">)</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&#39;CURRENT REFERENCE ENERGY&#39;</span><span class="p">,</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;d_energy&#39;</span><span class="p">])</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&#39;CURRENT CORRELATION ENERGY&#39;</span><span class="p">,</span> <span class="n">finalenergy</span> <span class="o">-</span> <span class="n">GRAND_NEED</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;d_energy&#39;</span><span class="p">])</span>
    <span class="n">PsiMod</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s">&#39;CURRENT ENERGY&#39;</span><span class="p">,</span> <span class="n">finalenergy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">finalenergy</span>


<span class="c"># Transform and validate basis sets from &#39;cc-pV[Q5]Z&#39; into [cc-pVQZ, cc-pV5Z] and [4, 5]</span></div>
<div class="viewcode-block" id="validate_bracketed_basis"><a class="viewcode-back" href="../index.html#wrappers.validate_bracketed_basis">[docs]</a><span class="k">def</span> <span class="nf">validate_bracketed_basis</span><span class="p">(</span><span class="n">basisstring</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to transform and validate basis sets for cbs(). A basis set with no</span>
<span class="sd">    paired square brackets is passed through with zeta level 0 (e.g., &#39;6-31+G(d,p)&#39;</span>
<span class="sd">    is returned as [6-31+G(d,p)] and [0]). A basis set with square brackets is</span>
<span class="sd">    checked for sensible sequence and Dunning-ness and returned as separate basis</span>
<span class="sd">    sets (e.g., &#39;cc-pV[Q5]Z&#39; is returned as [cc-pVQZ, cc-pV5Z] and [4, 5]). Note</span>
<span class="sd">    that this function has no communication with the basis set library to check</span>
<span class="sd">    if the basis actually exists. Used by :py:func:`wrappers.complete_basis_set`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ZETA</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;d&#39;</span><span class="p">,</span> <span class="s">&#39;t&#39;</span><span class="p">,</span> <span class="s">&#39;q&#39;</span><span class="p">,</span> <span class="s">&#39;5&#39;</span><span class="p">,</span> <span class="s">&#39;6&#39;</span><span class="p">]</span>
    <span class="n">BSET</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ZSET</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&#39;.*cc-.*\[.*\].*z$&#39;</span><span class="p">,</span> <span class="n">basisstring</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
        <span class="n">basispattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^(.*)\[(.*)\](.*)$&#39;</span><span class="p">)</span>
        <span class="n">basisname</span> <span class="o">=</span> <span class="n">basispattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">basisstring</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">basisname</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ZETA</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Basis set </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> has invalid zeta level </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">basisstring</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ZSET</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ZSET</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ZSET</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">ZETA</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Basis set </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> has out-of-order zeta level </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">basisstring</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
            <span class="n">BSET</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">basisname</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">basisname</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="s">&#39;d&#39;</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="s">&#39;2&#39;</span>
            <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="s">&#39;t&#39;</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="s">&#39;3&#39;</span>
            <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="s">&#39;q&#39;</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="s">&#39;4&#39;</span>
            <span class="n">ZSET</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&#39;.*\[.*\].*$&#39;</span><span class="p">,</span> <span class="n">basisstring</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Basis set surrounding series indicator [] in </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> is invalid.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">basisstring</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">BSET</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">basisstring</span><span class="p">)</span>
        <span class="n">ZSET</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">BSET</span><span class="p">,</span> <span class="n">ZSET</span><span class="p">]</span>


<span class="c"># Reform string basis set descriptor from basis set strings, &#39;cc-pv[q5]z&#39; from [cc-pvqz, cc-pv5z]</span></div>
<div class="viewcode-block" id="reconstitute_bracketed_basis"><a class="viewcode-back" href="../index.html#wrappers.reconstitute_bracketed_basis">[docs]</a><span class="k">def</span> <span class="nf">reconstitute_bracketed_basis</span><span class="p">(</span><span class="n">needarray</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to reform a bracketed basis set string from a sequential series</span>
<span class="sd">    of basis sets (e.g, form &#39;cc-pv[q5]z&#39; from array [cc-pvqz, cc-pv5z]). The</span>
<span class="sd">    basis set array is extracted from the *f_basis* field of a *NEED* dictionary in</span>
<span class="sd">    :py:func:`wrappers.complete_basis_set`. Result is used to print a nicely</span>
<span class="sd">    formatted basis set string in the results table.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ZETA</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;d&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;t&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&#39;q&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;5&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&#39;6&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">}</span>
    <span class="n">ZSET</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ZETA</span><span class="p">)</span>
    <span class="n">BSET</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">lvl</span> <span class="ow">in</span> <span class="n">needarray</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">BSET</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lvl</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;f_basis&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">BSET</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">basisstring</span> <span class="o">=</span> <span class="n">BSET</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">indx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">BSET</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">BSET</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">indx</span><span class="p">]</span> <span class="o">!=</span> <span class="n">BSET</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">indx</span><span class="p">]):</span>
                <span class="n">zetaindx</span> <span class="o">=</span> <span class="n">indx</span>
            <span class="n">indx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">basis</span> <span class="ow">in</span> <span class="n">BSET</span><span class="p">:</span>
            <span class="n">ZSET</span><span class="p">[</span><span class="n">ZETA</span><span class="p">[</span><span class="n">basis</span><span class="p">[</span><span class="n">zetaindx</span><span class="p">]]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[</span><span class="n">zetaindx</span><span class="p">]</span>

        <span class="n">pre</span> <span class="o">=</span> <span class="n">BSET</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="n">zetaindx</span><span class="p">]</span>
        <span class="n">post</span> <span class="o">=</span> <span class="n">BSET</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">zetaindx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="n">basisstring</span> <span class="o">=</span> <span class="n">pre</span> <span class="o">+</span> <span class="s">&#39;[&#39;</span> <span class="o">+</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ZSET</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;]&#39;</span> <span class="o">+</span> <span class="n">post</span>

    <span class="k">return</span> <span class="n">basisstring</span>

</div>
<div class="viewcode-block" id="highest_1"><a class="viewcode-back" href="../index.html#wrappers.highest_1">[docs]</a><span class="k">def</span> <span class="nf">highest_1</span><span class="p">(</span><span class="o">**</span><span class="n">largs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Scheme for total or correlation energies with a single basis or the highest</span>
<span class="sd">    zeta-level among an array of bases. Used by :py:func:`wrappers.complete_basis_set`.</span>

<span class="sd">    .. math:: E_{total}^X = E_{total}^X</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">energypiece</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">functionname</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
    <span class="n">f_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">,</span> <span class="s">&#39;f_portion&#39;</span><span class="p">,</span> <span class="s">&#39;f_basis&#39;</span><span class="p">,</span> <span class="s">&#39;f_zeta&#39;</span><span class="p">,</span> <span class="s">&#39;f_energy&#39;</span><span class="p">]</span>
    <span class="p">[</span><span class="n">mode</span><span class="p">,</span> <span class="n">NEED</span><span class="p">,</span> <span class="n">wfnname</span><span class="p">,</span> <span class="n">BSET</span><span class="p">,</span> <span class="n">ZSET</span><span class="p">]</span> <span class="o">=</span> <span class="n">validate_scheme_args</span><span class="p">(</span><span class="n">functionname</span><span class="p">,</span> <span class="o">**</span><span class="n">largs</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;requisition&#39;</span><span class="p">):</span>

        <span class="c"># Impose restrictions on zeta sequence</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ZSET</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Call to </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> not valid with </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> basis sets.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">functionname</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ZSET</span><span class="p">)))</span>

        <span class="c"># Return array that logs the requisite jobs</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">wfnname</span> <span class="o">==</span> <span class="s">&#39;scf&#39;</span><span class="p">):</span>
            <span class="n">portion</span> <span class="o">=</span> <span class="s">&#39;tot&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">portion</span> <span class="o">=</span> <span class="s">&#39;corl&#39;</span>
        <span class="n">NEED</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;HI&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">f_fields</span><span class="p">,</span> <span class="p">[</span><span class="n">wfnname</span><span class="p">,</span> <span class="n">portion</span><span class="p">,</span> <span class="n">BSET</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ZSET</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ZSET</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ZSET</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">]))}</span>

        <span class="k">return</span> <span class="n">NEED</span>

    <span class="k">elif</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;evaluate&#39;</span><span class="p">):</span>

        <span class="c"># Extract required energies and zeta integers from array</span>
        <span class="c"># Compute extrapolated energy</span>
        <span class="n">energypiece</span> <span class="o">=</span> <span class="n">NEED</span><span class="p">[</span><span class="s">&#39;HI&#39;</span><span class="p">][</span><span class="s">&#39;f_energy&#39;</span><span class="p">]</span>

        <span class="c"># Output string with extrapolation parameters</span>
        <span class="n">cbsscheme</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">cbsscheme</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">   ==&gt; </span><span class="si">%s</span><span class="s"> &lt;==</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">functionname</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">NEED</span><span class="p">[</span><span class="s">&#39;HI&#39;</span><span class="p">][</span><span class="s">&#39;f_wfn&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;scf&#39;</span><span class="p">):</span>
            <span class="n">cbsscheme</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   HI-zeta (</span><span class="si">%s</span><span class="s">) Total Energy:        </span><span class="si">%16.8f</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">NEED</span><span class="p">[</span><span class="s">&#39;HI&#39;</span><span class="p">][</span><span class="s">&#39;f_zeta&#39;</span><span class="p">]),</span> <span class="n">energypiece</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cbsscheme</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   HI-zeta (</span><span class="si">%s</span><span class="s">) Correlation Energy:  </span><span class="si">%16.8f</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">NEED</span><span class="p">[</span><span class="s">&#39;HI&#39;</span><span class="p">][</span><span class="s">&#39;f_zeta&#39;</span><span class="p">]),</span> <span class="n">energypiece</span><span class="p">)</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">cbsscheme</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">energypiece</span>


<span class="c"># Solution equation in LaTeX:  $E_{corl}^{\infty} = \frac{E_{corl}^{X} X^3 - E_{corl}^{X-1} (X-1)^3}{X^3 - (X-1)^3}$</span>
<span class="c"># Solution equation in LaTeX:  $\beta = \frac{E_{corl}^{X} - E_{corl}^{X-1}}{X^{-3} - (X-1)^{-3}}$</span></div>
<div class="viewcode-block" id="corl_xtpl_helgaker_2"><a class="viewcode-back" href="../index.html#wrappers.corl_xtpl_helgaker_2">[docs]</a><span class="k">def</span> <span class="nf">corl_xtpl_helgaker_2</span><span class="p">(</span><span class="o">**</span><span class="n">largs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extrapolation scheme for correlation energies with two adjacent zeta-level bases.</span>
<span class="sd">    Used by :py:func:`wrappers.complete_basis_set`.</span>

<span class="sd">    .. math:: E_{corl}^X = E_{corl}^{\infty} + \\beta X^{-3}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">energypiece</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">functionname</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
    <span class="n">f_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">,</span> <span class="s">&#39;f_portion&#39;</span><span class="p">,</span> <span class="s">&#39;f_basis&#39;</span><span class="p">,</span> <span class="s">&#39;f_zeta&#39;</span><span class="p">,</span> <span class="s">&#39;f_energy&#39;</span><span class="p">]</span>
    <span class="p">[</span><span class="n">mode</span><span class="p">,</span> <span class="n">NEED</span><span class="p">,</span> <span class="n">wfnname</span><span class="p">,</span> <span class="n">BSET</span><span class="p">,</span> <span class="n">ZSET</span><span class="p">]</span> <span class="o">=</span> <span class="n">validate_scheme_args</span><span class="p">(</span><span class="n">functionname</span><span class="p">,</span> <span class="o">**</span><span class="n">largs</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;requisition&#39;</span><span class="p">):</span>

        <span class="c"># Impose restrictions on zeta sequence</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ZSET</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Call to </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> not valid with </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> basis sets.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">functionname</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ZSET</span><span class="p">)))</span>

        <span class="c"># Return array that logs the requisite jobs</span>
        <span class="n">NEED</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;HI&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">f_fields</span><span class="p">,</span> <span class="p">[</span><span class="n">wfnname</span><span class="p">,</span> <span class="s">&#39;corl&#39;</span><span class="p">,</span> <span class="n">BSET</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ZSET</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">])),</span>
                <span class="s">&#39;LO&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">f_fields</span><span class="p">,</span> <span class="p">[</span><span class="n">wfnname</span><span class="p">,</span> <span class="s">&#39;corl&#39;</span><span class="p">,</span> <span class="n">BSET</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ZSET</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">]))}</span>

        <span class="k">return</span> <span class="n">NEED</span>

    <span class="k">elif</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;evaluate&#39;</span><span class="p">):</span>

        <span class="c"># Extract required energies and zeta integers from array</span>
        <span class="n">eHI</span> <span class="o">=</span> <span class="n">NEED</span><span class="p">[</span><span class="s">&#39;HI&#39;</span><span class="p">][</span><span class="s">&#39;f_energy&#39;</span><span class="p">]</span>
        <span class="n">zHI</span> <span class="o">=</span> <span class="n">NEED</span><span class="p">[</span><span class="s">&#39;HI&#39;</span><span class="p">][</span><span class="s">&#39;f_zeta&#39;</span><span class="p">]</span>
        <span class="n">eLO</span> <span class="o">=</span> <span class="n">NEED</span><span class="p">[</span><span class="s">&#39;LO&#39;</span><span class="p">][</span><span class="s">&#39;f_energy&#39;</span><span class="p">]</span>
        <span class="n">zLO</span> <span class="o">=</span> <span class="n">NEED</span><span class="p">[</span><span class="s">&#39;LO&#39;</span><span class="p">][</span><span class="s">&#39;f_zeta&#39;</span><span class="p">]</span>

        <span class="c"># Compute extrapolated energy</span>
        <span class="n">energypiece</span> <span class="o">=</span> <span class="p">(</span><span class="n">eHI</span> <span class="o">*</span> <span class="n">zHI</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">eLO</span> <span class="o">*</span> <span class="n">zLO</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">zHI</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">zLO</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">eHI</span> <span class="o">-</span> <span class="n">eLO</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">zHI</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">zLO</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">))</span>

        <span class="c"># Output string with extrapolation parameters</span>
        <span class="n">cbsscheme</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">cbsscheme</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">   ==&gt; </span><span class="si">%s</span><span class="s"> &lt;==</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">functionname</span><span class="p">)</span>
        <span class="n">cbsscheme</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   LO-zeta (</span><span class="si">%s</span><span class="s">) Correlation Energy:  </span><span class="si">%16.8f</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">zLO</span><span class="p">),</span> <span class="n">eLO</span><span class="p">)</span>
        <span class="n">cbsscheme</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   HI-zeta (</span><span class="si">%s</span><span class="s">) Correlation Energy:  </span><span class="si">%16.8f</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">zHI</span><span class="p">),</span> <span class="n">eHI</span><span class="p">)</span>
        <span class="n">cbsscheme</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   Extrapolated Correlation Energy: </span><span class="si">%16.8f</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">energypiece</span><span class="p">)</span>
        <span class="n">cbsscheme</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   Beta (coefficient) Value:        </span><span class="si">%16.8f</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">beta</span><span class="p">)</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">cbsscheme</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">energypiece</span>

</div>
<div class="viewcode-block" id="scf_xtpl_helgaker_3"><a class="viewcode-back" href="../index.html#wrappers.scf_xtpl_helgaker_3">[docs]</a><span class="k">def</span> <span class="nf">scf_xtpl_helgaker_3</span><span class="p">(</span><span class="o">**</span><span class="n">largs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extrapolation scheme for reference energies with three adjacent zeta-level bases.</span>
<span class="sd">    Used by :py:func:`wrappers.complete_basis_set`.</span>

<span class="sd">    .. math:: E_{total}^X = E_{total}^{\infty} + \\beta e^{-\\alpha X}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">energypiece</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">functionname</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
    <span class="n">f_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">,</span> <span class="s">&#39;f_portion&#39;</span><span class="p">,</span> <span class="s">&#39;f_basis&#39;</span><span class="p">,</span> <span class="s">&#39;f_zeta&#39;</span><span class="p">,</span> <span class="s">&#39;f_energy&#39;</span><span class="p">]</span>
    <span class="p">[</span><span class="n">mode</span><span class="p">,</span> <span class="n">NEED</span><span class="p">,</span> <span class="n">wfnname</span><span class="p">,</span> <span class="n">BSET</span><span class="p">,</span> <span class="n">ZSET</span><span class="p">]</span> <span class="o">=</span> <span class="n">validate_scheme_args</span><span class="p">(</span><span class="n">functionname</span><span class="p">,</span> <span class="o">**</span><span class="n">largs</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;requisition&#39;</span><span class="p">):</span>

        <span class="c"># Impose restrictions on zeta sequence</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ZSET</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Call to </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> not valid with </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> basis sets.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">functionname</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ZSET</span><span class="p">)))</span>

        <span class="c"># Return array that logs the requisite jobs</span>
        <span class="n">NEED</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;HI&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">f_fields</span><span class="p">,</span> <span class="p">[</span><span class="n">wfnname</span><span class="p">,</span> <span class="s">&#39;tot&#39;</span><span class="p">,</span> <span class="n">BSET</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ZSET</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">])),</span>
                <span class="s">&#39;MD&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">f_fields</span><span class="p">,</span> <span class="p">[</span><span class="n">wfnname</span><span class="p">,</span> <span class="s">&#39;tot&#39;</span><span class="p">,</span> <span class="n">BSET</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ZSET</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">])),</span>
                <span class="s">&#39;LO&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">f_fields</span><span class="p">,</span> <span class="p">[</span><span class="n">wfnname</span><span class="p">,</span> <span class="s">&#39;tot&#39;</span><span class="p">,</span> <span class="n">BSET</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ZSET</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">]))}</span>

        <span class="k">return</span> <span class="n">NEED</span>

    <span class="k">elif</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;evaluate&#39;</span><span class="p">):</span>

        <span class="c"># Extract required energies and zeta integers from array</span>
        <span class="n">eHI</span> <span class="o">=</span> <span class="n">NEED</span><span class="p">[</span><span class="s">&#39;HI&#39;</span><span class="p">][</span><span class="s">&#39;f_energy&#39;</span><span class="p">]</span>
        <span class="n">eMD</span> <span class="o">=</span> <span class="n">NEED</span><span class="p">[</span><span class="s">&#39;MD&#39;</span><span class="p">][</span><span class="s">&#39;f_energy&#39;</span><span class="p">]</span>
        <span class="n">eLO</span> <span class="o">=</span> <span class="n">NEED</span><span class="p">[</span><span class="s">&#39;LO&#39;</span><span class="p">][</span><span class="s">&#39;f_energy&#39;</span><span class="p">]</span>
        <span class="n">zHI</span> <span class="o">=</span> <span class="n">NEED</span><span class="p">[</span><span class="s">&#39;HI&#39;</span><span class="p">][</span><span class="s">&#39;f_zeta&#39;</span><span class="p">]</span>
        <span class="n">zMD</span> <span class="o">=</span> <span class="n">NEED</span><span class="p">[</span><span class="s">&#39;MD&#39;</span><span class="p">][</span><span class="s">&#39;f_zeta&#39;</span><span class="p">]</span>
        <span class="n">zLO</span> <span class="o">=</span> <span class="n">NEED</span><span class="p">[</span><span class="s">&#39;LO&#39;</span><span class="p">][</span><span class="s">&#39;f_zeta&#39;</span><span class="p">]</span>

        <span class="c"># Compute extrapolated energy</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">eHI</span> <span class="o">-</span> <span class="n">eMD</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">eMD</span> <span class="o">-</span> <span class="n">eLO</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">eHI</span> <span class="o">-</span> <span class="n">eMD</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">zMD</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">energypiece</span> <span class="o">=</span> <span class="n">eHI</span> <span class="o">-</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">zHI</span><span class="p">)</span>

        <span class="c"># Output string with extrapolation parameters</span>
        <span class="n">cbsscheme</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">cbsscheme</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">   ==&gt; </span><span class="si">%s</span><span class="s"> &lt;==</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">functionname</span><span class="p">)</span>
        <span class="n">cbsscheme</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   LO-zeta (</span><span class="si">%s</span><span class="s">) Correlation Energy:  </span><span class="si">%16.8f</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">zLO</span><span class="p">),</span> <span class="n">eLO</span><span class="p">)</span>
        <span class="n">cbsscheme</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   MD-zeta (</span><span class="si">%s</span><span class="s">) Correlation Energy:  </span><span class="si">%16.8f</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">zMD</span><span class="p">),</span> <span class="n">eMD</span><span class="p">)</span>
        <span class="n">cbsscheme</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   HI-zeta (</span><span class="si">%s</span><span class="s">) Correlation Energy:  </span><span class="si">%16.8f</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">zHI</span><span class="p">),</span> <span class="n">eHI</span><span class="p">)</span>
        <span class="n">cbsscheme</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   Extrapolated Correlation Energy: </span><span class="si">%16.8f</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">energypiece</span><span class="p">)</span>
        <span class="n">cbsscheme</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   Alpha (exponent) Value:          </span><span class="si">%16.8f</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">cbsscheme</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   Beta (coefficient) Value:        </span><span class="si">%16.8f</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">beta</span><span class="p">)</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">cbsscheme</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">energypiece</span>

</div>
<div class="viewcode-block" id="scf_xtpl_helgaker_2"><a class="viewcode-back" href="../index.html#wrappers.scf_xtpl_helgaker_2">[docs]</a><span class="k">def</span> <span class="nf">scf_xtpl_helgaker_2</span><span class="p">(</span><span class="o">**</span><span class="n">largs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extrapolation scheme for reference energies with two adjacent zeta-level bases.</span>
<span class="sd">    Used by :py:func:`wrappers.complete_basis_set`.</span>

<span class="sd">    .. math:: E_{total}^X = E_{total}^{\infty} + \\beta e^{-\\alpha X}, \\alpha = 1.63</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">energypiece</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">functionname</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
    <span class="n">f_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;f_wfn&#39;</span><span class="p">,</span> <span class="s">&#39;f_portion&#39;</span><span class="p">,</span> <span class="s">&#39;f_basis&#39;</span><span class="p">,</span> <span class="s">&#39;f_zeta&#39;</span><span class="p">,</span> <span class="s">&#39;f_energy&#39;</span><span class="p">]</span>
    <span class="p">[</span><span class="n">mode</span><span class="p">,</span> <span class="n">NEED</span><span class="p">,</span> <span class="n">wfnname</span><span class="p">,</span> <span class="n">BSET</span><span class="p">,</span> <span class="n">ZSET</span><span class="p">]</span> <span class="o">=</span> <span class="n">validate_scheme_args</span><span class="p">(</span><span class="n">functionname</span><span class="p">,</span> <span class="o">**</span><span class="n">largs</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;requisition&#39;</span><span class="p">):</span>

        <span class="c"># Impose restrictions on zeta sequence</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ZSET</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Call to </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> not valid with </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> basis sets.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">functionname</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ZSET</span><span class="p">)))</span>

        <span class="c"># Return array that logs the requisite jobs</span>
        <span class="n">NEED</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;HI&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">f_fields</span><span class="p">,</span> <span class="p">[</span><span class="n">wfnname</span><span class="p">,</span> <span class="s">&#39;tot&#39;</span><span class="p">,</span> <span class="n">BSET</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ZSET</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">])),</span>
                <span class="s">&#39;LO&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">f_fields</span><span class="p">,</span> <span class="p">[</span><span class="n">wfnname</span><span class="p">,</span> <span class="s">&#39;tot&#39;</span><span class="p">,</span> <span class="n">BSET</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ZSET</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">]))}</span>

        <span class="k">return</span> <span class="n">NEED</span>

    <span class="k">elif</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;evaluate&#39;</span><span class="p">):</span>

        <span class="c"># Extract required energies and zeta integers from array</span>
        <span class="n">eHI</span> <span class="o">=</span> <span class="n">NEED</span><span class="p">[</span><span class="s">&#39;HI&#39;</span><span class="p">][</span><span class="s">&#39;f_energy&#39;</span><span class="p">]</span>
        <span class="n">eLO</span> <span class="o">=</span> <span class="n">NEED</span><span class="p">[</span><span class="s">&#39;LO&#39;</span><span class="p">][</span><span class="s">&#39;f_energy&#39;</span><span class="p">]</span>
        <span class="n">zHI</span> <span class="o">=</span> <span class="n">NEED</span><span class="p">[</span><span class="s">&#39;HI&#39;</span><span class="p">][</span><span class="s">&#39;f_zeta&#39;</span><span class="p">]</span>
        <span class="n">zLO</span> <span class="o">=</span> <span class="n">NEED</span><span class="p">[</span><span class="s">&#39;LO&#39;</span><span class="p">][</span><span class="s">&#39;f_zeta&#39;</span><span class="p">]</span>

        <span class="c"># LAB TODO add ability to pass alternate parameter values in</span>

        <span class="c"># Return extrapolated energy</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.63</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">eHI</span> <span class="o">-</span> <span class="n">eLO</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">zLO</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">energypiece</span> <span class="o">=</span> <span class="n">eHI</span> <span class="o">-</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">zHI</span><span class="p">)</span>

        <span class="c"># Output string with extrapolation parameters</span>
        <span class="n">cbsscheme</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">cbsscheme</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">   ==&gt; </span><span class="si">%s</span><span class="s"> &lt;==</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">functionname</span><span class="p">)</span>
        <span class="n">cbsscheme</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   LO-zeta (</span><span class="si">%s</span><span class="s">) Correlation Energy:  </span><span class="si">%16.8f</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">zLO</span><span class="p">),</span> <span class="n">eLO</span><span class="p">)</span>
        <span class="n">cbsscheme</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   HI-zeta (</span><span class="si">%s</span><span class="s">) Correlation Energy:  </span><span class="si">%16.8f</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">zHI</span><span class="p">),</span> <span class="n">eHI</span><span class="p">)</span>
        <span class="n">cbsscheme</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   Extrapolated Correlation Energy: </span><span class="si">%16.8f</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">energypiece</span><span class="p">)</span>
        <span class="n">cbsscheme</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   Alpha (exponent) Value:          </span><span class="si">%16.8f</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">cbsscheme</span> <span class="o">+=</span> <span class="s">&quot;&quot;&quot;   Beta (coefficient) Value:        </span><span class="si">%16.8f</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">beta</span><span class="p">)</span>
        <span class="n">PsiMod</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">cbsscheme</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">energypiece</span>

</div>
<div class="viewcode-block" id="validate_scheme_args"><a class="viewcode-back" href="../index.html#wrappers.validate_scheme_args">[docs]</a><span class="k">def</span> <span class="nf">validate_scheme_args</span><span class="p">(</span><span class="n">functionname</span><span class="p">,</span> <span class="o">**</span><span class="n">largs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function called by each extrapolation scheme in :py:func:`wrappers.complete_basis_set`.</span>
<span class="sd">    Checks that all the input arguments are present and suitable so that</span>
<span class="sd">    the scheme function can focus on defining the extrapolation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">NEED</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">wfnname</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">BSET</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ZSET</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c"># Mode where function fills out a form NEED with the computations needed to fulfill its call</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">largs</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;requisition&#39;</span><span class="p">):</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">largs</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">if</span> <span class="s">&#39;wfnname&#39;</span> <span class="ow">in</span> <span class="n">largs</span><span class="p">:</span>
            <span class="n">wfnname</span> <span class="o">=</span> <span class="n">largs</span><span class="p">[</span><span class="s">&#39;wfnname&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Call to </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> has keyword </span><span class="se">\&#39;</span><span class="s">wfnname</span><span class="se">\&#39;</span><span class="s"> missing.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">functionname</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&#39;scf_.*$&#39;</span><span class="p">,</span> <span class="n">functionname</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">wfnname</span> <span class="o">!=</span> <span class="s">&#39;scf&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Call to </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> is intended for scf portion of calculation.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">functionname</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&#39;corl_.*$&#39;</span><span class="p">,</span> <span class="n">functionname</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">wfnname</span> <span class="o">==</span> <span class="s">&#39;scf&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Call to </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> is not intended for scf portion of calculation.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">functionname</span><span class="p">))</span>

        <span class="k">if</span> <span class="s">&#39;basisname&#39;</span> <span class="ow">in</span> <span class="n">largs</span><span class="p">:</span>
            <span class="n">BSET</span> <span class="o">=</span> <span class="n">largs</span><span class="p">[</span><span class="s">&#39;basisname&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Call to </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> has keyword </span><span class="se">\&#39;</span><span class="s">basisname</span><span class="se">\&#39;</span><span class="s"> missing.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">functionname</span><span class="p">))</span>

        <span class="k">if</span> <span class="s">&#39;basiszeta&#39;</span> <span class="ow">in</span> <span class="n">largs</span><span class="p">:</span>
            <span class="n">ZSET</span> <span class="o">=</span> <span class="n">largs</span><span class="p">[</span><span class="s">&#39;basiszeta&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Call to </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> has keyword </span><span class="se">\&#39;</span><span class="s">basiszeta</span><span class="se">\&#39;</span><span class="s"> missing.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">functionname</span><span class="p">))</span>

    <span class="c"># Mode where function reads the now-filled-in energies from that same form and performs the sp, xtpl, delta, etc.</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">largs</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;evaluate&#39;</span><span class="p">):</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">largs</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">if</span> <span class="s">&#39;needname&#39;</span> <span class="ow">in</span> <span class="n">largs</span><span class="p">:</span>
            <span class="n">NEED</span> <span class="o">=</span> <span class="n">largs</span><span class="p">[</span><span class="s">&#39;needname&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Call to </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> has keyword </span><span class="se">\&#39;</span><span class="s">needname</span><span class="se">\&#39;</span><span class="s"> missing.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">functionname</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&#39;Call to </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> has keyword </span><span class="se">\&#39;</span><span class="s">mode</span><span class="se">\&#39;</span><span class="s"> missing or invalid.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">functionname</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">mode</span><span class="p">,</span> <span class="n">NEED</span><span class="p">,</span> <span class="n">wfnname</span><span class="p">,</span> <span class="n">BSET</span><span class="p">,</span> <span class="n">ZSET</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="split_menial"><a class="viewcode-back" href="../index.html#wrappers.split_menial">[docs]</a><span class="k">def</span> <span class="nf">split_menial</span><span class="p">(</span><span class="n">menial</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function used by :py:func:`wrappers.complete_basis_set` to separate</span>
<span class="sd">    *menial* &#39;scftot&#39; into [scf, tot] and &#39;mp2corl&#39; into [mp2, corl].</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">PTYP</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;tot&#39;</span><span class="p">,</span> <span class="s">&#39;corl&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">temp</span> <span class="ow">in</span> <span class="n">PTYP</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">menial</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">temp</span><span class="p">):</span>
            <span class="n">temp_wfn</span> <span class="o">=</span> <span class="n">menial</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)]</span>
            <span class="n">temp_portion</span> <span class="o">=</span> <span class="n">temp</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">temp_wfn</span><span class="p">,</span> <span class="n">temp_portion</span><span class="p">]</span>


<span class="c">##  Aliases  ##</span></div>
<span class="n">cbs</span> <span class="o">=</span> <span class="n">complete_basis_set</span>

<span class="c">#################################</span>
<span class="c">##  End of Complete Basis Set  ##</span>
<span class="c">#################################</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
    <li><a href="../index.html">Psithon for PSI4 Documentation</a> &raquo; </li>

          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    </div>

    <div class="footer">
        &copy; Copyright 2012, Psi4 Project.
      Last updated on Feb 27, 2012.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>